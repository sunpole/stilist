<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (4 –∏–≥—Ä–æ–∫–∞)</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    #menu, #lobby, #game { max-width: 500px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; }
    button { padding: 10px 15px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 5px; }
    input { padding: 8px; width: 200px; }
    #players { margin: 20px 0; }
    .player { padding: 10px; background: #f0f0f0; margin: 5px; border-radius: 5px; }
    #status { font-weight: bold; color: #2196F3; }
  </style>
</head>
<body>
  <!-- –ú–µ–Ω—é -->
  <div id="menu">
    <h1>üéÆ P2P –ò–≥—Ä–∞ (4 –∏–≥—Ä–æ–∫–∞)</h1>
    <button id="createBtn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
    <p>–∏–ª–∏</p>
    <input id="hostIdInput" placeholder="ID —Ö–æ—Å—Ç–∞">
    <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  </div>

  <!-- –õ–æ–±–±–∏ -->
  <div id="lobby" style="display: none;">
    <h2>–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</h2>
    <p>ID –∫–æ–º–Ω–∞—Ç—ã: <span id="roomId"></span></p>
    <div id="players"></div>
    <p id="status">–°—Ç–∞—Ç—É—Å: <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span></p>
  </div>

  <!-- –ò–≥—Ä–∞ -->
  <div id="game" style="display: none;">
    <h2>–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!</h2>
    <p id="gameStatus">–•–æ–¥: <span id="currentPlayer"></span></p>
  </div>

  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞
    const peer = new Peer();
    const players = {};
    let isHost = false;
    let gameConnections = [];
    let currentPlayerId = null;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const menu = document.getElementById('menu');
    const lobby = document.getElementById('lobby');
    const gameDiv = document.getElementById('game');
    const roomIdSpan = document.getElementById('roomId');
    const playersDiv = document.getElementById('players');
    const statusText = document.getElementById('statusText');
    const currentPlayerSpan = document.getElementById('currentPlayer');

    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã (–•–æ—Å—Ç)
    document.getElementById('createBtn').addEventListener('click', () => {
      isHost = true;
      menu.style.display = 'none';
      lobby.style.display = 'block';
      roomIdSpan.textContent = peer.id;
      
      // –•–æ—Å—Ç ‚Äî –ø–µ—Ä–≤—ã–π –∏–≥—Ä–æ–∫
      players[peer.id] = { id: peer.id, name: '–ò–≥—Ä–æ–∫ 1' };
      updatePlayersList();
      statusText.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...';

      // –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
      peer.on('connection', (conn) => {
        if (Object.keys(players).length >= 4) {
          conn.send({ type: 'error', message: '–õ–æ–±–±–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ' });
          return;
        }

        gameConnections.push(conn);
        conn.on('data', (data) => handleData(conn, data));
        
        conn.on('open', () => {
          const playerId = conn.peer;
          players[playerId] = { id: playerId, name: `–ò–≥—Ä–æ–∫ ${Object.keys(players).length + 1}` };
          broadcast({ type: 'players', players });
          statusText.textContent = `–ò–≥—Ä–æ–∫–æ–≤: ${Object.keys(players).length}/4`;
          
          // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –ø—Ä–∏ 2+ –∏–≥—Ä–æ–∫–∞—Ö
          if (isHost && Object.keys(players).length >= 2) {
            startGame();
          }
        });
      });
    });

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ (–ö–ª–∏–µ–Ω—Ç)
    document.getElementById('connectBtn').addEventListener('click', () => {
      const hostId = document.getElementById('hostIdInput').value.trim();
      if (!hostId) return;

      const conn = peer.connect(hostId);
      menu.style.display = 'none';
      lobby.style.display = 'block';
      roomIdSpan.textContent = hostId;
      statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';

      conn.on('data', (data) => handleData(conn, data));
      
      conn.on('open', () => {
        gameConnections.push(conn);
        statusText.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã...';
      });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    function handleData(conn, data) {
      switch (data.type) {
        case 'players':
          Object.assign(players, data.players);
          updatePlayersList();
          statusText.textContent = `–ò–≥—Ä–æ–∫–æ–≤: ${Object.keys(players).length}/4`;
          break;
          
        case 'game_start':
          lobby.style.display = 'none';
          gameDiv.style.display = 'block';
          currentPlayerId = data.currentPlayerId;
          currentPlayerSpan.textContent = players[currentPlayerId]?.name || '?';
          break;
          
        case 'error':
          alert(data.message);
          break;
      }
    }

    // –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function broadcast(message) {
      gameConnections.forEach(conn => conn.send(message));
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
    function updatePlayersList() {
      playersDiv.innerHTML = Object.values(players).map(player => `
        <div class="player">${player.name}</div>
      `).join('');
    }

    // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
    function startGame() {
      lobby.style.display = 'none';
      gameDiv.style.display = 'block';
      currentPlayerId = Object.keys(players)[0];
      currentPlayerSpan.textContent = players[currentPlayerId].name;
      
      broadcast({ 
        type: 'game_start',
        currentPlayerId 
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Peer
    peer.on('open', (id) => {
      console.log('–í–∞—à ID:', id);
    });
  </script>
</body>
</html>
