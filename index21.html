<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Геймбой Эмулятор</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #222;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
        }

        .gameboy {
            position: relative;
            width: 320px;
            height: 570px;
            background-color: #d6d6d6;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            border: 8px solid #b5b5b5;
        }

        .screen {
            width: 100%;
            height: 180px;
            background-color: #8bac0f;
            border: 10px solid #5a6e0b;
            border-radius: 5px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .info-panel {
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            padding: 2px 5px;
            background-color: rgba(0, 0, 0, 0.2);
        }

        .menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
        }

        .menu button {
            margin: 5px;
            padding: 8px 15px;
            background-color: #4CAF50;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 80%;
        }

        .menu button:hover {
            background-color: #45a049;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .d-pad {
            width: 100px;
            height: 100px;
            position: relative;
            margin-bottom: 20px;
        }

        .d-pad-button {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #333;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            transition: all 0.1s;
        }

        .d-pad-button.active {
            background-color: #555;
            transform: scale(0.9);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .up {
            top: 0;
            left: 35px;
        }

        .down {
            bottom: 0;
            left: 35px;
        }

        .left {
            top: 35px;
            left: 0;
        }

        .right {
            top: 35px;
            right: 0;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 10px;
        }

        .action-button {
            width: 45px;
            height: 45px;
            background-color: #c00;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            transition: all 0.1s;
        }

        .action-button.active {
            background-color: #f00;
            transform: scale(0.9);
        }

        .start-select {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .start-select button {
            margin: 0 10px;
            padding: 5px 15px;
            background-color: #555;
            border: none;
            color: white;
            border-radius: 3px;
            transition: all 0.1s;
        }

        .start-select button.active {
            background-color: #777;
            transform: scale(0.95);
        }

        .game-content {
            text-align: center;
            padding: 10px;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        .hidden {
            display: none !important;
        }

        .cursor {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            pointer-events: none;
        }

        @media (max-width: 350px) {
            .gameboy {
                transform: scale(0.9);
            }
        }

        @media (max-height: 600px) {
            .gameboy {
                transform: scale(0.8);
            }
        }

        @media (orientation: landscape) {
            .gameboy {
                transform: rotate(90deg) scale(0.7);
            }
        }
    </style>
</head>
<body>
    <div class="gameboy">
        <div class="screen">
            <div class="info-panel">
                <span id="game-title">Геймбой</span>
                <span id="sound-status">Звук: ВКЛ</span>
            </div>
            <div class="game-container" id="game-container">
                <div class="menu" id="main-menu">
                    <h2>Геймбой Эмулятор</h2>
                    <p style="margin: 10px 0;">Используйте кнопки для навигации:</p>
                    <ul style="text-align: left; margin: 10px 0;">
                        <li>D-Pad - перемещение</li>
                        <li>A - выбор</li>
                        <li>B - назад</li>
                        <li>START - главное меню</li>
                    </ul>
                    <button id="new-game-btn">Играть в "Камень-Ножницы-Бумага"</button>
                    <button id="load-game-btn">Загрузить игру</button>
                    <button id="sound-toggle-btn">Звук ВКЛ/ВЫКЛ</button>
                    <button id="help-btn">Инструкция</button>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="d-pad">
                <div class="d-pad-button up" id="up-btn">↑</div>
                <div class="d-pad-button down" id="down-btn">↓</div>
                <div class="d-pad-button left" id="left-btn">←</div>
                <div class="d-pad-button right" id="right-btn">→</div>
            </div>
            
            <div class="action-buttons">
                <div class="action-button" id="a-btn">A</div>
                <div class="action-button" id="b-btn">B</div>
            </div>
            
            <div class="start-select">
                <button id="start-btn">START</button>
                <button id="select-btn">SELECT</button>
            </div>
        </div>
    </div>

    <script>
        // Состояние эмулятора
        const state = {
            soundEnabled: true,
            currentGame: null,
            games: {
                'rps': {
                    title: 'Камень-Ножницы-Бумага',
                    init: initRockPaperScissors,
                    handleInput: handleRockPaperScissorsInput
                }
            }
        };

        // DOM элементы
        const elements = {
            gameContainer: document.getElementById('game-container'),
            mainMenu: document.getElementById('main-menu'),
            gameTitle: document.getElementById('game-title'),
            soundStatus: document.getElementById('sound-status'),
            newGameBtn: document.getElementById('new-game-btn'),
            loadGameBtn: document.getElementById('load-game-btn'),
            soundToggleBtn: document.getElementById('sound-toggle-btn'),
            helpBtn: document.getElementById('help-btn'),
            upBtn: document.getElementById('up-btn'),
            downBtn: document.getElementById('down-btn'),
            leftBtn: document.getElementById('left-btn'),
            rightBtn: document.getElementById('right-btn'),
            aBtn: document.getElementById('a-btn'),
            bBtn: document.getElementById('b-btn'),
            startBtn: document.getElementById('start-btn'),
            selectBtn: document.getElementById('select-btn')
        };

        // Инициализация
        function init() {
            // Назначение обработчиков событий
            elements.newGameBtn.addEventListener('click', () => startGame('rps'));
            elements.loadGameBtn.addEventListener('click', loadGame);
            elements.soundToggleBtn.addEventListener('click', toggleSound);
            elements.helpBtn.addEventListener('click', showHelp);
            
            // Обработчики кнопок (для визуальной обратной связи)
            setupButtonFeedback(elements.upBtn, 'up');
            setupButtonFeedback(elements.downBtn, 'down');
            setupButtonFeedback(elements.leftBtn, 'left');
            setupButtonFeedback(elements.rightBtn, 'right');
            setupButtonFeedback(elements.aBtn, 'a');
            setupButtonFeedback(elements.bBtn, 'b');
            setupButtonFeedback(elements.startBtn, 'start');
            setupButtonFeedback(elements.selectBtn, 'select');
            
            // Обработчики клавиатуры
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'ArrowUp': handleButtonPress('up'); break;
                    case 'ArrowDown': handleButtonPress('down'); break;
                    case 'ArrowLeft': handleButtonPress('left'); break;
                    case 'ArrowRight': handleButtonPress('right'); break;
                    case 'a': case 'A': handleButtonPress('a'); break;
                    case 'b': case 'B': handleButtonPress('b'); break;
                    case 'Enter': handleButtonPress('start'); break;
                    case ' ': handleButtonPress('select'); break;
                }
            });
            
            updateUI();
        }

        // Настройка визуальной обратной связи для кнопок
        function setupButtonFeedback(button, buttonName) {
            button.addEventListener('mousedown', () => {
                button.classList.add('active');
                handleButtonPress(buttonName);
            });
            
            button.addEventListener('mouseup', () => {
                button.classList.remove('active');
            });
            
            button.addEventListener('mouseleave', () => {
                button.classList.remove('active');
            });
            
            // Для сенсорных устройств
            button.addEventListener('touchstart', (e) => {
                e.preventDefault();
                button.classList.add('active');
                handleButtonPress(buttonName);
            });
            
            button.addEventListener('touchend', () => {
                button.classList.remove('active');
            });
        }

        // Обновление интерфейса
        function updateUI() {
            elements.soundStatus.textContent = `Звук: ${state.soundEnabled ? 'ВКЛ' : 'ВЫКЛ'}`;
        }

        // Переключение звука
        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            updateUI();
            playSound('click');
        }

        // Воспроизведение звука
        function playSound(type) {
            if (!state.soundEnabled) return;
            console.log(`Play ${type} sound`);
        }

        // Обработка нажатия кнопки
        function handleButtonPress(button) {
            playSound('click');
            
            if (state.currentGame) {
                // Передаем нажатие в текущую игру
                state.currentGame.handleInput(button);
            } else {
                // Обработка в меню
                switch(button) {
                    case 'a':
                        if (document.activeElement) {
                            document.activeElement.click();
                        }
                        break;
                    case 'b':
                        backToMainMenu();
                        break;
                    case 'start':
                        backToMainMenu();
                        break;
                    case 'up':
                    case 'down':
                        navigateMenu(button);
                        break;
                }
            }
        }

        // Навигация по меню
        function navigateMenu(direction) {
            const buttons = elements.mainMenu.querySelectorAll('button');
            let currentIndex = -1;
            
            buttons.forEach((button, index) => {
                if (button === document.activeElement) {
                    currentIndex = index;
                }
            });
            
            if (direction === 'up') {
                currentIndex = (currentIndex - 1 + buttons.length) % buttons.length;
            } else if (direction === 'down') {
                currentIndex = (currentIndex + 1) % buttons.length;
            }
            
            buttons[currentIndex].focus();
        }

        // Показать справку
        function showHelp() {
            const helpHTML = `
                <div class="menu">
                    <h2>Инструкция</h2>
                    <div class="game-content">
                        <h3>Управление:</h3>
                        <p><strong>D-Pad (↑ ↓ ← →)</strong> - перемещение/навигация</p>
                        <p><strong>Кнопка A</strong> - основное действие/выбор</p>
                        <p><strong>Кнопка B</strong> - второстепенное действие/назад</p>
                        <p><strong>START</strong> - главное меню</p>
                        <p><strong>SELECT</strong> - специальная функция (зависит от игры)</p>
                        
                        <h3 style="margin-top: 20px;">Как играть:</h3>
                        <p>1. Выберите игру из меню</p>
                        <p>2. Используйте кнопки для управления</p>
                        <p>3. Нажмите START для возврата в меню</p>
                        
                        <button onclick="backToMainMenu()" style="margin-top: 20px;">Назад</button>
                    </div>
                </div>
            `;
            
            elements.gameContainer.innerHTML = helpHTML;
        }

        // Начать игру
        function startGame(gameId) {
            if (state.games[gameId]) {
                state.currentGame = {
                    id: gameId,
                    title: state.games[gameId].title,
                    handleInput: state.games[gameId].handleInput
                };
                
                elements.gameTitle.textContent = state.currentGame.title;
                elements.gameContainer.innerHTML = '';
                
                // Инициализация игры
                state.games[gameId].init();
                
                playSound('start');
            }
        }

        // Вернуться в главное меню
        function backToMainMenu() {
            state.currentGame = null;
            elements.gameTitle.textContent = 'Геймбой';
            elements.gameContainer.innerHTML = '';
            elements.mainMenu.classList.remove('hidden');
        }

        // Загрузить игру
        function loadGame() {
            const menuHTML = `
                <div class="menu">
                    <h2>Загрузить игру</h2>
                    <div class="game-content">
                        <p>Выберите способ загрузки:</p>
                        <button onclick="loadGameFromFile()">Из файла</button>
                        <button onclick="loadGameFromUrl()">По URL</button>
                        <button onclick="loadGameFromCatalog()">Из каталога</button>
                        <button onclick="backToMainMenu()" style="margin-top: 20px;">Назад</button>
                    </div>
                </div>
            `;
            
            elements.gameContainer.innerHTML = menuHTML;
        }

        // Загрузить игру из файла
        function loadGameFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.txt';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const gameData = JSON.parse(event.target.result);
                        registerNewGame(gameData);
                        alert(`Игра "${gameData.title}" успешно загружена!`);
                        backToMainMenu();
                    } catch (error) {
                        alert('Ошибка загрузки игры: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Загрузить игру по URL
        function loadGameFromUrl() {
            const url = prompt('Введите URL JSON файла с игрой:');
            if (!url) return;
            
            fetch(url)
                .then(response => response.json())
                .then(gameData => {
                    registerNewGame(gameData);
                    alert(`Игра "${gameData.title}" успешно загружена!`);
                    backToMainMenu();
                })
                .catch(error => {
                    alert('Ошибка загрузки игры: ' + error.message);
                });
        }

        // Загрузить игру из каталога
        function loadGameFromCatalog() {
            // Проверяем наличие стандартных игр в каталоге
            const gameFiles = [
                'tictactoe.json',
                'rockpaperscissors.json',
                'snake.json'
            ];
            
            let loaded = false;
            
            gameFiles.forEach(file => {
                fetch(file)
                    .then(response => {
                        if (response.ok) {
                            return response.json().then(gameData => {
                                if (!loaded) {
                                    registerNewGame(gameData);
                                    alert(`Игра "${gameData.title}" загружена из каталога!`);
                                    backToMainMenu();
                                    loaded = true;
                                }
                            });
                        }
                    })
                    .catch(() => {});
            });
            
            if (!loaded) {
                alert('Не найдено игр в каталоге. Положите JSON файл с игрой в ту же папку, что и эмулятор.');
            }
        }

        // Зарегистрировать новую игру
        function registerNewGame(gameData) {
            if (!gameData.id || !gameData.title || !gameData.init || !gameData.handleInput) {
                throw new Error('Неверный формат игры. Должны быть указаны id, title, init и handleInput');
            }
            
            try {
                gameData.init = new Function(gameData.init);
                gameData.handleInput = new Function('button', gameData.handleInput);
                
                state.games[gameData.id] = gameData;
            } catch (e) {
                throw new Error('Ошибка в коде игры: ' + e.message);
            }
        }

        // Простая игра "Камень-Ножницы-Бумага"
        function initRockPaperScissors() {
            const choices = ['камень', 'ножницы', 'бумага'];
            let playerChoice = null;
            let computerChoice = null;
            let result = '';
            
            function render() {
                const html = `
                    <div class="game-content">
                        <h2>Камень-Ножницы-Бумага</h2>
                        
                        <div style="margin: 20px 0;">
                            <p>Выберите вариант:</p>
                            <div style="display: flex; justify-content: center; gap: 10px; margin: 10px 0;">
                                <button onclick="makeChoice('камень')" ${playerChoice ? 'disabled' : ''}>Камень</button>
                                <button onclick="makeChoice('ножницы')" ${playerChoice ? 'disabled' : ''}>Ножницы</button>
                                <button onclick="makeChoice('бумага')" ${playerChoice ? 'disabled' : ''}>Бумага</button>
                            </div>
                        </div>
                        
                        ${playerChoice ? `
                            <div style="margin: 20px 0;">
                                <p>Вы: ${playerChoice}</p>
                                <p>Компьютер: ${computerChoice}</p>
                                <h3 style="margin: 10px 0;">${result}</h3>
                            </div>
                            
                            <button onclick="resetGame()">Играть снова</button>
                        ` : ''}
                        
                        <button onclick="backToMainMenu()" style="margin-top: 20px;">В меню</button>
                    </div>
                `;
                
                elements.gameContainer.innerHTML = html;
            }
            
            window.makeChoice = function(choice) {
                playerChoice = choice;
                computerChoice = choices[Math.floor(Math.random() * choices.length)];
                
                if (playerChoice === computerChoice) {
                    result = 'Ничья!';
                } else if (
                    (playerChoice === 'камень' && computerChoice === 'ножницы') ||
                    (playerChoice === 'ножницы' && computerChoice === 'бумага') ||
                    (playerChoice === 'бумага' && computerChoice === 'камень')
                ) {
                    result = 'Вы победили!';
                } else {
                    result = 'Вы проиграли!';
                }
                
                render();
                playSound(playerChoice === computerChoice ? 'draw' : result.includes('победили') ? 'win' : 'lose');
            };
            
            window.resetGame = function() {
                playerChoice = null;
                computerChoice = null;
                result = '';
                render();
            };
            
            render();
        }

        function handleRockPaperScissorsInput(button) {
            const buttons = document.querySelectorAll('.game-content button');
            let currentIndex = -1;
            
            buttons.forEach((button, index) => {
                if (button === document.activeElement) {
                    currentIndex = index;
                }
            });
            
            switch(button) {
                case 'up':
                    currentIndex = (currentIndex - 1 + buttons.length) % buttons.length;
                    break;
                case 'down':
                    currentIndex = (currentIndex + 1) % buttons.length;
                    break;
                case 'a':
                    if (document.activeElement) {
                        document.activeElement.click();
                    }
                    break;
                case 'b':
                case 'start':
                    backToMainMenu();
                    break;
            }
            
            if (currentIndex >= 0) {
                buttons[currentIndex].focus();
            }
        }

        // Запуск эмулятора
        window.onload = init;
    </script>
</body>
</html>
