<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>TD ‚Äî –ö–∞—Å—Ç–æ–º–Ω—ã–µ –±–∞—à–Ω–∏ –∏–∑ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ (Pro) ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</title>
<style>
    :root{
        --bg:#0f1220;--panel:#171b2e;--panel2:#1e2440;--text:#e7ecff;--muted:#9aa4d6;--accent:#6ee7ff;--ok:#57d88a;--warn:#ffb86b;--bad:#ff6b6b;
        --slot-ok:#2a334f;--slot-max:#40518d;--btn:#2b7cff;--btn2:#2e9d6c;--btn3:#f0b429;--btn-dis:#3a4161;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
        margin:0;background:linear-gradient(180deg,#0b0f1d,#121632);
        color:var(--text);font:500 14px/1.4 system-ui,Segoe UI,Roboto,Arial;
        touch-action:manipulation;
    }
    #wrap{max-width:1000px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}
    header{padding:10px 12px;background:#121737;box-shadow:0 2px 0 rgba(0,0,0,.35);position:sticky;top:0;z-index:50}
    header h1{font-size:18px;margin:0}
    #hud{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:8px}
    .chip{background:var(--panel);padding:8px 10px;border-radius:10px;display:flex;align-items:center;justify-content:center}
    .chip b{font-size:16px;margin-left:6px}
    #board-wrap{padding:10px}
    #board{position:relative;height:420px;border-radius:16px;overflow:hidden;background:#0b1b21;box-shadow:inset 0 0 0 2px #0c2c39}
    #path{position:absolute;inset:0;pointer-events:none}
    /* overlay –¥–ª—è —Ä–∞–¥–∏—É—Å–∞ */
    #overlay{position:absolute;inset:0;pointer-events:none;z-index:30}
    .slot{
        position:absolute;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
        color:#fff;font-weight:800;font-size:12px;transform:translate(-50%,-50%);cursor:pointer;user-select:none;
        border:2px solid #88a;box-shadow:0 0 0 2px rgba(0,0,0,.2) inset;
        z-index:10;
    }
    .slot .slot-label{font-size:11px;pointer-events:none; display:flex; gap:6px; align-items:center}
    .slot.l15{background:linear-gradient(180deg,#284,#173)} .slot.l10{background:linear-gradient(180deg,#484,#262)} .slot.l6{background:linear-gradient(180deg,#448,#226)}
    .slot.max{outline:2px dashed #ffd166}
    /* –±–∞—à–Ω—è –≤—ã—à–µ –ø–æ z-index –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞ */
    .tower{position:absolute;width:40px;height:40px;border-radius:50%;transform:translate(-50%,-50%);background:#2b7cff;border:3px solid #0f4fd6;
        z-index:20; cursor:pointer; display:flex; align-items:center; justify-content:center; pointer-events:auto;}
    .tower .lvl-badge{position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:2px 6px;border-radius:10px;font-size:12px}
    .tower::after{content:'';position:absolute;inset:-4px;border-radius:50%;box-shadow:0 0 0 2px rgba(110,231,255,.12)}
    .enemy{position:absolute;width:20px;height:20px;border-radius:50%;transform:translate(-50%,-50%);background:#ff6b6b;box-shadow:0 0 10px rgba(255,107,107,.6)}
    .hp{position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:22px;height:3px;background:rgba(0,0,0,.4);border-radius:2px}
    .hp>i{display:block;height:100%;background:#57d88a;border-radius:2px}
    .proj{position:absolute;width:8px;height:8px;border-radius:50%;transform:translate(-50%,-50%);background:#ffeb3b;box-shadow:0 0 8px rgba(255,235,59,.8);z-index:25;pointer-events:none}
    #ui{display:grid;grid-template-columns:1fr;gap:10px;padding:10px;z-index:40}
    .panel{background:var(--panel2);border-radius:16px;padding:10px}
    .panel h3{margin:0 0 8px 0;font-size:14px;color:#b7c3ff}
    #inv{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:8px}
    .comp{background:var(--panel);border:1px solid #2d3760;border-radius:12px;padding:6px;display:flex;flex-direction:column;gap:4px;cursor:pointer}
    .comp.sel{outline:2px solid var(--accent)}
    .badge{font-size:11px;color:#9aa4d6;background:#0f1c3a;padding:1px 6px;border-radius:999px;margin-left:6px}
    .lvl1{background:#1f3b2f} .lvl2{background:#214a3b} .lvl3{background:#245447} .lvl4{background:#276055}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    button{background:var(--btn);border:0;color:#fff;padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer}
    .b2{background:var(--btn2)} .b3{background:var(--btn3)} .bd{background:var(--btn-dis)!important;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .note{color:var(--muted);font-size:12px}
    #toast{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#0e1430;color:#fff;padding:10px 14px;border-radius:12px;display:none;z-index:60}
    #modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:70}
    #modal>.card{background:#0f1536;border-radius:16px;padding:14px;max-width:92vw;width:520px}
    .small{font-size:12px;color:#9fb3ff}
    .stat{display:grid;grid-template-columns:1fr auto;gap:4px}
    .pill{padding:2px 6px;border-radius:999px;background:#0e1a3b;color:#bcd}
    .costline{margin-top:8px;display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
    .cost{background:#0c1a35;border:1px solid #293a6a;padding:4px 8px;border-radius:8px}
    select, .sel{background:#0d1a3b;border:1px solid #2a3a6a;color:#cfe;padding:6px 8px;border-radius:10px}
    .upgrade-row{display:flex;gap:8px;align-items:center;margin:6px 0}
    .upgrade-row button{padding:6px 8px;border-radius:8px;font-size:13px}
    @media (min-width:860px){
        #ui{grid-template-columns:1.2fr .8fr}
    }
</style>
</head>
<body>
<div id="wrap">
    <header>
        <h1>–ë–∞—à–µ–Ω–Ω–∞—è –æ–±–æ—Ä–æ–Ω–∞ ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–∞—à–µ–Ω –∏–∑ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</h1>
        <div id="hud">
            <div class="chip">üí∞ –î–µ–Ω—å–≥–∏: <b id="money">0</b></div>
            <div class="chip">‚ù§Ô∏è –ñ–∏–∑–Ω–∏: <b id="lives">20</b></div>
            <div class="chip">üåä –í–æ–ª–Ω–∞: <b id="wave">0</b></div>
            <div class="chip">üëæ –í—Ä–∞–≥–æ–≤: <b><span id="left">0</span>/<span id="total">0</span></b></div>
        </div>
    </header>

    <div id="board-wrap">
        <div id="board">
            <!-- –ü—É—Ç—å -->
            <svg id="path" viewBox="0 0 920 420" preserveAspectRatio="none">
                <defs>
                    <filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                </defs>
                <!-- track –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –û–î–ò–ù –¥–ª—è –ª–æ–≥–∏–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∞ -->
                <path id="track" d="M20,360
                    C180,360 180,60 320,60
                    S460,360 600,360
                    S740,60 900,60" fill="none" stroke="#2a845f" stroke-width="26" opacity=".25" />
                <path id="trackLine" d="M20,360
                    C180,360 180,60 320,60
                    S460,360 600,360
                    S740,60 900,60" fill="none" stroke="#42e39f" stroke-width="6" filter="url(#glow)" />
            </svg>
            <!-- Overlay —Ä–∞–¥–∏—É—Å–∞ -->
            <svg id="overlay" viewBox="0 0 920 420" preserveAspectRatio="none">
                <circle id="range" cx="-1000" cy="-1000" r="10" fill="rgba(110,231,255,0.08)" stroke="rgba(110,231,255,0.6)" stroke-width="2" />
            </svg>
            <!-- –°–ª–æ—Ç—ã (—Å—Ç–∞–≤—è—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º) -->
        </div>
    </div>

    <div id="ui">
        <div class="panel">
            <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</h3>
            <div id="inv"></div>
            <div class="row" style="margin-top:8px">
                <button id="combine" class="b3">–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å: 3√óL1‚ÜíL2, 3√óL2‚ÜíL3</button>
                <button id="newComp" class="b2">–ö—É–ø–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π (—à–∞–Ω—Å L1..L4) (üí∞ 25)</button>
                <button id="sellInv">–ü—Ä–æ–¥–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π</button>
                <button id="sortInv">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <div class="note">–¢–∏–ø—ã: –°—Ç–≤–æ–ª = —É—Ä–æ–Ω, –ó–∞—Ç–≤–æ—Ä = –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞, –ü—Ä–∏—Ü–µ–ª = –¥–∞–ª—å–Ω–æ—Å—Ç—å, –ü–æ—Ä–æ—Ö = —Å–∫–æ—Ä–æ—Å—Ç—å —Å–Ω–∞—Ä—è–¥–∞.</div>
        </div>
        <div class="panel">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="grid">
                <button id="start">‚ñ∂ –°–ª–µ–¥—É—é—â–∞—è –≤–æ–ª–Ω–∞</button>
                <button id="reset" class="b2">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
            </div>
            <div class="row" style="margin-top:8px">
                <button id="pause">‚è∏ –ü–∞—É–∑–∞</button>
                <label class="sel">–°–∫–æ—Ä–æ—Å—Ç—å:
                    <select id="speed">
                        <option value="1">√ó1</option>
                        <option value="2">√ó2</option>
                        <option value="3">√ó3</option>
                    </select>
                </label>
                <button id="save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="load">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            <div id="wavePrev" class="small" style="margin-top:8px"></div>
            <div style="margin-top:8px" class="small">
                –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤: 2√ó –¥–æ 15 –ª–≤–ª, 2√ó –¥–æ 10 –ª–≤–ª, 3√ó –¥–æ 6 –ª–≤–ª. –ù–∞ –±–∞—à–Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ –∞–ø–≥—Ä–µ–π–¥–æ–≤, –µ—Å–ª–∏ <b>—Å—É–º–º–∞ —É—Ä–æ–≤–Ω–µ–π ‚â§ –ª–∏–º–∏—Ç–∞</b>.
            </div>
            <div style="margin-top:8px" class="small">
                –°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏: base√ó—É—Ä–æ–≤–µ–Ω—å. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∞—à–Ω—é –¥–æ—Ä–æ–∂–∞–µ—Ç –ø–æ –º–µ—Å—Ç—É –∏ –∑–∞ 4-–π —É—Ä–æ–≤–µ–Ω—å (√ó5/√ó7).
            </div>
            <div class="small" style="margin-top:6px">–•–æ—Ç–∫–µ–∏: <b>Space</b> ‚Äî –≤–æ–ª–Ω–∞ ‚Ä¢ <b>P</b> ‚Äî –ø–∞—É–∑–∞ ‚Ä¢ <b>1/2/3</b> ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å ‚Ä¢ <b>Esc</b> ‚Äî –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</div>
        </div>
    </div>
</div>

<div id="toast"></div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –±–∞—à–Ω–∏ -->
<div id="modal">
    <div class="card">
        <h3 id="mTitle">–ë–∞—à–Ω—è</h3>
        <div id="mStats" class="stat" style="margin-bottom:8px"></div>
        <div class="row small" style="align-items:center;margin:6px 0">
            <label>–†–µ–∂–∏–º –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è:&nbsp;</label>
            <select id="aimMode" class="sel">
                <option value="first">–ü–µ—Ä–≤—ã–π –ø–æ –ø—É—Ç–∏</option>
                <option value="near">–ë–ª–∏–∂–∞–π—à–∏–π –∫ –±–∞—à–Ω–µ</option>
                <option value="strong">–°–∞–º—ã–π –∫—Ä–µ–ø–∫–∏–π</option>
            </select>
        </div>
        <div id="mList"></div>
        <div id="mCosts" class="small"></div>
        <div class="row" style="margin-top:10px">
            <button id="mClose">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button id="mSellAll" class="b3">–°–Ω–µ—Å—Ç–∏ –±–∞—à–Ω—é (–ø—Ä–æ–¥–∞—Ç—å –≤—Å—ë)</button>
        </div>
    </div>
</div>

<script>
/* ======== –ë–ê–õ–ê–ù–° ======== */
// –ë–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∑–¥–µ—Å—å
const BASE_TOWER = { dmg:14, rng:100, proj:100, rld:0.50 }; // +40% dmg, x2 range (–∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏)
const TYPES = {
    BARREL : {key:'BARREL', name:'–°—Ç–≤–æ–ª',   stat:'dmg', icon:'üî´', color:'#2b7cff'},
    BREECH : {key:'BREECH', name:'–ó–∞—Ç–≤–æ—Ä',  stat:'rld', icon:'üîß', color:'#ffcc66'},
    SCOPE  : {key:'SCOPE',  name:'–ü—Ä–∏—Ü–µ–ª',  stat:'rng', icon:'üéØ', color:'#57d88a'},
    POWDER : {key:'POWDER', name:'–ü–æ—Ä–æ—Ö',   stat:'proj',icon:'‚ö°', color:'#ffd54f'}
};
const LEVELS = {
    1:{ multi:1.20, cost:20,  drop:0.15 },
    2:{ multi:1.50, cost:60,  drop:0.07 },
    3:{ multi:2.00, cost:160, drop:0.03 },
    4:{ multi:3.00, cost:400, drop:0.01 }
};
const SLOTS = [
    {max:15, x:170,y:310},{max:15, x:560,y:120},
    {max:10, x:330,y:120},{max:10, x:740,y:330},
    {max:6,  x:240,y:230},{max:6,  x:480,y:300},{max:6,  x:680,y:190},
];
const PLACE_BASE_COST = 10;
const SECOND_L4_MULT = 5;
const THIRD_L4_MULT  = 7;
const REFUND_RATE_TOWER = 0.6; // –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –∏–∑ –±–∞—à–Ω–∏
const REFUND_RATE_INV   = 0.5; // –ø—Ä–æ–¥–∞–∂–∞ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è

/* ======== –ò–ì–†–û–í–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ======== */
const st = {
    money: 250, // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–æ–ª–æ—Ç–æ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
    lives: 20, wave: 0,
    enemies: [], projs: [], towers: [], // tower: {comps:[{type,level,purchaseCost}], level, stats, lastShot, mode}
    inv: [],
    pathLen: 0, lastTs: performance.now(),
    spawning:false, left:0, total:0,
    paused:false, speed:1
};

/* ======== –£–¢–ò–õ–ò–¢–´ ======== */
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
const fmt = n => n.toLocaleString('ru-RU');
function toast(msg, ms=1400){ const t=$("#toast"); t.textContent=msg; t.style.display='block'; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display='none',ms); }
function ruStat(k){ return {dmg:'—É—Ä–æ–Ω—É', rld:'–ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–µ (–º–µ–Ω—å—à–µ ‚Äî –±—ã—Å—Ç—Ä–µ–µ)', rng:'–¥–∞–ª—å–Ω–æ—Å—Ç–∏', proj:'—Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–Ω–∞—Ä—è–¥–∞'}[k]; }

/* ======== –ü–£–¢–¨ - –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã ======== */
const path = $("#track");
// path –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∏ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è —é–Ω–∏—Ç–æ–≤ ‚Äî —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è —Å –ª–æ–≥–∏–∫–æ–π
st.pathLen = path.getTotalLength();
function pointAt(dist){
    // dist –≤ –ø–∏–∫—Å–µ–ª—è—Ö –≤–¥–æ–ª—å –ø—É—Ç–∏
    const d = Math.min(Math.max(dist,0), st.pathLen-0.001);
    const p = path.getPointAtLength(d);
    return {x:p.x, y:p.y};
}

/* ======== –°–õ–û–¢–´: —Ä–µ–Ω–¥–µ—Ä –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (—Ç–µ–∫/–º–∞–∫—Å) ======== */
const board = $("#board");
function drawSlots(){
    $$(".slot").forEach(e=>e.remove());
    SLOTS.forEach((s, i)=>{
        const el = document.createElement('div');
        el.className = 'slot ' + (s.max===15?'l15':s.max===10?'l10':'l6');
        el.style.left = s.x+'px'; el.style.top = s.y+'px';
        el.dataset.idx = i;
        el.title = `–°–ª–æ—Ç ${i+1} ‚Ä¢ –ª–∏–º–∏—Ç —É—Ä–æ–≤–Ω—è: ${s.max}`;
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "—Ç–µ–∫—É—â–∏–π/–º–∞–∫—Å–∏–º—É–º" ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ updateSlotLabel()
        el.innerHTML = `<div class="slot-label"><span class="cur">0</span>/<span class="max">${s.max}</span></div>`;
        el.addEventListener('click', ()=>openTowerModal(i));
        // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ä–∞–¥–∏—É—Å–∞ –ø–æ –Ω–∞–≤–µ–¥–µ–Ω–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å –±–∞—à–Ω—è)
        el.addEventListener('mouseenter', ()=>{
            const t = st.towers[i];
            if(t) drawRange(s.x, s.y, t.stats.rng);
        });
        el.addEventListener('mouseleave', hideRange);
        board.appendChild(el);
    });
}
function updateSlotLabel(i){
    const slotEl = document.querySelector(`.slot[data-idx="${i}"]`);
    if(!slotEl) return;
    const t = st.towers[i];
    const cur = t ? t.level : 0;
    const max = SLOTS[i].max;
    slotEl.querySelector('.cur').textContent = cur;
    slotEl.querySelector('.max').textContent = max;
    if(t && t.level >= max) slotEl.classList.add('max'); else slotEl.classList.remove('max');
}
function updateAllSlotLabels(){ SLOTS.forEach((_,i)=>updateSlotLabel(i)); }
function towerAt(i){ return st.towers[i]||null; }

/* ======== –°–¢–ê–¢–´ / –°–¢–û–ò–ú–û–°–¢–ò ======== */
function sumLevel(comps){ return comps.reduce((a,c)=>a+c.level,0); }
function countL4(comps){ return comps.filter(c=>c.level===4).length; }
function calcStats(comps){
    const s = {...BASE_TOWER};
    for(const c of comps){
        const m = LEVELS[c.level].multi;
        if (TYPES[c.type].stat==='rld') s.rld = s.rld / m; else s[TYPES[c.type].stat]*=m;
    }
    return s;
}
function placeCost(levelSum){ return PLACE_BASE_COST * Math.max(1, levelSum); }
function addComponentCost(tower, comp){
    const base = LEVELS[comp.level].cost;
    const count = tower.comps.length;
    const progressive = 1 + count*2; // 1,3,5...
    let mult = progressive;
    const futureL4s = countL4(tower.comps) + (comp.level===4?1:0);
    if (futureL4s===2) mult *= SECOND_L4_MULT;
    if (futureL4s===3) mult *= THIRD_L4_MULT;
    return Math.round(base * mult);
}

/* ======== –ê–í–¢–û–°–õ–ò–Ø–ù–ò–ï –í –ë–ê–®–ù–ï (3->2 –∏ 3->3) ======== */
function compactTowerUpgrades(tower){
    let changed = true;
    while(changed){
        changed = false;
        for(const tp of Object.keys(TYPES)){
            for(const lv of [1,2]){ // —Ç–æ–ª—å–∫–æ 1 –∏ 2 –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è (3 –∏ 4 –Ω–µ—Ç)
                const idxs = [];
                for(let i=0;i<tower.comps.length;i++){
                    const c=tower.comps[i];
                    if(c.type===tp && c.level===lv) idxs.push(i);
                }
                if(idxs.length>=3){
                    const rem = idxs.slice(-3).sort((a,b)=>b-a);
                    // —Å—É–º–º–∏—Ä—É–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
                    let sumCost=0;
                    rem.forEach(i=>{ sumCost += tower.comps[i].purchaseCost||0; tower.comps.splice(i,1); });
                    tower.comps.push({type:tp, level:lv+1, purchaseCost:sumCost});
                    changed = true;
                }
            }
        }
    }
    tower.level = sumLevel(tower.comps);
    tower.stats = calcStats(tower.comps);
}

/* —Å–∏–º—É–ª—è—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
function simulateAdd(tower, comp){
    const tmp = { comps: (tower? tower.comps.map(c=>({type:c.type, level:c.level, purchaseCost:c.purchaseCost||0})) : []) };
    if(comp) tmp.comps.push({type:comp.type, level:comp.level, purchaseCost:0});
    compactTowerUpgrades(tmp);
    return {level: tmp.level, stats: tmp.stats};
}

/* ======== –ò–ù–í–ï–ù–¢–ê–†–¨ ======== */
const invWrap = $("#inv");
let invSel = -1;

function renderInv(){
    invWrap.innerHTML='';
    st.inv.forEach((c, i)=>{
        const d = document.createElement('div');
        d.className='comp '+(invSel===i?'sel':'')+' lvl'+c.level;
        d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><b>${TYPES[c.type].icon} ${TYPES[c.type].name}</b><span class="badge">L${c.level}</span></div>
                       <div class="small">–ë–æ–Ω—É—Å: ${LEVELS[c.level].multi.toFixed(2)}√ó –∫ ${ruStat(TYPES[c.type].stat)}</div>`;
        d.addEventListener('click',()=>{ invSel = (invSel===i?-1:i); renderInv(); if(modal.style.display==='flex') updateModalCosts(); });
        invWrap.appendChild(d);
    });
}

/* –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ç–µ–ø–µ—Ä—å 3->2 –∏ 3->3 (–≤–µ–∑–¥–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ) */
$("#combine").addEventListener('click', ()=>{
    const map = {};
    st.inv.forEach((c,idx)=>{ const key=c.type+'_'+c.level; (map[key]??=[]).push(idx); });
    let upgraded=false;
    for(const tp of Object.keys(TYPES)){
        const k=tp+'_1';
        if(map[k] && map[k].length>=3){
            const idxs=map[k].splice(0,3).sort((a,b)=>b-a);
            idxs.forEach(i=>st.inv.splice(i,1));
            st.inv.push({type:tp, level:2});
            upgraded=true; break;
        }
    }
    if(!upgraded){
        for(const tp of Object.keys(TYPES)){
            const k=tp+'_2';
            if(map[k] && map[k].length>=3){ // –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ 3
                const idxs=map[k].splice(0,3).sort((a,b)=>b-a);
                idxs.forEach(i=>st.inv.splice(i,1));
                st.inv.push({type:tp, level:3});
                upgraded=true; break;
            }
        }
    }
    toast(upgraded?'–ö–æ–º–±–∏–Ω–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞':'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ –¥–ª—è –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏');
    invSel=-1; renderInv(); if(modal.style.display==='flex') updateModalCosts();
});

/* –ø–æ–∫—É–ø–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
   —à–∞–Ω—Å: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏–ª —É–º–µ–Ω—å—à–∏—Ç—å —à–∞–Ω—Å—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–¥–∞–Ω–Ω—ã–µ –Ω–∏–∑–∫–∏–µ —à–∞–Ω—Å—ã:
   L4 0.5%, L3 1.5%, L2 3.5%, –æ—Å—Ç–∞–ª—å–Ω–æ–µ L1
*/
$("#newComp").addEventListener('click', ()=>{
    const price=25;
    if(st.money<price){ toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥'); return; }
    st.money-=price;
    const r = Math.random()*100;
    let lvl = 1;
    if(r < 0.5) lvl = 4;
    else if(r < 0.5 + 1.5) lvl = 3;
    else if(r < 0.5 + 1.5 + 3.5) lvl = 2;
    else lvl = 1;
    const keys=Object.keys(TYPES); const tp=keys[(Math.random()*keys.length)|0];
    st.inv.push({type:tp, level:lvl});
    updateHUD(); renderInv(); if(modal.style.display==='flex') updateModalCosts();
});

/* –ø—Ä–æ–¥–∞–∂–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∞ */
$("#sellInv").addEventListener('click', ()=>{
    if(invSel<0){ toast('–í—ã–¥–µ–ª–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ'); return; }
    const c = st.inv[invSel];
    const refund = Math.floor(LEVELS[c.level].cost * REFUND_RATE_INV);
    st.money += refund;
    st.inv.splice(invSel,1); invSel=-1;
    renderInv(); updateHUD();
    toast(`–ü—Ä–æ–¥–∞–Ω–æ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è: +${fmt(refund)}üí∞`);
});
$("#sortInv").addEventListener('click', ()=>{
    st.inv.sort((a,b)=> b.level-a.level || a.type.localeCompare(b.type));
    invSel=-1; renderInv();
});

/* ======== –†–ï–ù–î–ï–† –ë–ê–®–ï–ù –ò –ö–õ–ò–ö–ò: –±–∞—à–Ω—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞ –ø–æ –≤—Å–µ–π —Ñ–æ—Ä–º–µ ======== */
function renderTowers(){
    // —É–¥–∞–ª–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –±–∞—à–Ω–∏ –∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ
    $$(".tower").forEach(e=>e.remove());
    SLOTS.forEach((s,i)=>{
        const t = st.towers[i]; if(!t) return;
        const el = document.createElement('div');
        el.className='tower';
        el.style.left=s.x+'px'; el.style.top=s.y+'px';
        el.dataset.idx = i;
        // –±–µ–π–¥–∂ —Å —Ç–µ–∫—É—â–∏–º/–º–∞–∫—Å–∏–º—É–º
        const badge = document.createElement('div');
        badge.className = 'lvl-badge';
        badge.textContent = `${t.level}/${SLOTS[i].max}`;
        el.appendChild(badge);

        el.title=`–ë–∞—à–Ω—è L${t.level}  –£—Ä–æ–Ω:${t.stats.dmg.toFixed(1)}  –î–∞–ª:${t.stats.rng.toFixed(0)}  –ö–î:${t.stats.rld.toFixed(2)}—Å  –ü—É–ª—è:${t.stats.proj.toFixed(0)}  ‚Ä¢ ${aimModeName(t.mode)}`;

        // –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É
        el.addEventListener('click', (e)=>{
            e.stopPropagation(); // —á—Ç–æ–±—ã —Å–ª–æ—Ç –Ω–µ –ø–æ–ª—É—á–∏–ª –∫–ª–∏–∫
            openTowerModal(i);
        });
        // hover –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–¥–∏—É—Å
        el.addEventListener('mouseenter', ()=> drawRange(s.x, s.y, t.stats.rng));
        el.addEventListener('mouseleave', hideRange);

        board.appendChild(el);
    });
    // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–µ–π–±–ª—ã —Å–ª–æ—Ç–æ–≤
    updateAllSlotLabels();
}

/* ======== –ú–û–î–ê–õ–ö–ê –ë–ê–®–ù–ò: —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π (–∏ –ø–æ–∫—É–ø–∫–∞ –ø—Ä—è–º–æ –∏–∑ –º–æ–¥–∞–ª–∫–∏) ======== */
const modal = $("#modal"), mTitle=$("#mTitle"), mStats=$("#mStats"), mList=$("#mList"), mCosts=$("#mCosts"), aimSel=$("#aimMode");
$("#mClose").addEventListener('click',()=>{ modal.style.display='none'; hideRange(); });
document.addEventListener('keydown', e=>{
    if(e.key==='Escape') { modal.style.display='none'; hideRange(); }
    if(e.key===' '){ e.preventDefault(); $("#start").click(); }
    if(e.key.toLowerCase()==='p'){ togglePause(); }
    if(e.key==='1'||e.key==='2'||e.key==='3'){ $("#speed").value=e.key; st.speed=+e.key; toast(`–°–∫–æ—Ä–æ—Å—Ç—å √ó${e.key}`); }
});

let updateModalCosts = ()=>{};
function openTowerModal(slotIdx){
    const slot = SLOTS[slotIdx];
    let t = st.towers[slotIdx];
    mList.innerHTML=''; mCosts.innerHTML='';
    if(!t){
        mTitle.textContent = `–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞—à–Ω–∏ (—Å–ª–æ—Ç ${slotIdx+1}, –ª–∏–º–∏—Ç ${slot.max})`;
        mStats.innerHTML='';
        aimSel.disabled = true;
        const choose = document.createElement('div');
        choose.className='small';
        choose.textContent='–í—ã–¥–µ–ª–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –∏ –ø–æ—Å—Ç–∞–≤—å—Ç–µ –±–∞—à–Ω—é. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: —Å—É–º–º–∞ —É—Ä–æ–≤–Ω–µ–π –∞–ø–≥—Ä–µ–π–¥–æ–≤ ‚â§ –ª–∏–º–∏—Ç–∞ —Å–ª–æ—Ç–∞.';
        mList.appendChild(choose);

        const btn = document.createElement('button');
        btn.id = 'btnPlace';
        btn.textContent='–ü–æ—Å—Ç–∞–≤–∏—Ç—å (–∏–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ)';
        btn.addEventListener('click', ()=>{
            if(invSel<0){ toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–¥–µ–ª–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ'); return; }
            const comp = st.inv[invSel];
            if(comp.level>slot.max){ toast('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —É—Ä–æ–≤–Ω—è —Å–ª–æ—Ç–∞'); return; }
            const lvl = comp.level;
            const cost = placeCost(lvl);
            if(st.money<cost){ toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥'); return; }
            // —Å–æ–∑–¥–∞—ë–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å —Ñ–∏–∫—Å–∞—Ü–∏–µ–π —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
            const c = {type:comp.type, level:comp.level, purchaseCost:cost};
            st.money-=cost; st.inv.splice(invSel,1); invSel=-1; renderInv();
            t = { comps:[c], level:lvl, stats: calcStats([c]), lastShot:0, mode:'first' };
            st.towers[slotIdx]=t; renderTowers(); updateHUD();
            toast(`–ë–∞—à–Ω—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –°–ø–∏—Å–∞–Ω–æ ${fmt(cost)}üí∞`);
            modal.style.display='none'; hideRange();
        });
        mList.appendChild(btn);

        // –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞–¥–∏—É—Å–∞ –ø–æ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É
        updateModalCosts = function(){
            if(invSel<0){ mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏</div><div class="cost">‚Äî</div></div>`; hideRange(); return; }
            const comp = st.inv[invSel];
            if(comp.level>slot.max){
                mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏</div><div class="cost">–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (–ª–∏–º–∏—Ç ${slot.max})</div></div>`;
                hideRange();
            }else{
                const cost = placeCost(comp.level);
                const sim = simulateAdd(null, comp);
                mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏</div><div class="cost">üí∞ ${fmt(cost)}</div></div>`;
                drawRange(slot.x, slot.y, sim.stats.rng);
            }
        };
        updateModalCosts();
    } else {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞—à–Ω–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏/–∞–ø–≥—Ä–µ–π–¥—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏
        mTitle.textContent = `–ë–∞—à–Ω—è (—Å–ª–æ—Ç ${slotIdx+1}) ‚Ä¢ —É—Ä–æ–≤–µ–Ω—å ${t.level}/${slot.max}`;
        aimSel.disabled = false; aimSel.value = t.mode||'first';
        aimSel.onchange = ()=>{ t.mode = aimSel.value; renderTowers(); };

        drawRange(slot.x, slot.y, t.stats.rng);

        mStats.innerHTML = `
            <div>–£—Ä–æ–Ω</div><div class="pill">${t.stats.dmg.toFixed(1)}</div>
            <div>–î–∞–ª—å–Ω–æ—Å—Ç—å</div><div class="pill">${t.stats.rng.toFixed(0)} px</div>
            <div>–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞</div><div class="pill">${t.stats.rld.toFixed(2)} —Å</div>
            <div>–°–∫–æ—Ä–æ—Å—Ç—å —Å–Ω–∞—Ä—è–¥–∞</div><div class="pill">${t.stats.proj.toFixed(0)} px/—Å</div>
        `;

        const hint = document.createElement('div');
        hint.className='small'; hint.style.margin='8px 0';
        hint.innerHTML='–î–æ–±–∞–≤—å—Ç–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∏–ª–∏ –∫—É–ø–∏—Ç–µ –ø—Ä—è–º–æ –∑–¥–µ—Å—å. –ê–≤—Ç–æ—Å–ª–∏—è–Ω–∏–µ: 3√óL1‚ÜíL2, 3√óL2‚ÜíL3.';
        mList.appendChild(hint);

        // —Å–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–∏—Ö —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ —Å –ø—Ä–æ–¥–∞–∂–µ–π
        const list = document.createElement('div');
        list.style.marginTop='6px';
        t.comps.forEach((c, idx)=>{
            const row = document.createElement('div');
            row.className='row small';
            row.style.justifyContent='space-between';
            const refund = Math.floor((c.purchaseCost||0) * REFUND_RATE_TOWER);
            row.innerHTML = `<div>‚Ä¢ ${TYPES[c.type].name} L${c.level} <span class="pill">—Å—Ç–æ–∏–ª ${fmt(c.purchaseCost||0)}üí∞</span></div>`;
            const btnS = document.createElement('button'); btnS.textContent=`–ü—Ä–æ–¥–∞—Ç—å (+${fmt(refund)}üí∞)`;
            btnS.addEventListener('click', ()=>{
                st.money += refund;
                t.comps.splice(idx,1);
                if(t.comps.length===0){ // —Å–Ω–æ—Å–∏–º –±–∞—à–Ω—é
                    st.towers[slotIdx]=null; renderTowers(); updateHUD(); toast(`–ë–∞—à–Ω—è —Å–Ω—è—Ç–∞ (+${fmt(refund)}üí∞)`); modal.style.display='none'; hideRange(); return;
                }
                // –ø–µ—Ä–µ—Å—á–µ—Ç
                t.level = sumLevel(t.comps);
                t.stats = calcStats(t.comps);
                renderTowers(); updateHUD();
                toast(`–ü—Ä–æ–¥–∞–Ω–æ —Å –±–∞—à–Ω–∏: +${fmt(refund)}üí∞`);
                openTowerModal(slotIdx);
            });
            row.appendChild(btnS);
            list.appendChild(row);
        });
        mList.appendChild(list);

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        const btnAdd = document.createElement('button');
        btnAdd.id='btnAdd';
        btnAdd.textContent='–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞—à–Ω—é (–∏–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ)';
        btnAdd.addEventListener('click', ()=>{
            if(invSel<0){ toast('–í—ã–¥–µ–ª–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ'); return; }
            const c0 = st.inv[invSel];
            const newLevel = t.level + c0.level;
            if(newLevel>slot.max){ toast('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —É—Ä–æ–≤–Ω—è —Å–ª–æ—Ç–∞'); return; }
            const cost = addComponentCost(t, c0);
            if(st.money<cost){ toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥'); return; }
            st.money-=cost; const c = {type:c0.type, level:c0.level, purchaseCost:cost};
            st.inv.splice(invSel,1); invSel=-1; renderInv();
            t.comps.push(c);
            compactTowerUpgrades(t);
            renderTowers(); updateHUD();
            toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${TYPES[c.type].name} L${c.level} (—Å—Ç–æ–∏–º–æ—Å—Ç—å ${fmt(cost)}üí∞)`);
            modal.style.display='none'; hideRange();
        });
        mList.appendChild(btnAdd);

        // –ü–æ–∫—É–ø–∫–∞ –∞–ø–≥—Ä–µ–π–¥–∞ –ø—Ä—è–º–æ –∏–∑ –º–æ–¥–∞–ª–∫–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (—Ç–∏–ø x —É—Ä–æ–≤–µ–Ω—å)
        const shopTitle = document.createElement('div'); shopTitle.className='small'; shopTitle.style.marginTop='10px';
        shopTitle.textContent = '–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ (–∫—É–ø–∏—Ç—å –∏ —Å—Ä–∞–∑—É –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ —ç—Ç—É –±–∞—à–Ω—é):';
        mList.appendChild(shopTitle);

        // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∏ —É—Ä–æ–≤–Ω—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∫—É–ø–∫–∏, –µ—Å–ª–∏ –Ω–µ –Ω–∞—Ä—É—à–∏—Ç –ª–∏–º–∏—Ç
        const shopBox = document.createElement('div');
        Object.keys(TYPES).forEach(tp=>{
            const row = document.createElement('div');
            row.className='upgrade-row';
            const label = document.createElement('div');
            label.style.width='140px';
            label.innerHTML = `<b>${TYPES[tp].icon} ${TYPES[tp].name}</b>`;
            row.appendChild(label);
            for(let lvl=1; lvl<=4; lvl++){
                const btn = document.createElement('button');
                btn.textContent = `L${lvl} ‚Äî ${fmt(LEVELS[lvl].cost)}üí∞`;
                const tempComp = {type:tp, level: lvl};
                const newLevel = t.level + lvl;
                const possible = (newLevel <= slot.max);
                const cost = addComponentCost(t, tempComp);
                // –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –∏–ª–∏ –¥–µ–Ω–µ–≥ –Ω–µ—Ç ‚Äî –¥–∏–∑–µ–π–±–ª
                if(!possible) btn.classList.add('bd');
                btn.addEventListener('click', ()=>{
                    if(!possible){ toast('–ü—Ä–µ–≤—ã—Å–∏—Ç–µ –ª–∏–º–∏—Ç —Å–ª–æ—Ç–∞'); return; }
                    if(st.money < cost){ toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥'); return; }
                    st.money -= cost;
                    const c = {type:tp, level: lvl, purchaseCost: cost};
                    t.comps.push(c);
                    compactTowerUpgrades(t);
                    renderTowers(); updateHUD();
                    toast(`–ö—É–ø–ª–µ–Ω–æ ${TYPES[tp].name} L${lvl} ‚Üí —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ –±–∞—à–Ω—é (—Å—Ç–æ–∏–º–æ—Å—Ç—å ${fmt(cost)}üí∞)`);
                    modal.style.display='none'; hideRange();
                });
                row.appendChild(btn);
            }
            shopBox.appendChild(row);
        });
        mList.appendChild(shopBox);

        // –ö–Ω–æ–ø–∫–∞ —Å–Ω–æ—Å (–ø—Ä–æ–¥–∞—Ç—å –≤—Å—ë)
        $("#mSellAll").onclick = ()=>{
            let sum=0; t.comps.forEach(c=> sum += Math.floor((c.purchaseCost||0) * REFUND_RATE_TOWER));
            st.money += sum;
            st.towers[slotIdx]=null; renderTowers(); updateHUD(); toast(`–ë–∞—à–Ω—è —Å–Ω–µ—Å–µ–Ω–∞: +${fmt(sum)}üí∞`);
            modal.style.display='none'; hideRange();
        };

        updateModalCosts = function(){
            if(invSel<0){
                mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è</div><div class="cost">‚Äî</div></div>`;
                drawRange(slot.x, slot.y, t.stats.rng); return;
            }
            const c0 = st.inv[invSel];
            const newLevel = t.level + c0.level;
            if(newLevel>slot.max){
                mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è</div><div class="cost">–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (–ª–∏–º–∏—Ç ${slot.max})</div></div>`;
                drawRange(slot.x, slot.y, t.stats.rng);
            }else{
                const cost = addComponentCost(t, c0);
                const sim = simulateAdd(t, c0);
                mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è</div><div class="cost">üí∞ ${fmt(cost)}</div></div>`;
                drawRange(slot.x, slot.y, sim.stats.rng);
            }
        };
        updateModalCosts();
    }
    modal.style.display='flex';
}

/* ======== –†–ò–°–û–í–ê–ù–ò–ï –†–ê–î–ò–£–°–ê (overlay) ======== */
const rangeEl = $("#range");
function drawRange(x,y,r){ rangeEl.setAttribute('cx',x); rangeEl.setAttribute('cy',y); rangeEl.setAttribute('r',Math.max(8,r)); }
function hideRange(){ rangeEl.setAttribute('cx',-1000); rangeEl.setAttribute('cy',-1000); }

/* ======== –í–û–õ–ù–´: –∫–æ–Ω—Ñ–∏–≥ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ======== */
function waveConfig(w){
    const count = Math.min(8 + Math.floor(w*1.5), 45);
    const hp = Math.floor(35 * Math.pow(1.16, Math.max(0,w-1)));
    const money = 6 + Math.floor(w/2);
    const speed = 60 + Math.min(100, Math.floor(Math.max(0,w-1)*6));
    return {count, hp, money, speed};
}
function updateWavePreview(){
    const n = st.wave+1; const w = waveConfig(n);
    $("#wavePrev").innerHTML = `–°–ª–µ–¥—É—é—â–∞—è –≤–æ–ª–Ω–∞ <b>#${n}</b>: –≤—Ä–∞–≥–æ–≤ <b>${w.count}</b> ‚Ä¢ HP <b>${w.hp}</b> ‚Ä¢ —Å–∫–æ—Ä–æ—Å—Ç—å <b>${w.speed}px/—Å</b> ‚Ä¢ –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ —É–±–∏–π—Å—Ç–≤–æ <b>${w.money}üí∞</b>`;
}

/* ======== –í–†–ê–ì–ò/–ü–£–õ–ò ======== */
function spawnEnemy(hp, speedPx, reward){
    const e = { d:0, hp, max:hp, sp:speedPx, money:reward, dead:false, el:null };
    const p = pointAt(0);
    e.x=p.x; e.y=p.y;
    st.enemies.push(e); st.left++; updateHUD();
    const el = document.createElement('div'); el.className='enemy';
    const hpEl = document.createElement('div'); hpEl.className='hp'; const i = document.createElement('i'); hpEl.appendChild(i); el.appendChild(hpEl);
    board.appendChild(el); e.el = el;
}
function killEnemy(e, reward=true){
    if(e.dead) return;
    e.dead = true;
    e.el && e.el.remove();
    st.enemies = st.enemies.filter(x=>x!==e);
    st.left = Math.max(0, st.left-1);
    if(reward){ st.money += e.money; }
    updateHUD();
}
function enemyReachedEnd(e){
    if(e.dead) return;
    e.dead = true;
    e.el && e.el.remove();
    // —É–º–µ–Ω—å—à–∞–µ–º –∂–∏–∑–Ω–∏ –Ω–∞ 1, –Ω–æ –Ω–µ –¥–∞—ë–º —É–π—Ç–∏ –≤ –º–∏–Ω—É—Å
    st.enemies = st.enemies.filter(x=>x!==e);
    st.left = Math.max(0, st.left-1);
    st.lives = Math.max(0, st.lives - 1);
    updateHUD();
    if(st.lives===0){ gameOver(false); }
}
function spawnWave(){
    if(st.spawning || st.enemies.length>0) return;
    st.wave++; const w = waveConfig(st.wave);
    st.total = w.count; st.left = 0; st.spawning = true; updateHUD();
    let spawned=0;
    const int = setInterval(()=>{
        if(st.paused) return;
        spawnEnemy(w.hp, w.speed, w.money);
        spawned++;
        if(spawned>=w.count){ clearInterval(int); st.spawning=false; }
    }, 420);
}

/* ======== HUD / –û–ë–ù–û–í–õ–ï–ù–ò–ï ======== */
function updateHUD(){
    $("#money").textContent = fmt(st.money);
    $("#lives").textContent = fmt(st.lives);
    $("#wave").textContent  = fmt(st.wave);
    $("#left").textContent  = fmt(st.left);
    $("#total").textContent = fmt(st.total);
    const canStart = (!st.spawning && st.enemies.length===0);
    $("#start").classList.toggle('bd', !canStart || st.paused);
    updateWavePreview();
}

/* ======== –¢–ê–†–ì–ï–¢–ò–ù–ì –ò –ì–ï–ô–ú–õ–£–ü ======== */
function towerPickTarget(t, sx, sy){
    if(st.enemies.length===0) return null;
    let chosen=null;
    if((t.mode||'first')==='near'){
        let best=1e9;
        for(const e of st.enemies){
            const d = Math.hypot(e.x-sx,e.y-sy);
            if(d<=t.stats.rng && d<best){ best=d; chosen=e; }
        }
    } else if(t.mode==='strong'){
        let best=-1;
        for(const e of st.enemies){
            const d = Math.hypot(e.x-sx,e.y-sy);
            if(d<=t.stats.rng && e.hp>best){ best=e.hp; chosen=e; }
        }
    } else { // first –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É
        let best=-1;
        for(const e of st.enemies){
            const d = Math.hypot(e.x-sx,e.y-sy);
            if(d<=t.stats.rng && e.d>best){ best=e.d; chosen=e; }
        }
    }
    return chosen;
}
function aimModeName(m){ return m==='near'?'–ë–ª–∏–∂–∞–π—à–∏–π':m==='strong'?'–°–∞–º—ã–π –∫—Ä–µ–ø–∫–∏–π':'–ü–µ—Ä–≤—ã–π –ø–æ –ø—É—Ç–∏'; }

function step(ts){
    let dt = Math.min(0.05, (ts - st.lastTs)/1000);
    st.lastTs = ts;
    if(st.paused){ requestAnimationFrame(step); return; }
    dt *= st.speed;

    // ENEMIES
    for(const e of st.enemies.slice()){ // slice —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
        if(e.dead) continue;
        e.d += e.sp * dt;
        if(e.d >= st.pathLen-1){ enemyReachedEnd(e); continue; }
        const p = pointAt(e.d);
        e.x=p.x; e.y=p.y;
        if(e.el){
            e.el.style.left = e.x+'px';
            e.el.style.top  = e.y+'px';
            const ratio = Math.max(0, e.hp)/e.max;
            const bar = e.el.querySelector('.hp>i'); if(bar) bar.style.width=(Math.max(0,ratio)*22)+'px';
        }
    }

    // TOWERS SHOOT
    const now = ts/1000;
    SLOTS.forEach((s,i)=>{
        const t = st.towers[i]; if(!t) return;
        if(!t.lastShot) t.lastShot=0;
        if(now - t.lastShot < t.stats.rld / st.speed) return; // —É—á—ë—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–≥—Ä—ã

        const tgt = towerPickTarget(t, s.x, s.y);
        if(tgt){
            const pr = { x:s.x, y:s.y, v:t.stats.proj, dmg:t.stats.dmg, tgt:tgt, dead:false, el:null };
            const pel = document.createElement('div'); pel.className='proj'; board.appendChild(pel); pr.el=pel;
            st.projs.push(pr);
            t.lastShot = now;
        }
    });

    // PROJECTILES
    for(const p of st.projs.slice()){
        if(p.dead){ p.el && p.el.remove(); continue; }
        if(!p.tgt || p.tgt.dead){ p.dead=true; p.el && p.el.remove(); continue; }
        const dx = p.tgt.x - p.x, dy = p.tgt.y - p.y;
        const dist = Math.hypot(dx,dy);
        const mv = p.v * dt;
        if(dist <= mv){
            p.tgt.hp -= p.dmg;
            p.dead = true; p.el && p.el.remove();
            if(p.tgt.hp<=0){ killEnemy(p.tgt,true); }
        } else {
            p.x += dx/dist * mv; p.y += dy/dist * mv;
            p.el.style.left=p.x+'px'; p.el.style.top=p.y+'px';
        }
    }
    st.projs = st.projs.filter(pr=>!pr.dead);

    // WAVE END
    if(!st.spawning && st.enemies.length===0 && st.total>0 && st.left===0){
        const bonus = 50 + st.wave*12;
        st.money += bonus; updateHUD();
        dropComponentsAfterWave();
        st.total = 0;
        toast(`–í–æ–ª–Ω–∞ ${st.wave} –ø—Ä–æ–π–¥–µ–Ω–∞! –ë–æ–Ω—É—Å +${fmt(bonus)}üí∞`);
    }

    requestAnimationFrame(step);
}

/* ======== –î–†–û–ü ======== */
function dropComponentsAfterWave(){
    [1,2,3,4].forEach(lvl=>{
        if(Math.random() < LEVELS[lvl].drop){
            const keys=Object.keys(TYPES); const tp=keys[(Math.random()*keys.length)|0];
            st.inv.push({type:tp, level:lvl});
        }
    });
    renderInv();
}

/* ======== –°–ï–ô–í/–õ–û–ê–î ======== */
function saveGame(){
    const data = {
        money:st.money, lives:st.lives, wave:st.wave,
        inv: st.inv.slice(),
        towers: SLOTS.map((_,i)=>{
            const t = st.towers[i];
            if(!t) return null;
            return {comps: t.comps.map(c=>({type:c.type,level:c.level,purchaseCost:c.purchaseCost||0})), mode:t.mode||'first'};
        })
    };
    localStorage.setItem('td_save', JSON.stringify(data));
    toast('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
}
function loadGame(){
    const raw = localStorage.getItem('td_save');
    if(!raw){ toast('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); return; }
    try{
        const data = JSON.parse(raw);
        // wipe
        st.enemies.forEach(e=>e.el&&e.el.remove()); st.enemies=[];
        st.projs.forEach(p=>p.el&&p.el.remove()); st.projs=[];
        st.spawning=false; st.left=0; st.total=0;

        st.money=data.money||250; st.lives=data.lives||20; st.wave=data.wave||0;
        st.inv = (data.inv||[]).map(c=>({type:c.type, level:c.level}));
        st.towers = [];
        (data.towers||[]).forEach((t,i)=>{
            if(!t){ st.towers[i]=null; return; }
            const comps = (t.comps||[]).map(c=>({type:c.type, level:c.level, purchaseCost:c.purchaseCost||0}));
            const tw = {comps, level: sumLevel(comps), stats: calcStats(comps), lastShot:0, mode:t.mode||'first'};
            st.towers[i]=tw;
        });
        renderInv(); renderTowers(); updateHUD();
        toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
    }catch(e){ console.error(e); toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); }
}

/* ======== –ö–û–ù–¢–†–û–õ–¨ –ò –ö–ù–û–ü–ö–ò –ò–ì–†–´ ======== */
function gameOver(victory){
    toast(victory?'–ü–æ–±–µ–¥–∞!':'–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!');
    st.spawning=false;
    st.enemies.forEach(e=>e.el&&e.el.remove());
    st.projs.forEach(p=>p.el&&p.el.remove());
    st.enemies=[]; st.projs=[];
    updateHUD();
}
function newGame(){
    st.money = 250; st.lives = 20; st.wave = 0;
    st.enemies.forEach(e=>e.el&&e.el.remove()); st.enemies=[];
    st.projs.forEach(p=>p.el&&p.el.remove()); st.projs=[];
    st.towers = [];
    st.inv = [];
    st.total=0; st.left=0; st.spawning=false; st.paused=false; st.speed=1; $("#speed").value='1';
    const keys=Object.keys(TYPES);
    for(let i=0;i<3;i++){
        const tp = keys[(Math.random()*keys.length)|0];
        st.inv.push({type:tp, level:1});
    }
    renderInv(); renderTowers(); updateHUD(); hideRange();
    toast('–ù–æ–≤–∞—è –∏–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞');
}
function togglePause(){
    st.paused = !st.paused;
    $("#pause").textContent = st.paused ? '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '‚è∏ –ü–∞—É–∑–∞';
    updateHUD();
}

/* ======== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======== */
drawSlots();
newGame();
requestAnimationFrame(step);

/* ======== –ë–ò–ù–î–ò–ù–ì UI ======== */
$("#start").addEventListener('click', ()=>{ if($("#start").classList.contains('bd')) return; spawnWave(); });
$("#reset").addEventListener('click', newGame);
$("#pause").addEventListener('click', togglePause);
$("#speed").addEventListener('change', e=>{ st.speed = +e.target.value; });
$("#save").addEventListener('click', saveGame);
$("#load").addEventListener('click', loadGame);

/* ======== –ú–ï–õ–û–ß–ò ======== */
window.addEventListener('resize', ()=>{ /* –∞–¥–∞–ø—Ç–∏–≤ –±–µ–∑ –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç–∞ –ø—É—Ç–∏ */ });
document.addEventListener('visibilitychange', ()=>{ st.lastTs = performance.now(); });
</script>
</body>
</html>
