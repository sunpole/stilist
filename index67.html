<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>TD ‚Äî –ö–∞—Å—Ç–æ–º–Ω—ã–µ –±–∞—à–Ω–∏ –∏–∑ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</title>
<style>
    :root{
        --bg:#0f1220;--panel:#171b2e;--panel2:#1e2440;--text:#e7ecff;--muted:#9aa4d6;--accent:#6ee7ff;--ok:#57d88a;--warn:#ffb86b;--bad:#ff6b6b;
        --slot-ok:#2a334f;--slot-max:#40518d;--btn:#2b7cff;--btn2:#2e9d6c;--btn3:#f0b429;--btn-dis:#3a4161;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
        margin:0;background:linear-gradient(180deg,#0b0f1d,#121632);
        color:var(--text);font:500 14px/1.4 system-ui,Segoe UI,Roboto,Arial;
        touch-action:manipulation;
    }
    #wrap{max-width:1000px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}
    header{padding:10px 12px;background:#121737;box-shadow:0 2px 0 rgba(0,0,0,.35);position:sticky;top:0;z-index:10}
    header h1{font-size:18px;margin:0}
    #hud{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:8px}
    .chip{background:var(--panel);padding:8px 10px;border-radius:10px;display:flex;align-items:center;justify-content:center}
    .chip b{font-size:16px;margin-left:6px}
    #board-wrap{padding:10px}
    #board{position:relative;height:420px;border-radius:16px;overflow:hidden;background:#0b1b21;box-shadow:inset 0 0 0 2px #0c2c39}
    #path{position:absolute;inset:0}
    .slot{
        position:absolute;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
        color:#fff;font-weight:800;font-size:12px;transform:translate(-50%,-50%);cursor:pointer;user-select:none;
        border:2px solid #88a;box-shadow:0 0 0 2px rgba(0,0,0,.2) inset;
    }
    .slot.l15{background:linear-gradient(180deg,#284,#173)} .slot.l10{background:linear-gradient(180deg,#484,#262)} .slot.l6{background:linear-gradient(180deg,#448,#226)}
    .slot.max{outline:2px dashed #ffd166}
    .tower{position:absolute;width:30px;height:30px;border-radius:50%;transform:translate(-50%,-50%);background:#2b7cff;border:2px solid #0f4fd6}
    .tower::after{content:'';position:absolute;inset:-2px;border-radius:50%;box-shadow:0 0 0 2px rgba(110,231,255,.35)}
    .enemy{position:absolute;width:20px;height:20px;border-radius:50%;transform:translate(-50%,-50%);background:#ff6b6b;box-shadow:0 0 10px rgba(255,107,107,.6)}
    .hp{position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:22px;height:3px;background:rgba(0,0,0,.4);border-radius:2px}
    .hp>i{display:block;height:100%;background:#57d88a;border-radius:2px}
    .proj{position:absolute;width:8px;height:8px;border-radius:50%;transform:translate(-50%,-50%);background:#ffeb3b;box-shadow:0 0 8px rgba(255,235,59,.8)}
    #ui{display:grid;grid-template-columns:1fr;gap:10px;padding:10px}
    .panel{background:var(--panel2);border-radius:16px;padding:10px}
    .panel h3{margin:0 0 8px 0;font-size:14px;color:#b7c3ff}
    #inv{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:8px}
    .comp{background:var(--panel);border:1px solid #2d3760;border-radius:12px;padding:6px;display:flex;flex-direction:column;gap:4px;cursor:pointer}
    .comp.sel{outline:2px solid var(--accent)}
    .badge{font-size:11px;color:#9aa4d6;background:#0f1c3a;padding:1px 6px;border-radius:999px;margin-left:6px}
    .lvl1{background:#1f3b2f} .lvl2{background:#214a3b} .lvl3{background:#245447} .lvl4{background:#276055}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    button{background:var(--btn);border:0;color:#fff;padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer}
    .b2{background:var(--btn2)} .b3{background:var(--btn3)} .bd{background:var(--btn-dis)!important;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .note{color:var(--muted);font-size:12px}
    #toast{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#0e1430;color:#fff;padding:10px 14px;border-radius:12px;display:none;z-index:50}
    #modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:60}
    #modal>.card{background:#0f1536;border-radius:16px;padding:14px;max-width:92vw;width:460px}
    .small{font-size:12px;color:#9fb3ff}
    .stat{display:grid;grid-template-columns:1fr auto;gap:4px}
    .pill{padding:2px 6px;border-radius:999px;background:#0e1a3b;color:#bcd}
    .costline{margin-top:8px;display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
    .cost{background:#0c1a35;border:1px solid #293a6a;padding:4px 8px;border-radius:8px}
    @media (min-width:860px){
        #ui{grid-template-columns:1.2fr .8fr}
    }
</style>
</head>
<body>
<div id="wrap">
    <header>
        <h1>–ë–∞—à–µ–Ω–Ω–∞—è –æ–±–æ—Ä–æ–Ω–∞ ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–∞—à–µ–Ω –∏–∑ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</h1>
        <div id="hud">
            <div class="chip">üí∞ –î–µ–Ω—å–≥–∏: <b id="money">0</b></div>
            <div class="chip">‚ù§Ô∏è –ñ–∏–∑–Ω–∏: <b id="lives">20</b></div>
            <div class="chip">üåä –í–æ–ª–Ω–∞: <b id="wave">0</b></div>
            <div class="chip">üëæ –í—Ä–∞–≥–æ–≤: <b><span id="left">0</span>/<span id="total">0</span></b></div>
        </div>
    </header>

    <div id="board-wrap">
        <div id="board">
            <!-- –ü—É—Ç—å -->
            <svg id="path" viewBox="0 0 920 420" preserveAspectRatio="none">
                <defs>
                    <filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                </defs>
                <path id="track" d="M20,360
                    C180,360 180,60 320,60
                    S460,360 600,360
                    S740,60 900,60" fill="none" stroke="#2a845f" stroke-width="26" opacity=".25" />
                <path id="trackLine" d="M20,360
                    C180,360 180,60 320,60
                    S460,360 600,360
                    S740,60 900,60" fill="none" stroke="#42e39f" stroke-width="6" filter="url(#glow)" />
            </svg>
            <!-- –°–ª–æ—Ç—ã (—Å—Ç–∞–≤—è—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º) -->
        </div>
    </div>

    <div id="ui">
        <div class="panel">
            <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤</h3>
            <div id="inv"></div>
            <div class="row" style="margin-top:8px">
                <button id="combine" class="b3">–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å: 3√óL1‚ÜíL2, 5√óL2‚ÜíL3</button>
                <button id="newComp" class="b2">–ö—É–ø–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π L1 (üí∞ 25)</button>
            </div>
            <div class="note">–¢–∏–ø—ã: –°—Ç–≤–æ–ª = —É—Ä–æ–Ω, –ó–∞—Ç–≤–æ—Ä = –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞, –ü—Ä–∏—Ü–µ–ª = –¥–∞–ª—å–Ω–æ—Å—Ç—å, –ü–æ—Ä–æ—Ö = —Å–∫–æ—Ä–æ—Å—Ç—å —Å–Ω–∞—Ä—è–¥–∞.</div>
        </div>
        <div class="panel">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="grid">
                <button id="start" class="">‚ñ∂ –°–ª–µ–¥—É—é—â–∞—è –≤–æ–ª–Ω–∞</button>
                <button id="reset" class="b2">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
            </div>
            <div style="margin-top:8px" class="small">
                –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤: 2√ó –¥–æ 15 –ª–≤–ª, 2√ó –¥–æ 10 –ª–≤–ª, 3√ó –¥–æ 6 –ª–≤–ª.
                –ù–∞ –±–∞—à–Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ –∞–ø–≥—Ä–µ–π–¥–æ–≤, –µ—Å–ª–∏ <b>—Å—É–º–º–∞ —É—Ä–æ–≤–Ω–µ–π –∞–ø–≥—Ä–µ–π–¥–æ–≤ ‚â§ –ª–∏–º–∏—Ç–∞ —Å–ª–æ—Ç–∞</b>.
            </div>
            <div style="margin-top:8px" class="small">
                –°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∞—à–Ω–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –µ—ë —É—Ä–æ–≤–Ω—è: base√ó—É—Ä–æ–≤–µ–Ω—å (–ø—Ä–∏ 15 –ª–≤–ª ‚Äî √ó15). –î–ª—è 2/3 —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ 4 —É—Ä–æ–≤–Ω—è –≤ –±–∞—à–Ω–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞–¥–±–∞–≤–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏: √ó5 / √ó7.
                –í –º–æ–¥–∞–ª–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å.
            </div>
        </div>
    </div>
</div>

<div id="toast"></div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –∞–ø–≥—Ä–µ–π–¥–∞ –±–∞—à–Ω–∏ -->
<div id="modal">
    <div class="card">
        <h3 id="mTitle">–ë–∞—à–Ω—è</h3>
        <div id="mStats" class="stat" style="margin-bottom:8px"></div>
        <div id="mList"></div>
        <div id="mCosts" class="small"></div>
        <div class="row" style="margin-top:10px">
            <button id="mClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<script>
/* ======== –ö–û–ù–°–¢–ê–ù–¢–´ –î–ò–ó–ê–ô–ù–ê –ò –ë–ê–õ–ê–ù–°–ê ======== */
const BASE_TOWER = { dmg:14, rng:100, proj:100, rld:0.50 }; // —É—Ä–æ–Ω (+40%), –¥–∞–ª—å–Ω–æ—Å—Ç—å √ó2, —Å–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª–∏, –ö–î
const TYPES = {
    BARREL : {key:'BARREL', name:'–°—Ç–≤–æ–ª',   stat:'dmg', icon:'üî´', color:'#2b7cff'},
    BREECH : {key:'BREECH', name:'–ó–∞—Ç–≤–æ—Ä',  stat:'rld', icon:'üîß', color:'#ffcc66'},
    SCOPE  : {key:'SCOPE',  name:'–ü—Ä–∏—Ü–µ–ª',  stat:'rng', icon:'üéØ', color:'#57d88a'},
    POWDER : {key:'POWDER', name:'–ü–æ—Ä–æ—Ö',   stat:'proj',icon:'‚ö°', color:'#ffd54f'}
};
const LEVELS = {
    1:{ multi:1.20, cost:20,  drop:0.15 },
    2:{ multi:1.50, cost:60,  drop:0.07 },
    3:{ multi:2.00, cost:160, drop:0.03 },
    4:{ multi:3.00, cost:400, drop:0.01 }
};
// —Å–ª–æ—Ç—ã: 2√ó15, 2√ó10, 3√ó6
const SLOTS = [
    {max:15, x:170,y:310},{max:15, x:560,y:120},
    {max:10, x:330,y:120},{max:10, x:740,y:330},
    {max:6,  x:240,y:230},{max:6,  x:480,y:300},{max:6,  x:680,y:190},
];

// –≤–æ–ª–Ω—ã ‚Äî —Ñ–æ—Ä–º—É–ª–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (–º–æ–∂–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)
function waveConfig(w){
    const count = Math.min(8 + Math.floor(w*1.5), 45);
    const hp = Math.floor(35 * Math.pow(1.16, w-1));
    const money = 6 + Math.floor(w/2);
    const speed = 60 + Math.min(100, Math.floor((w-1)*6));
    return {count, hp, money, speed};
}

const PLACE_BASE_COST = 10; // –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ 1 —É—Ä–æ–≤–µ–Ω—å –±–∞—à–Ω–∏
const SECOND_L4_MULT = 5;   // –µ—Å–ª–∏ –≤ –±–∞—à–Ω–µ 2 —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∞ 4 –ª–≤–ª ‚Äî √ó5 –∫ —Ü–µ–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∞
const THIRD_L4_MULT  = 7;   // –µ—Å–ª–∏ 3 —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∞ 4 –ª–≤–ª ‚Äî √ó7

/* ======== –°–û–°–¢–û–Ø–ù–ò–ï ======== */
const st = {
    money: 150, lives: 20, wave: 0,
    enemies: [], projs: [], towers: [], // towers[i] –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Å–ª–æ—Ç—É SLOTS[i]
    inv: [],                            // {type: 'BARREL'|'BREECH'|'SCOPE'|'POWDER', level:1..4}
    pathLen: 0, lastTs: performance.now(),
    spawning:false, left:0, total:0
};

/* ======== –£–¢–ò–õ–ò–¢–´ UI ======== */
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
const fmt = n => n.toLocaleString('ru-RU');
function toast(msg, ms=1400){ const t=$("#toast"); t.textContent=msg; t.style.display='block'; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display='none',ms); }

/* ======== –ü–£–¢–¨ ======== */
const path = $("#track");
const pathLen = path.getTotalLength();
st.pathLen = pathLen;
function pointAt(dist){
    const d = Math.min(Math.max(dist,0), st.pathLen-0.001);
    const p = path.getPointAtLength(d);
    return {x:p.x, y:p.y};
}

/* ======== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–õ–û–¢–û–í/–ë–ê–®–ï–ù ======== */
const board = $("#board");
function drawSlots(){
    $$(".slot").forEach(e=>e.remove());
    SLOTS.forEach((s, i)=>{
        const el = document.createElement('div');
        el.className = 'slot ' + (s.max===15?'l15':s.max===10?'l10':'l6');
        el.style.left = s.x+'px'; el.style.top = s.y+'px';
        el.dataset.idx = i;
        el.title = `–°–ª–æ—Ç ${i+1} ‚Ä¢ –ª–∏–º–∏—Ç —É—Ä–æ–≤–Ω—è: ${s.max}`;
        el.textContent = s.max;
        el.addEventListener('click',()=>openTowerModal(i));
        board.appendChild(el);
    });
}
function towerAt(i){ return st.towers[i]||null; }

/* ======== –ë–ê–®–ù–Ø/–°–¢–ê–¢–´/–°–¢–û–ò–ú–û–°–¢–ò ======== */
function sumLevel(comps){ return comps.reduce((a,c)=>a+c.level,0); }
function countL4(comps){ return comps.filter(c=>c.level===4).length; }

function calcStats(comps){
    const s = {...BASE_TOWER};
    for(const c of comps){
        const m = LEVELS[c.level].multi;
        if (TYPES[c.type].stat==='rld') s.rld = s.rld / m; else s[TYPES[c.type].stat]*=m;
    }
    return s;
}
function placeCost(levelSum){
    return PLACE_BASE_COST * Math.max(1, levelSum);
}
function addComponentCost(tower, comp){
    const base = LEVELS[comp.level].cost;
    const count = tower.comps.length;
    const progressive = 1 + count*2; // 1,3,5,7,...
    let mult = progressive;
    const futureL4s = countL4(tower.comps) + (comp.level===4?1:0);
    if (futureL4s===2) mult *= SECOND_L4_MULT;
    if (futureL4s===3) mult *= THIRD_L4_MULT;
    return Math.round(base * mult);
}

/* ======== –í–ù–£–¢–†–ï–ù–ù–ï–ï –°–õ–ò–Ø–ù–ò–ï –ê–ü–ì–†–ï–ô–î–û–í –í –ë–ê–®–ù–ï ======== */
function compactTowerUpgrades(tower){
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ type+level –∏ —Å–ª–∏–≤–∞–µ–º —Ç—Ä–æ–π–∫–∏ L1‚ÜíL2 –∏ L2‚ÜíL3.
    let changed = true;
    while(changed){
        changed = false;
        for(const tp of Object.keys(TYPES)){
            for(const lv of [1,2]){ // —Ç–æ–ª—å–∫–æ 1 –∏ 2
                const key = tp+'_'+lv;
                const idxs = [];
                for(let i=0;i<tower.comps.length;i++){
                    const c=tower.comps[i];
                    if(c.type===tp && c.level===lv) idxs.push(i);
                }
                if(idxs.length>=3){
                    // —É–¥–∞–ª—è–µ–º 3 (—Å –∫–æ–Ω—Ü–∞), –¥–æ–±–∞–≤–ª—è–µ–º 1 —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
                    const rem = idxs.slice(-3).sort((a,b)=>b-a);
                    rem.forEach(i=>tower.comps.splice(i,1));
                    tower.comps.push({type:tp, level:lv+1});
                    changed = true;
                }
            }
        }
    }
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º–∞—Ä–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∏ —Å—Ç–∞—Ç—ã
    tower.level = sumLevel(tower.comps);
    tower.stats = calcStats(tower.comps);
}

/* ======== –ò–ù–í–ï–ù–¢–ê–†–¨ –ò –ö–û–ú–ë–ò–ù–ò–†–û–í–ê–ù–ò–ï ======== */
const invWrap = $("#inv");
let invSel = -1;

function renderInv(){
    invWrap.innerHTML='';
    st.inv.forEach((c, i)=>{
        const d = document.createElement('div');
        d.className='comp '+(invSel===i?'sel':'')+' lvl'+c.level;
        d.innerHTML = `<div><b>${TYPES[c.type].icon} ${TYPES[c.type].name}</b><span class="badge">L${c.level}</span></div>
                       <div class="small">–ë–æ–Ω—É—Å: ${LEVELS[c.level].multi.toFixed(2)}√ó –∫ ${ruStat(TYPES[c.type].stat)}</div>`;
        d.addEventListener('click',()=>{ invSel = (invSel===i?-1:i); renderInv(); if(modal.style.display==='flex') updateModalCosts(); });
        invWrap.appendChild(d);
    });
}
function ruStat(k){ return {dmg:'—É—Ä–æ–Ω—É', rld:'–ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–µ (–º–µ–Ω—å—à–µ ‚Äî –±—ã—Å—Ç—Ä–µ–µ)', rng:'–¥–∞–ª—å–Ω–æ—Å—Ç–∏', proj:'—Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–Ω–∞—Ä—è–¥–∞'}[k]; }

$("#combine").addEventListener('click', ()=>{
    const map = {};
    st.inv.forEach((c,idx)=>{ const key=c.type+'_'+c.level; (map[key]??=[]).push(idx); });
    let upgraded=false;
    for(const tp of Object.keys(TYPES)){
        const k=tp+'_1';
        if(map[k] && map[k].length>=3){
            const idxs=map[k].splice(0,3).sort((a,b)=>b-a);
            idxs.forEach(i=>st.inv.splice(i,1));
            st.inv.push({type:tp, level:2});
            upgraded=true; break;
        }
    }
    if(!upgraded){
        for(const tp of Object.keys(TYPES)){
            const k=tp+'_2';
            if(map[k] && map[k].length>=5){
                const idxs=map[k].splice(0,5).sort((a,b)=>b-a);
                idxs.forEach(i=>st.inv.splice(i,1));
                st.inv.push({type:tp, level:3});
                upgraded=true; break;
            }
        }
    }
    toast(upgraded?'–ö–æ–º–±–∏–Ω–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞':'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ –¥–ª—è –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏');
    invSel=-1; renderInv(); if(modal.style.display==='flex') updateModalCosts();
});

$("#newComp").addEventListener('click', ()=>{
    const price=25;
    if(st.money<price){ toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥'); return; }
    st.money-=price;
    const keys=Object.keys(TYPES); const tp=keys[(Math.random()*keys.length)|0];
    st.inv.push({type:tp, level:1});
    updateHUD(); renderInv(); if(modal.style.display==='flex') updateModalCosts();
});

/* ======== –û–¢–†–ò–°–û–í–ö–ê –ë–ê–®–ï–ù –ò –ú–û–î–ê–õ–ö–ê ======== */
function renderTowers(){
    $$(".tower").forEach(e=>e.remove());
    SLOTS.forEach((s,i)=>{
        const t = st.towers[i]; if(!t) return;
        const el = document.createElement('div');
        el.className='tower'; el.style.left=s.x+'px'; el.style.top=s.y+'px';
        el.title=`–ë–∞—à–Ω—è L${t.level}  –£—Ä–æ–Ω:${t.stats.dmg.toFixed(1)}  –î–∞–ª:${t.stats.rng.toFixed(0)}  –ö–î:${t.stats.rld.toFixed(2)}—Å  –ü—É–ª—è:${t.stats.proj.toFixed(0)}`;
        board.appendChild(el);
    });
    SLOTS.forEach((s,i)=>{
        const slotEl = document.querySelector(`.slot[data-idx="${i}"]`);
        const t = st.towers[i];
        if(t && t.level>=s.max) slotEl.classList.add('max'); else slotEl.classList.remove('max');
    });
}

const modal = $("#modal"), mTitle=$("#mTitle"), mStats=$("#mStats"), mList=$("#mList"), mCosts=$("#mCosts");
$("#mClose").addEventListener('click',()=>modal.style.display='none');

function openTowerModal(slotIdx){
    const slot = SLOTS[slotIdx];
    let t = st.towers[slotIdx];
    mList.innerHTML=''; mCosts.innerHTML='';
    if(!t){
        mTitle.textContent = `–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞—à–Ω–∏ (—Å–ª–æ—Ç ${slotIdx+1}, –ª–∏–º–∏—Ç ${slot.max})`;
        const choose = document.createElement('div');
        choose.className='small';
        choose.textContent='–í—ã–¥–µ–ª–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –∏ –ø–æ—Å—Ç–∞–≤—å—Ç–µ –±–∞—à–Ω—é. –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –ø–æ–∑–∂–µ. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: —Å—É–º–º–∞ —É—Ä–æ–≤–Ω–µ–π –∞–ø–≥—Ä–µ–π–¥–æ–≤ ‚â§ –ª–∏–º–∏—Ç–∞ —Å–ª–æ—Ç–∞.';
        mList.appendChild(choose);

        const btn = document.createElement('button');
        btn.id = 'btnPlace';
        btn.textContent='–ü–æ—Å—Ç–∞–≤–∏—Ç—å (–∏–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ)';
        btn.addEventListener('click', ()=>{
            if(invSel<0){ toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–¥–µ–ª–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ'); return; }
            const comp = st.inv[invSel];
            if(comp.level>slot.max){ toast('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —É—Ä–æ–≤–Ω—è —Å–ª–æ—Ç–∞'); return; }
            const lvl = comp.level;
            const cost = placeCost(lvl);
            if(st.money<cost){ toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥'); return; }
            st.money-=cost; const c = st.inv.splice(invSel,1)[0]; invSel=-1; renderInv();
            t = { comps:[c], level:lvl, stats: calcStats([c]), lastShot:0 };
            st.towers[slotIdx]=t; renderTowers(); updateHUD();
            toast(`–ë–∞—à–Ω—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –°–ø–∏—Å–∞–Ω–æ ${cost}üí∞`);
            modal.style.display='none';
        });
        mList.appendChild(btn);
        updateModalCosts = function(){
            const btn = $("#btnPlace");
            if(invSel<0){ mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏</div><div class="cost">‚Äî</div></div>`; return; }
            const comp = st.inv[invSel];
            if(comp.level>slot.max){
                mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏</div><div class="cost">–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (–ª–∏–º–∏—Ç ${slot.max})</div></div>`;
            }else{
                const cost = placeCost(comp.level);
                mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏</div><div class="cost">üí∞ ${fmt(cost)}</div></div>`;
            }
        };
        updateModalCosts();
    } else {
        mTitle.textContent = `–ë–∞—à–Ω—è (—Å–ª–æ—Ç ${slotIdx+1}) ‚Ä¢ —É—Ä–æ–≤–µ–Ω—å ${t.level}/${slot.max}`;
        mStats.innerHTML = `
            <div>–£—Ä–æ–Ω</div><div class="pill">${t.stats.dmg.toFixed(1)}</div>
            <div>–î–∞–ª—å–Ω–æ—Å—Ç—å</div><div class="pill">${t.stats.rng.toFixed(0)} px</div>
            <div>–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞</div><div class="pill">${t.stats.rld.toFixed(2)} —Å</div>
            <div>–°–∫–æ—Ä–æ—Å—Ç—å —Å–Ω–∞—Ä—è–¥–∞</div><div class="pill">${t.stats.proj.toFixed(0)} px/—Å</div>
        `;

        const hint = document.createElement('div');
        hint.className='small'; hint.style.margin='8px 0';
        hint.innerHTML='–í—ã–¥–µ–ª–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞—à–Ω—é¬ª. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: <b>—Å—É–º–º–∞ —É—Ä–æ–≤–Ω–µ–π –∞–ø–≥—Ä–µ–π–¥–æ–≤ ‚â§ –ª–∏–º–∏—Ç–∞ —Å–ª–æ—Ç–∞</b>. –í–Ω—É—Ç—Ä–∏ –±–∞—à–Ω–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–≤—Ç–æ—Å–ª–∏—è–Ω–∏–µ: 3√óL1‚ÜíL2, 3√óL2‚ÜíL3.';
        mList.appendChild(hint);

        const btnAdd = document.createElement('button');
        btnAdd.id='btnAdd';
        btnAdd.textContent='–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞—à–Ω—é (–∏–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ)';
        btnAdd.addEventListener('click', ()=>{
            if(invSel<0){ toast('–í—ã–¥–µ–ª–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ'); return; }
            const c = st.inv[invSel];
            const newLevel = t.level + c.level;
            if(newLevel>slot.max){ toast('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —É—Ä–æ–≤–Ω—è —Å–ª–æ—Ç–∞'); return; }
            const cost = addComponentCost(t, c);
            if(st.money<cost){ toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥'); return; }
            st.money-=cost; st.inv.splice(invSel,1); invSel=-1; renderInv();
            t.comps.push(c);
            // –∞–≤—Ç–æ—Å–ª–∏—è–Ω–∏–µ
            compactTowerUpgrades(t);
            renderTowers(); updateHUD();
            toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${TYPES[c.type].name} L${c.level} (—Å—Ç–æ–∏–º–æ—Å—Ç—å ${cost}üí∞)`);
            modal.style.display='none';
        });
        mList.appendChild(btnAdd);

        const list = document.createElement('div');
        list.style.marginTop='8px'; list.className='small';
        list.innerHTML = '<div style="margin:6px 0">–¢–µ–∫—É—â–∏–µ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–∏:</div>' + (t.comps.length? t.comps.map(c=>`‚Ä¢ ${TYPES[c.type].name} L${c.level}`).join('<br>'):'‚Äî');
        mList.appendChild(list);

        updateModalCosts = function(){
            if(invSel<0){
                mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è</div><div class="cost">‚Äî</div></div>`;
                return;
            }
            const c = st.inv[invSel];
            const newLevel = t.level + c.level;
            if(newLevel>slot.max){
                mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è</div><div class="cost">–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (–ª–∏–º–∏—Ç ${slot.max})</div></div>`;
            }else{
                const cost = addComponentCost(t, c);
                mCosts.innerHTML = `<div class="costline"><div>–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è</div><div class="cost">üí∞ ${fmt(cost)}</div></div>`;
            }
        };
        updateModalCosts();
    }
    modal.style.display='flex';
}
let updateModalCosts = ()=>{};

/* ======== –í–†–ê–ì–ò –ò –°–ù–ê–†–Ø–î–´ ======== */
function spawnEnemy(hp, speedPx, reward){
    const e = { d:0, hp, max:hp, sp:speedPx, money:reward, dead:false, el:null };
    const p = pointAt(0);
    e.x=p.x; e.y=p.y;
    st.enemies.push(e); st.left++; updateHUD();
    const el = document.createElement('div'); el.className='enemy';
    const hpEl = document.createElement('div'); hpEl.className='hp'; const i = document.createElement('i'); hpEl.appendChild(i); el.appendChild(hpEl);
    board.appendChild(el); e.el = el;
}
function killEnemy(e, reward=true){
    if(e.dead) return;
    e.dead = true;
    e.el && e.el.remove();
    st.enemies = st.enemies.filter(x=>x!==e);
    st.left = Math.max(0, st.left-1);
    if(reward){ st.money += e.money; }
    updateHUD();
}
function enemyReachedEnd(e){
    killEnemy(e, false);
    st.lives -= 1;
    updateHUD();
    if(st.lives<=0){ gameOver(false); }
}

function spawnWave(){
    if(st.spawning || st.enemies.length>0){ return; }
    st.wave++; const w = waveConfig(st.wave);
    st.total = w.count; st.left = 0; st.spawning = true; updateHUD();
    let spawned=0;
    const int = setInterval(()=>{
        spawnEnemy(w.hp, w.speed, w.money);
        spawned++;
        if(spawned>=w.count){ clearInterval(int); st.spawning=false; }
    }, 420);
}

/* ======== –ì–ï–ô–ú–õ–£–ü ======== */
function updateHUD(){
    $("#money").textContent = fmt(st.money);
    $("#lives").textContent = fmt(st.lives);
    $("#wave").textContent  = fmt(st.wave);
    $("#left").textContent  = fmt(st.left);
    $("#total").textContent = fmt(st.total);
    const canStart = (!st.spawning && st.enemies.length===0);
    $("#start").classList.toggle('bd', !canStart);
}

function step(ts){
    const dt = Math.min(0.05, (ts - st.lastTs)/1000);
    st.lastTs = ts;

    // ENEMIES
    for(const e of st.enemies){
        if(e.dead) continue;
        e.d += e.sp * dt;
        if(e.d >= st.pathLen-1){ enemyReachedEnd(e); continue; }
        const p = pointAt(e.d);
        e.x=p.x; e.y=p.y;
        if(e.el){
            e.el.style.left = e.x+'px';
            e.el.style.top  = e.y+'px';
            const ratio = Math.max(0, e.hp)/e.max;
            const bar = e.el.querySelector('.hp>i'); if(bar) bar.style.width=(ratio*22)+'px';
        }
    }

    // TOWERS SHOOT
    const now = ts/1000;
    SLOTS.forEach((s,i)=>{
        const t = st.towers[i]; if(!t) return;
        if(!t.lastShot) t.lastShot=0;
        if(now - t.lastShot < t.stats.rld) return;

        let tgt=null, best=1e9;
        for(const e of st.enemies){
            const dx=e.x-s.x, dy=e.y-s.y; const d=Math.hypot(dx,dy);
            if(d<=t.stats.rng && d<best){ best=d; tgt=e; }
        }
        if(tgt){
            const pr = { x:s.x, y:s.y, v:t.stats.proj, dmg:t.stats.dmg, tgt:tgt, dead:false, el:null };
            const pel = document.createElement('div'); pel.className='proj'; board.appendChild(pel); pr.el=pel;
            st.projs.push(pr);
            t.lastShot = now;
        }
    });

    // PROJECTILES
    for(const p of st.projs){
        if(p.dead){ p.el && p.el.remove(); continue; }
        if(!p.tgt || p.tgt.dead){ p.dead=true; p.el && p.el.remove(); continue; }
        const dx = p.tgt.x - p.x, dy = p.tgt.y - p.y;
        const dist = Math.hypot(dx,dy);
        const mv = p.v * dt;
        if(dist <= mv){
            p.tgt.hp -= p.dmg;
            p.dead = true; p.el && p.el.remove();
            if(p.tgt.hp<=0){ killEnemy(p.tgt,true); }
        } else {
            p.x += dx/dist * mv; p.y += dy/dist * mv;
            p.el.style.left=p.x+'px'; p.el.style.top=p.y+'px';
        }
    }
    st.projs = st.projs.filter(pr=>!pr.dead);

    // WAVE END
    if(!st.spawning && st.enemies.length===0 && st.total>0 && st.left===0){
        const bonus = 50 + st.wave*12;
        st.money += bonus; updateHUD();
        dropComponentsAfterWave();
        st.total = 0;
        toast(`–í–æ–ª–Ω–∞ ${st.wave} –ø—Ä–æ–π–¥–µ–Ω–∞! –ë–æ–Ω—É—Å +${bonus}üí∞`);
    }

    requestAnimationFrame(step);
}

/* ======== –î–†–û–ü –†–ê–°–•–û–î–ù–ò–ö–û–í –ü–û–°–õ–ï –í–û–õ–ù–´ ======== */
function dropComponentsAfterWave(){
    [1,2,3,4].forEach(lvl=>{
        if(Math.random() < LEVELS[lvl].drop){
            const keys=Object.keys(TYPES); const tp=keys[(Math.random()*keys.length)|0];
            st.inv.push({type:tp, level:lvl});
        }
    });
    renderInv();
}

/* ======== GAME CONTROL ======== */
function gameOver(victory){
    toast(victory?'–ü–æ–±–µ–¥–∞!':'–ü–æ—Ä–∞–∂–µ–Ω–∏–µ!');
    st.spawning=false;
    st.enemies.forEach(e=>e.el&&e.el.remove());
    st.projs.forEach(p=>p.el&&p.el.remove());
    st.enemies=[]; st.projs=[];
    updateHUD();
}
$("#start").addEventListener('click', ()=>{ if($("#start").classList.contains('bd')) return; spawnWave(); });
$("#reset").addEventListener('click', newGame);

/* ======== –°–¢–ê–†–¢/–°–ë–†–û–° –ò–ì–†–´ ======== */
function newGame(){
    st.money = 150; st.lives = 20; st.wave = 0;
    st.enemies.forEach(e=>e.el&&e.el.remove()); st.enemies=[];
    st.projs.forEach(p=>p.el&&p.el.remove()); st.projs=[];
    st.towers = [];
    st.inv = [];
    st.total=0; st.left=0; st.spawning=false;
    const keys=Object.keys(TYPES);
    for(let i=0;i<3;i++){
        const tp = keys[(Math.random()*keys.length)|0];
        st.inv.push({type:tp, level:1});
    }
    renderInv(); renderTowers(); updateHUD();
    toast('–ù–æ–≤–∞—è –∏–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞');
}

/* ======== –ü–ï–†–í–û–ù–ê–ß–ê–õ–¨–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======== */
drawSlots();
newGame();
requestAnimationFrame(step);

/* ======== –ú–û–ë–ò–õ–¨–ù–´–ï –ú–ï–õ–û–ß–ò ======== */
window.addEventListener('resize', ()=>{ /* –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π layout –±–µ–∑ –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç–∞ –ø—É—Ç–∏ */ });
document.addEventListener('visibilitychange', ()=>{ st.lastTs = performance.now(); });
</script>
</body>
</html>
