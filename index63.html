<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P –ú–æ–Ω–æ–ø–æ–ª–∏—è (4 –∏–≥—Ä–æ–∫–∞)</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    #lobby, #game {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    .cell {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      background: #fff;
      border-radius: 5px;
    }
    .property {
      background: #e3f2fd;
    }
    .player {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin: 2px auto;
    }
    #players {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
    }
    .player-panel {
      padding: 10px;
      border-radius: 5px;
      width: 22%;
    }
    #dice {
      font-size: 24px;
      margin: 10px 0;
    }
    #log {
      height: 100px;
      overflow-y: scroll;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="lobby">
    <h1>üè¶ P2P –ú–æ–Ω–æ–ø–æ–ª–∏—è (4 –∏–≥—Ä–æ–∫–∞)</h1>
    <button id="createBtn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
    <div id="activeGames"></div>
  </div>

  <div id="game" style="display: none;">
    <h2 id="gameTitle">–ú–æ–Ω–æ–ø–æ–ª–∏—è</h2>
    <div id="players"></div>
    <div id="dice">üé≤ –ë—Ä–æ—Å–æ–∫: -</div>
    <button id="rollBtn">–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫</button>
    <button id="buyBtn" disabled>–ö—É–ø–∏—Ç—å —É–ª–∏—Ü—É</button>
    <div id="board"></div>
    <div id="log"></div>
  </div>

  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    // ===== –ö–û–ù–§–ò–ì =====
    const peer = new Peer();
    const players = {};
    let isHost = false;
    let gameConnections = [];
    let currentPlayerId = null;
    let diceRoll = 0;
    let myPlayerId = null;
    let myPosition = 0;
    let gameStarted = false;

    // –£–ø—Ä–æ—â—ë–Ω–Ω–æ–µ –ø–æ–ª–µ (8 –∫–ª–µ—Ç–æ–∫ –≤–º–µ—Å—Ç–æ 40)
    const board = [
      { type: 'start', name: '–°—Ç–∞—Ä—Ç', price: 0 },
      { type: 'property', name: '–£–ª. –ü—É—à–∫–∏–Ω–∞', price: 60, owner: null, rent: 10 },
      { type: 'property', name: '–ü—Ä. –ì–∞–≥–∞—Ä–∏–Ω–∞', price: 80, owner: null, rent: 15 },
      { type: 'chance', name: '–®–∞–Ω—Å' },
      { type: 'property', name: '–£–ª. –õ–µ–Ω–∏–Ω–∞', price: 100, owner: null, rent: 20 },
      { type: 'property', name: '–ü—Ä. –ú–∏—Ä–∞', price: 120, owner: null, rent: 25 },
      { type: 'jail', name: '–¢—é—Ä—å–º–∞' },
      { type: 'property', name: '–£–ª. –°–∞–¥–æ–≤–∞—è', price: 140, owner: null, rent: 30 }
    ];

    // –¶–≤–µ—Ç–∞ –∏–≥—Ä–æ–∫–æ–≤
    const playerColors = ['#FF5252', '#4CAF50', '#2196F3', '#FFC107'];

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const lobby = document.getElementById('lobby');
    const gameDiv = document.getElementById('game');
    const playersDiv = document.getElementById('players');
    const boardDiv = document.getElementById('board');
    const diceDiv = document.getElementById('dice');
    const rollBtn = document.getElementById('rollBtn');
    const buyBtn = document.getElementById('buyBtn');
    const logDiv = document.getElementById('log');
    const activeGames = document.getElementById('activeGames');

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
    peer.on('open', (id) => {
      myPlayerId = id;
      console.log('–ú–æ–π ID:', id);
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã (–•–æ—Å—Ç)
    document.getElementById('createBtn').addEventListener('click', () => {
      isHost = true;
      lobby.style.display = 'none';
      gameDiv.style.display = 'block';
      
      // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (—Ö–æ—Å—Ç)
      players[myPlayerId] = {
        id: myPlayerId,
        name: '–ò–≥—Ä–æ–∫ 1',
        money: 1500,
        position: 0,
        color: playerColors[0],
        active: true
      };
      
      currentPlayerId = myPlayerId;
      updateGameUI();
      
      // –û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
      peer.on('connection', (conn) => {
        if (Object.keys(players).length >= 4) {
          conn.send({ type: 'error', message: '–ò–≥—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞' });
          return;
        }

        gameConnections.push(conn);
        
        conn.on('data', (data) => handleGameData(conn, data));
        
        conn.on('open', () => {
          const playerId = conn.peer;
          const playerNum = Object.keys(players).length;
          players[playerId] = {
            id: playerId,
            name: `–ò–≥—Ä–æ–∫ ${playerNum + 1}`,
            money: 1500,
            position: 0,
            color: playerColors[playerNum],
            active: true
          };
          
          broadcast({
            type: 'game_state',
            players,
            currentPlayerId,
            board
          });
          
          // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –ø—Ä–∏ 2+ –∏–≥—Ä–æ–∫–∞—Ö
          if (isHost && Object.keys(players).length >= 2 && !gameStarted) {
            gameStarted = true;
            broadcast({ type: 'game_start' });
            addLog('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –•–æ–¥: ' + players[currentPlayerId].name);
          }
        });
      });
      
      // –î–ª—è –¥–µ–º–æ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø—É–±–ª–∏—á–Ω—É—é" –∏–≥—Ä—É
      activeGames.innerHTML = `
        <div class="game">
          <h3>–ò–≥—Ä–∞ –æ—Ç ${myPlayerId.slice(0, 5)}...</h3>
          <p>–ò–≥—Ä–æ–∫–æ–≤: 1/4</p>
          <button onclick="connectToGame('${myPlayerId}')">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
      `;
    });

    // ===== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
    function handleGameData(conn, data) {
      switch (data.type) {
        case 'game_state':
          Object.assign(players, data.players);
          currentPlayerId = data.currentPlayerId;
          Object.assign(board, data.board);
          updateGameUI();
          break;
          
        case 'dice_rolled':
          diceRoll = data.value;
          const player = players[data.playerId];
          player.position = (player.position + diceRoll) % board.length;
          myPosition = (data.playerId === myPlayerId) ? player.position : myPosition;
          
          diceDiv.textContent = `üé≤ –ë—Ä–æ—Å–æ–∫: ${diceRoll}`;
          addLog(`${player.name} –±—Ä–æ—Å–∏–ª ${diceRoll} –∏ –ø–æ–ø–∞–ª –Ω–∞ ${board[player.position].name}`);
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—É–ø–∫–∏
          if (data.playerId === myPlayerId && board[player.position].type === 'property' && !board[player.position].owner) {
            buyBtn.disabled = false;
          }
          
          // –û–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã
          if (board[player.position].owner && board[player.position].owner !== data.playerId) {
            const owner = players[board[player.position].owner];
            players[data.playerId].money -= board[player.position].rent;
            players[owner].money += board[player.position].rent;
            addLog(`${player.name} –ø–ª–∞—Ç–∏—Ç –∞—Ä–µ–Ω–¥—É ${board[player.position].rent}$ –∏–≥—Ä–æ–∫—É ${players[owner].name}`);
          }
          
          // –ü–µ—Ä–µ–¥–∞—á–∞ —Ö–æ–¥–∞
          if (isHost) {
            const playerIds = Object.keys(players);
            const currentIndex = playerIds.indexOf(data.playerId);
            currentPlayerId = playerIds[(currentIndex + 1) % playerIds.length];
            broadcast({
              type: 'player_turn',
              playerId: currentPlayerId
            });
          }
          break;
          
        case 'property_bought':
          board[data.cellIndex].owner = data.playerId;
          players[data.playerId].money -= board[data.cellIndex].price;
          addLog(`${players[data.playerId].name} –∫—É–ø–∏–ª ${board[data.cellIndex].name}`);
          break;
          
        case 'player_turn':
          currentPlayerId = data.playerId;
          addLog(`–¢–µ–ø–µ—Ä—å —Ö–æ–¥: ${players[currentPlayerId].name}`);
          if (currentPlayerId === myPlayerId) {
            rollBtn.disabled = false;
          } else {
            rollBtn.disabled = true;
          }
          break;
      }
      updateGameUI();
    }

    function broadcast(message) {
      gameConnections.forEach(conn => conn.send(message));
    }

    function updateGameUI() {
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –∏–≥—Ä–æ–∫–æ–≤
      playersDiv.innerHTML = Object.values(players).map(player => `
        <div class="player-panel" style="border: 2px solid ${player.id === currentPlayerId ? 'black' : 'transparent'}">
          <h3>${player.name}</h3>
          <p>üí∞ ${player.money}$</p>
          <div class="player" style="background: ${player.color}"></div>
        </div>
      `).join('');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ
      boardDiv.innerHTML = board.map((cell, index) => `
        <div class="cell ${cell.type === 'property' ? 'property' : ''}" style="
          border: 2px solid ${cell.owner ? players[cell.owner]?.color || '#ddd' : '#ddd'};
        ">
          <h4>${cell.name}</h4>
          ${cell.type === 'property' ? `<p>–¶–µ–Ω–∞: ${cell.price}$</p>` : ''}
          ${cell.type === 'property' ? `<p>–ê—Ä–µ–Ω–¥–∞: ${cell.rent}$</p>` : ''}
          ${getPlayersOnCell(index)}
        </div>
      `).join('');
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞
      Object.values(players).forEach(player => {
        if (player.money <= 0) {
          addLog(`üõë ${player.name} –æ–±–∞–Ω–∫—Ä–æ—Ç–∏–ª—Å—è!`);
          player.active = false;
        }
      });
    }

    function getPlayersOnCell(cellIndex) {
      return Object.values(players)
        .filter(p => p.position === cellIndex)
        .map(p => `<div class="player" style="background: ${p.color}"></div>`)
        .join('');
    }

    function addLog(message) {
      logDiv.innerHTML += `<p>${message}</p>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // ===== –ò–ì–†–û–í–´–ï –î–ï–ô–°–¢–í–ò–Ø =====
    rollBtn.addEventListener('click', () => {
      if (currentPlayerId !== myPlayerId) return;
      
      const roll = Math.floor(Math.random() * 6) + 1;
      diceRoll = roll;
      rollBtn.disabled = true;
      
      broadcast({
        type: 'dice_rolled',
        playerId: myPlayerId,
        value: roll
      });
    });

    buyBtn.addEventListener('click', () => {
      if (currentPlayerId !== myPlayerId) return;
      
      const currentCell = board[myPosition];
      if (currentCell.type !== 'property' || currentCell.owner) return;
      
      broadcast({
        type: 'property_bought',
        playerId: myPlayerId,
        cellIndex: myPosition
      });
      
      buyBtn.disabled = true;
    });

    // ===== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ò–ì–†–ï =====
    window.connectToGame = (hostId) => {
      const conn = peer.connect(hostId);
      lobby.style.display = 'none';
      gameDiv.style.display = 'block';
      
      conn.on('data', (data) => handleGameData(conn, data));
      
      conn.on('open', () => {
        gameConnections.push(conn);
        addLog('–í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ!');
      });
    };
  </script>
</body>
</html>
