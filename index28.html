<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –í–æ–π–Ω–∞</title>
    <style>
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a2e;
            color: #e6e6e6;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%231a1a2e"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%2326264d" stroke-width="0.5"/></svg>');
            background-size: 40px 40px;
        }

        #world-map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .location {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }

        .location:hover {
            transform: scale(1.1);
        }

        #village {
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4ecca3;
            color: #1a1a2e;
        }

        #forest {
            top: 30%;
            left: 20%;
            background-color: #2e8b57;
            color: #e6e6e6;
        }

        #mountains {
            top: 15%;
            right: 15%;
            background-color: #8b4513;
            color: #e6e6e6;
        }

        #lake {
            bottom: 25%;
            right: 20%;
            background-color: #4682b4;
            color: #e6e6e6;
        }

        #cave {
            bottom: 10%;
            left: 20%;
            background-color: #4b0082;
            color: #e6e6e6;
        }

        .note-enemy {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            z-index: 5;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.7));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .note-lvl1 { background-color: #ff6b6b; }
        .note-lvl2 { background-color: #ffa502; }
        .note-lvl3 { background-color: #ffd166; }
        .note-lvl4 { background-color: #06d6a0; }
        .note-lvl5 { background-color: #118ab2; }

        #ui-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background-color: rgba(26, 26, 46, 0.9);
            border-top: 2px solid #4ecca3;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
            z-index: 100;
        }

        .currency {
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .currency-icon {
            width: 24px;
            height: 24px;
            margin-right: 5px;
            background-color: #4ecca3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        #player-stats {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(26, 26, 46, 0.8);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #4ecca3;
            z-index: 100;
        }

        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1a1a2e;
            border: 2px solid #4ecca3;
            border-radius: 10px;
            padding: 20px;
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            text-align: center;
            display: none;
        }

        .modal h2 {
            color: #4ecca3;
            margin-bottom: 15px;
        }

        .modal button {
            background-color: #4ecca3;
            color: #1a1a2e;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .modal button:hover {
            background-color: #3dbb90;
        }

        .note-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
        }

        .note-option {
            background-color: #4ecca3;
            color: #1a1a2e;
            border: none;
            padding: 8px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            min-width: 60px;
            font-weight: bold;
        }

        .note-option:hover {
            background-color: #3dbb90;
        }

        #note-guess-modal {
            display: none;
        }

        #shop-modal {
            display: none;
        }

        #musician-modal {
            display: none;
        }

        #chord-modal {
            display: none;
        }

        .progress-container {
            width: 100%;
            background-color: #2d2d4d;
            border-radius: 5px;
            margin: 10px 0;
        }

        .progress-bar {
            height: 20px;
            background-color: #4ecca3;
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #1a1a2e;
        }

        @media (max-width: 600px) {
            .location {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .note-enemy {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }

            #ui-panel {
                height: 80px;
                font-size: 12px;
            }

            .currency-icon {
                width: 20px;
                height: 20px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="world-map">
            <!-- –î–µ—Ä–µ–≤–Ω—è -->
            <div id="village" class="location">üèòÔ∏è</div>
            
            <!-- –õ–æ–∫–∞—Ü–∏–∏ —Å –Ω–æ—Ç–∞–º–∏-–≤—Ä–∞–≥–∞–º–∏ -->
            <div id="forest" class="location">üå≤</div>
            <div id="mountains" class="location">‚õ∞Ô∏è</div>
            <div id="lake" class="location">üåä</div>
            <div id="cave" class="location">üï≥Ô∏è</div>
            
            <!-- –ù–æ—Ç—ã-–≤—Ä–∞–≥–∏ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞ -->
        <div id="player-stats">
            <div class="currency">
                <div class="currency-icon">‚ô™</div>
                <span id="sound-coins">0</span>
            </div>
            <div class="currency">
                <div class="currency-icon">‚ô´</div>
                <span id="echo-coins">0</span>
            </div>
            <div class="currency">
                <div class="currency-icon">‚ô¨</div>
                <span id="note-coins">0</span>
            </div>
            <div class="currency">
                <div class="currency-icon">üéµ</div>
                <span id="step-coins">0</span>
            </div>
        </div>
        
        <!-- UI –ø–∞–Ω–µ–ª—å -->
        <div id="ui-panel">
            <button id="btn-shop">–ú–∞–≥–∞–∑–∏–Ω –Ω–æ—Ç</button>
            <button id="btn-musician">–ú–µ—Ä—Ç–≤—ã–π –º—É–∑—ã–∫–∞–Ω—Ç</button>
            <button id="btn-chord">–ê–∫–∫–æ—Ä–¥ —Å—É–¥—å–±—ã</button>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≥–∞–¥—ã–≤–∞–Ω–∏—è –Ω–æ—Ç—ã -->
        <div id="note-guess-modal" class="modal">
            <h2 id="note-guess-title">–£–≥–∞–¥–∞–π—Ç–µ –Ω–æ—Ç—É</h2>
            <p>–£—Ä–æ–≤–µ–Ω—å –Ω–æ—Ç—ã: <span id="note-level">1</span></p>
            <button id="btn-play-note">–ü—Ä–æ—Å–ª—É—à–∞—Ç—å</button>
            <div class="note-options" id="note-options"></div>
            <p id="note-guess-feedback"></p>
            <button id="btn-close-guess">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞–≥–∞–∑–∏–Ω–∞ -->
        <div id="shop-modal" class="modal">
            <h2>–ú–∞–≥–∞–∑–∏–Ω –Ω–æ—Ç</h2>
            <p>–ü—Ä–æ–¥–∞–≤–µ—Ü: "–û–±–º–µ–Ω—è–π—Ç–µ –æ—Ç–≥–æ–ª–æ—Å–∫–∏ –Ω–∞ –Ω–æ—Ç—ã!"</p>
            <div class="currency">
                <div class="currency-icon">‚ô´</div>
                <span id="shop-echo-coins">0</span>
            </div>
            <div class="currency">
                <div class="currency-icon">‚ô¨</div>
                <span id="shop-note-coins">0</span>
            </div>
            <button id="btn-buy-note">–ö—É–ø–∏—Ç—å 1 –Ω–æ—Ç—É (5 –æ—Ç–≥–æ–ª–æ—Å–∫–æ–≤)</button>
            <button id="btn-close-shop">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–µ—Ä—Ç–≤–æ–≥–æ –º—É–∑—ã–∫–∞–Ω—Ç–∞ -->
        <div id="musician-modal" class="modal">
            <h2>–ú–µ—Ä—Ç–≤—ã–π –º—É–∑—ã–∫–∞–Ω—Ç</h2>
            <p>"–°—ã–≥—Ä–∞–µ–º –≤ –∏–≥—Ä—É –Ω–∞ —Å—Ç—É–ø–µ–Ω–∏?"</p>
            <div class="currency">
                <div class="currency-icon">‚ô¨</div>
                <span id="musician-note-coins">0</span>
            </div>
            <div class="currency">
                <div class="currency-icon">üéµ</div>
                <span id="musician-step-coins">0</span>
            </div>
            <button id="btn-play-simple">1 –Ω–æ—Ç–∞ = 1 —Å—Ç—É–ø–µ–Ω—å</button>
            <button id="btn-play-interval">2 –Ω–æ—Ç—ã = 1 —Å—Ç—É–ø–µ–Ω—å (—Ä–∏—Å–∫)</button>
            <button id="btn-play-chord">3 –Ω–æ—Ç—ã = 1 —Å—Ç—É–ø–µ–Ω—å (–±–æ–ª—å—à–æ–π —Ä–∏—Å–∫)</button>
            <div id="musician-game-area" style="margin-top: 15px; display: none;">
                <button id="btn-play-musician">–ü—Ä–æ—Å–ª—É—à–∞—Ç—å</button>
                <div id="musician-options" style="margin-top: 10px;"></div>
                <p id="musician-feedback" style="margin-top: 10px;"></p>
            </div>
            <button id="btn-close-musician">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–∫–∫–æ—Ä–¥–∞ —Å—É–¥—å–±—ã -->
        <div id="chord-modal" class="modal">
            <h2>–ê–∫–∫–æ—Ä–¥ —Å—É–¥—å–±—ã</h2>
            <p>"–û—Å–≤–æ–±–æ–¥–∏—Ç–µ –º–µ–Ω—è, —Å–æ–±—Ä–∞–≤ 300 –Ω–æ—Ç!"</p>
            <div class="progress-container">
                <div class="progress-bar" id="chord-progress">0/300</div>
            </div>
            <button id="btn-close-chord">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const gameState = {
            soundCoins: 0,
            echoCoins: 0,
            noteCoins: 0,
            stepCoins: 0,
            currentNote: null,
            currentNoteLevel: 1,
            attempts: 0,
            musicianGame: null,
            notes: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
            intervals: {
                minorSecond: 1,
                majorSecond: 2,
                minorThird: 3,
                majorThird: 4,
                perfectFourth: 5,
                augmentedFourth: 6,
                perfectFifth: 7,
                minorSixth: 8,
                majorSixth: 9,
                minorSeventh: 10,
                majorSeventh: 11,
                octave: 12
            },
            notePositions: {
                forest: [
                    { x: 20, y: 30 },
                    { x: 35, y: 45 },
                    { x: 10, y: 60 },
                    { x: 40, y: 25 }
                ],
                mountains: [
                    { x: 70, y: 15 },
                    { x: 80, y: 30 },
                    { x: 65, y: 40 }
                ],
                lake: [
                    { x: 75, y: 70 },
                    { x: 65, y: 80 },
                    { x: 85, y: 75 }
                ],
                cave: [
                    { x: 25, y: 85 },
                    { x: 15, y: 90 },
                    { x: 35, y: 88 }
                ]
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            loadGame();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ
            initAudio();
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ—Ç—ã-–≤—Ä–∞–≥–∏
            createNoteEnemies();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º SoundFont
        function initAudio() {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –∑–∞–≥—Ä—É–∑–∫–∞ SoundFont
            // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                gameState.audioContext = new AudioContext();
            } catch(e) {
                alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Web Audio API');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ—Ç-–≤—Ä–∞–≥–æ–≤
        function createNoteEnemies() {
            const locations = ['forest', 'mountains', 'lake', 'cave'];
            
            locations.forEach(location => {
                gameState.notePositions[location].forEach((pos, index) => {
                    const level = Math.min(5, Math.max(1, Math.floor(Math.random() * 5) + 1);
                    createNoteElement(location, pos.x, pos.y, level, index);
                });
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–æ—Ç—ã-–≤—Ä–∞–≥–∞
        function createNoteElement(location, x, y, level, index) {
            const noteElement = document.createElement('div');
            noteElement.className = `note-enemy note-lvl${level}`;
            noteElement.textContent = '‚ô™';
            noteElement.style.left = `${x}%`;
            noteElement.style.top = `${y}%`;
            noteElement.dataset.level = level;
            noteElement.dataset.location = location;
            noteElement.dataset.index = index;
            
            noteElement.addEventListener('click', () => attackNote(noteElement));
            
            document.getElementById('world-map').appendChild(noteElement);
        }

        // –ê—Ç–∞–∫–∞ –Ω–∞ –Ω–æ—Ç—É
        function attackNote(noteElement) {
            const level = parseInt(noteElement.dataset.level);
            gameState.currentNoteLevel = level;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é –Ω–æ—Ç—É
            gameState.currentNote = gameState.notes[Math.floor(Math.random() * gameState.notes.length)];
            gameState.attempts = 0;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–≥–∞–¥—ã–≤–∞–Ω–∏—è
            document.getElementById('note-level').textContent = level;
            document.getElementById('note-guess-feedback').textContent = '';
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞
            generateNoteOptions(level);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('note-guess-modal').style.display = 'block';
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –Ω–æ—Ç—ã
        function generateNoteOptions(level) {
            const optionsContainer = document.getElementById('note-options');
            optionsContainer.innerHTML = '';
            
            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è –Ω–æ—Ç—ã
            const optionsCount = level + 1;
            const options = [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            options.push(gameState.currentNote);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
            while (options.length < optionsCount) {
                const randomNote = gameState.notes[Math.floor(Math.random() * gameState.notes.length)];
                if (!options.includes(randomNote)) {
                    options.push(randomNote);
                }
            }
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
            shuffleArray(options);
            
            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
            options.forEach(note => {
                const button = document.createElement('button');
                button.className = 'note-option';
                button.textContent = note;
                button.addEventListener('click', () => checkNoteGuess(note));
                optionsContainer.appendChild(button);
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≥–∞–¥—ã–≤–∞–Ω–∏—è –Ω–æ—Ç—ã
        function checkNoteGuess(guess) {
            gameState.attempts++;
            
            if (guess === gameState.currentNote) {
                // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                if (gameState.attempts === 1) {
                    // –° –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏ - –ø–æ–ª—É—á–∞–µ–º –∑–≤—É–∫–æ–≤—ã–µ –º–æ–Ω–µ—Ç—ã
                    const reward = gameState.currentNoteLevel;
                    gameState.soundCoins += reward;
                    document.getElementById('note-guess-feedback').textContent = `–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–æ–ª—É—á–µ–Ω–æ ${reward} –∑–≤—É–∫–æ–≤—ã—Ö –º–æ–Ω–µ—Ç.`;
                    document.getElementById('note-guess-feedback').style.color = '#4ecca3';
                } else {
                    // –°–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ø—ã—Ç–∫–∏ - –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≥–æ–ª–æ—Å–∫–∏
                    const reward = gameState.currentNoteLevel;
                    gameState.echoCoins += reward;
                    document.getElementById('note-guess-feedback').textContent = `–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–æ–ª—É—á–µ–Ω–æ ${reward} –æ—Ç–≥–æ–ª–æ—Å–∫–æ–≤.`;
                    document.getElementById('note-guess-feedback').style.color = '#4ecca3';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                updateUI();
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    document.getElementById('note-guess-modal').style.display = 'none';
                }, 1500);
            } else {
                // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                document.getElementById('note-guess-feedback').textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                document.getElementById('note-guess-feedback').style.color = '#ff6b6b';
            }
        }

        // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –Ω–æ—Ç—ã
        function playNote(note, duration = 0.5) {
            if (!gameState.audioContext) return;
            
            const freq = getNoteFrequency(note);
            const oscillator = gameState.audioContext.createOscillator();
            const gainNode = gameState.audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.value = freq;
            
            gainNode.gain.setValueAtTime(0, gameState.audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(1, gameState.audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, gameState.audioContext.currentTime + duration);
            
            oscillator.connect(gainNode);
            gainNode.connect(gameState.audioContext.destination);
            
            oscillator.start();
            oscillator.stop(gameState.audioContext.currentTime + duration);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –Ω–æ—Ç—ã
        function getNoteFrequency(note, octave = 4) {
            const A4 = 440;
            const notesInOctave = 12;
            const noteIndex = gameState.notes.indexOf(note);
            const A4Index = gameState.notes.indexOf('A') + 4 * notesInOctave;
            const targetIndex = noteIndex + octave * notesInOctave;
            
            return A4 * Math.pow(2, (targetIndex - A4Index) / notesInOctave);
        }

        // –ú–∞–≥–∞–∑–∏–Ω –Ω–æ—Ç
        function openShop() {
            document.getElementById('shop-echo-coins').textContent = gameState.echoCoins;
            document.getElementById('shop-note-coins').textContent = gameState.noteCoins;
            document.getElementById('shop-modal').style.display = 'block';
        }

        // –ü–æ–∫—É–ø–∫–∞ –Ω–æ—Ç—ã
        function buyNote() {
            if (gameState.echoCoins >= 5) {
                gameState.echoCoins -= 5;
                gameState.noteCoins += 1;
                updateUI();
                document.getElementById('shop-echo-coins').textContent = gameState.echoCoins;
                document.getElementById('shop-note-coins').textContent = gameState.noteCoins;
            } else {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Ç–≥–æ–ª–æ—Å–∫–æ–≤!');
            }
        }

        // –ú–µ—Ä—Ç–≤—ã–π –º—É–∑—ã–∫–∞–Ω—Ç
        function openMusician() {
            document.getElementById('musician-note-coins').textContent = gameState.noteCoins;
            document.getElementById('musician-step-coins').textContent = gameState.stepCoins;
            document.getElementById('musician-game-area').style.display = 'none';
            document.getElementById('musician-modal').style.display = 'block';
        }

        // –ò–≥—Ä–∞ —Å –º—É–∑—ã–∫–∞–Ω—Ç–æ–º (–ø—Ä–æ—Å—Ç–∞—è)
        function playSimpleGame() {
            if (gameState.noteCoins < 1) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–æ—Ç!');
                return;
            }
            
            gameState.musicianGame = {
                type: 'simple',
                notes: [gameState.notes[Math.floor(Math.random() * gameState.notes.length)]],
                attempts: 0
            };
            
            setupMusicianGame();
        }

        // –ò–≥—Ä–∞ —Å –º—É–∑—ã–∫–∞–Ω—Ç–æ–º (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã)
        function playIntervalGame() {
            if (gameState.noteCoins < 2) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–æ—Ç!');
                return;
            }
            
            const rootIndex = Math.floor(Math.random() * gameState.notes.length);
            const intervalType = Math.random() > 0.5 ? 'minorSecond' : 'majorSecond';
            const interval = gameState.intervals[intervalType];
            const secondNoteIndex = (rootIndex + interval) % gameState.notes.length;
            
            gameState.musicianGame = {
                type: 'interval',
                notes: [gameState.notes[rootIndex], gameState.notes[secondNoteIndex]],
                correctAnswer: intervalType,
                attempts: 0
            };
            
            setupMusicianGame();
        }

        // –ò–≥—Ä–∞ —Å –º—É–∑—ã–∫–∞–Ω—Ç–æ–º (–∞–∫–∫–æ—Ä–¥—ã)
        function playChordGame() {
            if (gameState.noteCoins < 3) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–æ—Ç!');
                return;
            }
            
            const rootIndex = Math.floor(Math.random() * gameState.notes.length);
            const intervalType = Math.random() > 0.5 ? 'minorThird' : 'majorThird';
            const interval = gameState.intervals[intervalType];
            const secondNoteIndex = (rootIndex + interval) % gameState.notes.length;
            const thirdNoteIndex = (secondNoteIndex + interval) % gameState.notes.length;
            
            gameState.musicianGame = {
                type: 'chord',
                notes: [gameState.notes[rootIndex], gameState.notes[secondNoteIndex], gameState.notes[thirdNoteIndex]],
                correctAnswer: intervalType,
                attempts: 0
            };
            
            setupMusicianGame();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–≥—Ä—ã —Å –º—É–∑—ã–∫–∞–Ω—Ç–æ–º
        function setupMusicianGame() {
            const gameArea = document.getElementById('musician-game-area');
            const optionsContainer = document.getElementById('musician-options');
            optionsContainer.innerHTML = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤—É—é –æ–±–ª–∞—Å—Ç—å
            gameArea.style.display = 'block';
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∏–≥—Ä—ã
            if (gameState.musicianGame.type === 'simple') {
                const options = ['–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ', '—Ä–∞–∑–Ω—ã–µ'];
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'note-option';
                    button.textContent = option;
                    button.addEventListener('click', () => checkMusicianGuess(option));
                    optionsContainer.appendChild(button);
                });
            } else if (gameState.musicianGame.type === 'interval') {
                const options = ['–º–∞–ª–∞—è —Å–µ–∫—É–Ω–¥–∞', '–±–æ–ª—å—à–∞—è —Å–µ–∫—É–Ω–¥–∞'];
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'note-option';
                    button.textContent = option;
                    button.addEventListener('click', () => checkMusicianGuess(option));
                    optionsContainer.appendChild(button);
                });
            } else if (gameState.musicianGame.type === 'chord') {
                const options = ['–º–∞–ª–∞—è —Ç–µ—Ä—Ü–∏—è', '–±–æ–ª—å—à–∞—è —Ç–µ—Ä—Ü–∏—è'];
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'note-option';
                    button.textContent = option;
                    button.addEventListener('click', () => checkMusicianGuess(option));
                    optionsContainer.appendChild(button);
                });
            }
            
            document.getElementById('musician-feedback').textContent = '';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ –∏–≥—Ä–µ —Å –º—É–∑—ã–∫–∞–Ω—Ç–æ–º
        function checkMusicianGuess(guess) {
            gameState.musicianGame.attempts++;
            
            let isCorrect = false;
            let reward = 0;
            
            if (gameState.musicianGame.type === 'simple') {
                // –ü—Ä–æ—Å—Ç–∞—è –∏–≥—Ä–∞ - –≤—Å–µ–≥–¥–∞ –≤—ã–∏–≥—Ä—ã–≤–∞–µ–º
                isCorrect = true;
                reward = 1;
                gameState.noteCoins -= 1;
            } else if (gameState.musicianGame.type === 'interval') {
                // –ò–≥—Ä–∞ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
                isCorrect = guess === gameState.musicianGame.correctAnswer.replace('Second', '—Å–µ–∫—É–Ω–¥–∞').replace('Minor', '–º–∞–ª–∞—è').replace('Major', '–±–æ–ª—å—à–∞—è');
                reward = isCorrect ? 1 : -2;
                gameState.noteCoins -= 2;
            } else if (gameState.musicianGame.type === 'chord') {
                // –ò–≥—Ä–∞ —Å –∞–∫–∫–æ—Ä–¥–∞–º–∏
                isCorrect = guess === gameState.musicianGame.correctAnswer.replace('Third', '—Ç–µ—Ä—Ü–∏—è').replace('Minor', '–º–∞–ª–∞—è').replace('Major', '–±–æ–ª—å—à–∞—è');
                reward = isCorrect ? 1 : -3;
                gameState.noteCoins -= 3;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—É–ø–µ–Ω–∏
            if (isCorrect) {
                gameState.stepCoins += reward;
                document.getElementById('musician-feedback').textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–æ–ª—É—á–µ–Ω–∞ 1 —Å—Ç—É–ø–µ–Ω—å.';
                document.getElementById('musician-feedback').style.color = '#4ecca3';
            } else {
                document.getElementById('musician-feedback').textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                document.getElementById('musician-feedback').style.color = '#ff6b6b';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('musician-note-coins').textContent = gameState.noteCoins;
            document.getElementById('musician-step-coins').textContent = gameState.stepCoins;
            updateUI();
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∏–≥—Ä—É —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–∞—è –∏–≥—Ä–∞ –∏–ª–∏ –æ—Ç–≤–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
            if (gameState.musicianGame.type === 'simple' || isCorrect) {
                setTimeout(() => {
                    document.getElementById('musician-game-area').style.display = 'none';
                }, 1500);
            }
        }

        // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –Ω–æ—Ç –≤ –∏–≥—Ä–µ —Å –º—É–∑—ã–∫–∞–Ω—Ç–æ–º
        function playMusicianNotes() {
            if (!gameState.musicianGame) return;
            
            const now = gameState.audioContext.currentTime;
            
            gameState.musicianGame.notes.forEach((note, index) => {
                const oscillator = gameState.audioContext.createOscillator();
                const gainNode = gameState.audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.value = getNoteFrequency(note);
                
                gainNode.gain.setValueAtTime(0, now + index * 0.5);
                gainNode.gain.linearRampToValueAtTime(1, now + index * 0.5 + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + index * 0.5 + 0.5);
                
                oscillator.connect(gainNode);
                gainNode.connect(gameState.audioContext.destination);
                
                oscillator.start(now + index * 0.5);
                oscillator.stop(now + index * 0.5 + 0.5);
            });
        }

        // –ê–∫–∫–æ—Ä–¥ —Å—É–¥—å–±—ã
        function openChord() {
            const progress = Math.min(100, (gameState.noteCoins / 300) * 100);
            document.getElementById('chord-progress').style.width = `${progress}%`;
            document.getElementById('chord-progress').textContent = `${gameState.noteCoins}/300`;
            document.getElementById('chord-modal').style.display = 'block';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        function updateUI() {
            document.getElementById('sound-coins').textContent = gameState.soundCoins;
            document.getElementById('echo-coins').textContent = gameState.echoCoins;
            document.getElementById('note-coins').textContent = gameState.noteCoins;
            document.getElementById('step-coins').textContent = gameState.stepCoins;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä—É
            saveGame();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–≥—Ä—ã
        function saveGame() {
            localStorage.setItem('musicWarGame', JSON.stringify({
                soundCoins: gameState.soundCoins,
                echoCoins: gameState.echoCoins,
                noteCoins: gameState.noteCoins,
                stepCoins: gameState.stepCoins
            }));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã
        function loadGame() {
            const savedGame = localStorage.getItem('musicWarGame');
            if (savedGame) {
                const savedState = JSON.parse(savedGame);
                gameState.soundCoins = savedState.soundCoins || 0;
                gameState.echoCoins = savedState.echoCoins || 0;
                gameState.noteCoins = savedState.noteCoins || 0;
                gameState.stepCoins = savedState.stepCoins || 0;
            }
        }

        // –£—Ç–∏–ª–∏—Ç—ã
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ UI
            document.getElementById('btn-shop').addEventListener('click', openShop);
            document.getElementById('btn-musician').addEventListener('click', openMusician);
            document.getElementById('btn-chord').addEventListener('click', openChord);
            
            // –ö–Ω–æ–ø–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞
            document.getElementById('btn-buy-note').addEventListener('click', buyNote);
            document.getElementById('btn-close-shop').addEventListener('click', () => {
                document.getElementById('shop-modal').style.display = 'none';
            });
            
            // –ö–Ω–æ–ø–∫–∏ –º—É–∑—ã–∫–∞–Ω—Ç–∞
            document.getElementById('btn-play-simple').addEventListener('click', playSimpleGame);
            document.getElementById('btn-play-interval').addEventListener('click', playIntervalGame);
            document.getElementById('btn-play-chord').addEventListener('click', playChordGame);
            document.getElementById('btn-play-musician').addEventListener('click', playMusicianNotes);
            document.getElementById('btn-close-musician').addEventListener('click', () => {
                document.getElementById('musician-modal').style.display = 'none';
            });
            
            // –ö–Ω–æ–ø–∫–∏ –∞–∫–∫–æ—Ä–¥–∞ —Å—É–¥—å–±—ã
            document.getElementById('btn-close-chord').addEventListener('click', () => {
                document.getElementById('chord-modal').style.display = 'none';
            });
            
            // –ö–Ω–æ–ø–∫–∏ —É–≥–∞–¥—ã–≤–∞–Ω–∏—è –Ω–æ—Ç—ã
            document.getElementById('btn-play-note').addEventListener('click', () => {
                playNote(gameState.currentNote);
            });
            document.getElementById('btn-close-guess').addEventListener('click', () => {
                document.getElementById('note-guess-modal').style.display = 'none';
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ª–æ–∫–∞—Ü–∏–π
            document.getElementById('village').addEventListener('click', () => {
                alert('–í—ã –≤ –¥–µ—Ä–µ–≤–Ω–µ. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ—Å–µ—Ç–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω –Ω–æ—Ç, –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –º–µ—Ä—Ç–≤—ã–º –º—É–∑—ã–∫–∞–Ω—Ç–æ–º –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ê–∫–∫–æ—Ä–¥–∞ –°—É–¥—å–±—ã.');
            });
            
            ['forest', 'mountains', 'lake', 'cave'].forEach(location => {
                document.getElementById(location).addEventListener('click', () => {
                    alert(`–í—ã –≤ ${getLocationName(location)}. –ó–¥–µ—Å—å –∂–∏–≤—É—Ç –Ω–æ—Ç—ã-–≤—Ä–∞–≥–∏ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π. –ê—Ç–∞–∫—É–π—Ç–µ –∏—Ö, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∑–≤—É–∫–æ–≤—ã–µ –º–æ–Ω–µ—Ç—ã –∏ –æ—Ç–≥–æ–ª–æ—Å–∫–∏!`);
                });
            });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ª–æ–∫–∞—Ü–∏–∏
        function getLocationName(location) {
            const names = {
                forest: '–ª–µ—Å—É',
                mountains: '–≥–æ—Ä–∞—Ö',
                lake: '–æ–∑–µ—Ä–µ',
                cave: '–ø–µ—â–µ—Ä–µ'
            };
            return names[location] || location;
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
