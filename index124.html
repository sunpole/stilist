<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¶–µ—Ä–∫–æ–≤–Ω—ã–π Tower Defense</title>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            background: linear-gradient(135deg, #1c1c2e 0%, #2a2a4a 100%);
            color: #ecf0f1;
            line-height: 1.6;
            padding: 10px;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #game-container {
            width: 100%;
            max-width: 500px;
        }
        
        header {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border-bottom: 2px solid #e67e22;
            width: 100%;
        }
        
        h1 {
            color: #e67e22;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
        }
        
        .stat-name {
            font-size: 0.8rem;
            color: #bdc3c7;
        }
        
        #game-board {
            position: relative;
            width: 100%;
            margin: 0 auto 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }
        
        #canvas {
            display: block;
            width: 100%;
            background: #2c3e50;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .church-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .church-option {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .church-option.selected {
            border-color: #e67e22;
            background: rgba(230, 126, 34, 0.2);
        }
        
        .church-emoji {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .church-cost {
            font-size: 0.7rem;
            color: #bdc3c7;
        }
        
        .btn {
            padding: 10px 15px;
            background: linear-gradient(to right, #e67e22, #d35400);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: transform 0.1s;
            flex: 1;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
        
        #start-screen, #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 10px;
        }
        
        #game-over {
            display: none;
        }
        
        .screen-content {
            text-align: center;
            padding: 20px;
            background: rgba(30, 30, 50, 0.9);
            border-radius: 10px;
            max-width: 80%;
        }
        
        .screen-title {
            color: #e67e22;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }
        
        .screen-text {
            margin-bottom: 20px;
        }
        
        .wave-info {
            margin: 10px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            width: 100%;
        }
        
        .upgrade-info {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .notification {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%) translateY(-50px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 5;
            transition: transform 0.3s;
        }
        
        .notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <header>
            <h1>–¶–µ—Ä–∫–æ–≤–Ω—ã–π Tower Defense</h1>
            <p>–ó–∞–±–µ—Ä–∏ –ø—Ä–∏—Ö–æ–∂–∞–Ω —É –∞–¥–∞!</p>
        </header>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="faith-value">100</div>
                <div class="stat-name">–í–µ—Ä–∞</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="wave-value">0/5</div>
                <div class="stat-name">–í–æ–ª–Ω–∞</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="saved-value">0</div>
                <div class="stat-name">–°–ø–∞—Å–µ–Ω–æ</div>
            </div>
        </div>
        
        <div id="game-board">
            <canvas id="canvas" width="500" height="400"></canvas>
            
            <div id="start-screen">
                <div class="screen-content">
                    <div class="screen-title">–¶–µ—Ä–∫–æ–≤–Ω—ã–π Tower Defense</div>
                    <p class="screen-text">–ó–∞–±–µ—Ä–∏ –ø—Ä–∏—Ö–æ–∂–∞–Ω —É –∞–¥–∞! –°—Ç–∞–≤—å —Ü–µ—Ä–∫–≤–∏, —É–ª—É—á—à–∞–π –∏—Ö –∏ –Ω–µ –¥–∞–π –ø—Ä–∏—Ö–æ–∂–∞–Ω–∞–º —É–π—Ç–∏ –≤ –∞–¥.</p>
                    <button class="btn" id="start-btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                </div>
            </div>
            
            <div id="game-over">
                <div class="screen-content">
                    <div class="screen-title" id="game-result">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</div>
                    <p class="screen-text">–°–ø–∞—Å–µ–Ω–æ –ø—Ä–∏—Ö–æ–∂–∞–Ω: <span id="final-saved">0</span></p>
                    <p class="screen-text">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –≤–µ—Ä—ã: <span id="final-faith">0</span></p>
                    <button class="btn" id="restart-btn">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                </div>
            </div>
        </div>
        
        <div class="church-selector">
            <div class="church-option" data-type="basic" data-cost="50">
                <div class="church-emoji">‚õ™</div>
                <div class="church-cost">50 –≤–µ—Ä—ã</div>
            </div>
            <div class="church-option" data-type="upgraded" data-cost="100">
                <div class="church-emoji">üè∞</div>
                <div class="church-cost">100 –≤–µ—Ä—ã</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" id="upgrade-btn">–£–ª—É—á—à–∏—Ç—å (75)</button>
            <button class="btn" id="start-wave-btn">–ù–∞—á–∞—Ç—å –≤–æ–ª–Ω—É</button>
        </div>
        
        <div class="upgrade-info">
            <p>‚ö° –£–ª—É—á—à–µ–Ω–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Ä–∞–¥–∏—É—Å –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–≤–µ—á–µ–Ω–∏—è —Ü–µ—Ä–∫–≤–µ–π</p>
            <p>‚ú® –° –∫–∞–∂–¥—ã–º —É–ª—É—á—à–µ–Ω–∏–µ–º —Ü–µ—Ä–∫–æ–≤—å —Å–≤–µ—Ç–∏—Ç –¥–æ–ª—å—à–µ –∏ –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç –±–æ–ª—å—à–µ –ø—Ä–∏—Ö–æ–∂–∞–Ω</p>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥—Ä—ã
        const config = {
            gridSize: 6,
            cellSize: 70,
            waveCount: 5,
            waveDuration: 180, // 3 –º–∏–Ω—É—Ç—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            breakDuration: 5,  // 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –≤–æ–ª–Ω–∞–º–∏
            faithBonusPercent: 10
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = {
            faith: 100,
            wave: 0,
            savedSouls: 0,
            gameStarted: false,
            gameOver: false,
            waveActive: false,
            waveTimer: 0,
            breakTimer: 0,
            selectedChurch: null,
            churches: [],
            parishioners: [],
            path: [],
            start: { x: 0, y: 0 },
            end: { x: 5, y: 5 }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–Ω–≤–∞—Å–∞
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫–∞–Ω–≤–∞—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function setupCanvas() {
            const board = document.getElementById('game-board');
            const size = Math.min(board.offsetWidth, 500);
            canvas.width = size;
            canvas.height = Math.floor(size * 0.8);
            config.cellSize = Math.floor(canvas.width / config.gridSize);
        }

        // –¶–µ—Ä–∫–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
        class Church {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.level = 1;
                this.cooldown = 0;
                this.active = false;
                this.range = 1.5;
                this.duration = 2;
                this.cooldownTime = 5;
                
                if (type === 'upgraded') {
                    this.range = 2;
                    this.duration = 2.5;
                    this.cooldownTime = 4.5;
                }
            }
            
            update(deltaTime) {
                if (this.cooldown > 0) {
                    this.cooldown -= deltaTime;
                    this.active = false;
                } else {
                    this.active = true;
                    this.cooldown = this.cooldownTime;
                }
            }
            
            draw(ctx) {
                const x = this.x * config.cellSize + config.cellSize / 2;
                const y = this.y * config.cellSize + config.cellSize / 2;
                
                // –†–∏—Å—É–µ–º —Ü–µ—Ä–∫–æ–≤—å
                ctx.font = `${config.cellSize * 0.5}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                if (this.type === 'basic') {
                    ctx.fillText('‚õ™', x, y);
                } else {
                    ctx.fillText('üè∞', x, y);
                }
                
                // –†–∏—Å—É–µ–º —É—Ä–æ–≤–µ–Ω—å
                ctx.font = '12px Arial';
                ctx.fillStyle = '#fff';
                ctx.fillText(`${this.level}`, x, y + config.cellSize * 0.3);
                
                // –†–∏—Å—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Å–≤–µ—Ç
                if (this.active) {
                    ctx.globalAlpha = 0.2;
                    ctx.beginPath();
                    ctx.arc(x, y, this.range * config.cellSize, 0, Math.PI * 2);
                    
                    if (this.type === 'basic') {
                        ctx.fillStyle = '#3498db';
                    } else {
                        ctx.fillStyle = '#e67e22';
                    }
                    
                    ctx.fill();
                    ctx.globalAlpha = 1;
                    
                    // –†–∏—Å—É–µ–º –∫–æ–Ω—É—Å —Å–≤–µ—Ç–∞ –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫ –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–µ
                    const angle = Math.atan2(gameState.end.y - this.y, gameState.end.x - this.x);
                    const spread = Math.PI / (4 / this.level); // –ß–µ–º –≤—ã—à–µ —É—Ä–æ–≤–µ–Ω—å, —Ç–µ–º —à–∏—Ä–µ –∫–æ–Ω—É—Å
                    
                    ctx.arc(x, y, this.range * config.cellSize, angle - spread/2, angle + spread/2);
                    ctx.closePath();
                    
                    if (this.type === 'basic') {
                        ctx.fillStyle = '#3498db';
                    } else {
                        ctx.fillStyle = '#e67e22';
                    }
                    
                    ctx.globalAlpha = 0.4;
                    ctx.fill();
                    ctx.globalAlpha = 1;
                }
            }
            
            tryAttract(parishioner) {
                if (!this.active) return false;
                
                const churchX = this.x * config.cellSize + config.cellSize / 2;
                const churchY = this.y * config.cellSize + config.cellSize / 2;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                const dx = parishioner.x - churchX;
                const dy = parishioner.y - churchY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <= this.range * config.cellSize) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–æ–Ω—É—Å–∞)
                    const toChurch = Math.atan2(dy, dx);
                    const toEnd = Math.atan2(
                        gameState.end.y * config.cellSize + config.cellSize / 2 - churchY,
                        gameState.end.x * config.cellSize + config.cellSize / 2 - churchX
                    );
                    
                    const angleDiff = Math.abs(toChurch - toEnd);
                    if (angleDiff < Math.PI / (4 / this.level)) {
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∞–Ω—Å —Å —É—Ä–æ–≤–Ω–µ–º —Ü–µ—Ä–∫–≤–∏
                        const chance = 0.3 + (this.level - 1) * 0.15;
                        if (Math.random() < chance) {
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            upgrade() {
                this.level++;
                this.range += 0.2;
                this.duration += 0.5;
                this.cooldownTime = Math.max(1, this.cooldownTime - 0.2);
            }
        }

        // –ö–ª–∞—Å—Å –ø—Ä–∏—Ö–æ–∂–∞–Ω–∏–Ω–∞
        class Parishioner {
            constructor() {
                this.reset();
            }
            
            reset() {
                this.x = gameState.start.x * config.cellSize + config.cellSize / 2;
                this.y = gameState.start.y * config.cellSize + config.cellSize / 2;
                this.speed = 1 + Math.random() * 0.5;
                this.saved = false;
                this.targetIndex = 0;
                
                // –°–ª—É—á–∞–π–Ω–∞—è –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                this.delay = Math.random() * 2;
            }
            
            update(deltaTime) {
                if (this.delay > 0) {
                    this.delay -= deltaTime;
                    return;
                }
                
                if (this.saved) return;
                
                if (this.targetIndex < gameState.path.length) {
                    const target = gameState.path[this.targetIndex];
                    const targetX = target.x * config.cellSize + config.cellSize / 2;
                    const targetY = target.y * config.cellSize + config.cellSize / 2;
                    
                    const dx = targetX - this.x;
                    const dy = targetY - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 2) {
                        this.targetIndex++;
                    } else {
                        this.x += (dx / distance) * this.speed * deltaTime * 20;
                        this.y += (dy / distance) * this.speed * deltaTime * 20;
                    }
                } else {
                    // –ü—Ä–∏—Ö–æ–∂–∞–Ω–∏–Ω –¥–æ—à–µ–ª –¥–æ –∫–æ–Ω—Ü–∞ (–∞–¥–∞)
                    this.saved = false;
                    gameState.gameOver = true;
                    showNotification("–ü—Ä–∏—Ö–æ–∂–∞–Ω–∏–Ω —É—à–µ–ª –≤ –∞–¥! –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.");
                    showGameOver();
                }
            }
            
            draw(ctx) {
                ctx.font = `${config.cellSize * 0.4}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üë§', this.x, this.y);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            document.getElementById('faith-value').textContent = Math.floor(gameState.faith);
            document.getElementById('wave-value').textContent = `${gameState.wave}/${config.waveCount}`;
            document.getElementById('saved-value').textContent = gameState.savedSouls;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–ª—É—á—à–µ–Ω–∏—è
            const upgradeBtn = document.getElementById('upgrade-btn');
            const upgradeCost = 75;
            upgradeBtn.textContent = `–£–ª—É—á—à–∏—Ç—å (${upgradeCost})`;
            upgradeBtn.disabled = gameState.faith < upgradeCost || !getSelectedChurch();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ –≤–æ–ª–Ω—ã
            const waveBtn = document.getElementById('start-wave-btn');
            if (gameState.waveActive) {
                waveBtn.textContent = `–í–æ–ª–Ω–∞: ${Math.ceil(gameState.waveTimer)}`;
                waveBtn.disabled = true;
            } else if (gameState.breakTimer > 0) {
                waveBtn.textContent = `–ü–µ—Ä–µ—Ä—ã–≤: ${Math.ceil(gameState.breakTimer)}`;
                waveBtn.disabled = true;
            } else {
                waveBtn.textContent = '–ù–∞—á–∞—Ç—å –≤–æ–ª–Ω—É';
                waveBtn.disabled = gameState.wave >= config.waveCount;
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ü–µ—Ä–∫–æ–≤—å
        function getSelectedChurch() {
            const selected = document.querySelector('.church-option.selected');
            if (!selected) return null;
            
            return {
                type: selected.dataset.type,
                cost: parseInt(selected.dataset.cost)
            };
        }

        // –ü–æ–∏—Å–∫ –ø—É—Ç–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π A*)
        function findPath() {
            // –ü—Ä–æ—Å—Ç–æ–π –ø—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏)
            const path = [];
            for (let i = 0; i <= config.gridSize; i++) {
                const x = Math.min(i, config.gridSize - 1);
                const y = Math.min(i, config.gridSize - 1);
                path.push({ x, y });
            }
            return path;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–Ω–æ –ª–∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Ü–µ—Ä–∫–æ–≤—å –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π —è—á–µ–π–∫–µ
        function canBuildChurch(x, y) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç–∞ –ª–∏ —è—á–µ–π–∫–∞
            for (const church of gameState.churches) {
                if (church.x === x && church.y === y) {
                    return false;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ª–∏ –ø—É—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
            const tempChurches = [...gameState.churches, { x, y }];
            
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–∏
            // –í —Ä–µ–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ –ø—É—Ç–∏
            for (let i = 0; i < config.gridSize; i++) {
                for (let j = 0; j < config.gridSize; j++) {
                    let occupied = false;
                    for (const church of tempChurches) {
                        if (church.x === i && church.y === j) {
                            occupied = true;
                            break;
                        }
                    }
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω–∞—è —è—á–µ–π–∫–∞ —Ä—è–¥–æ–º —Å —Ñ–∏–Ω–∏—à–µ–º, –ø—É—Ç—å –µ—Å—Ç—å
                    if (!occupied && (
                        (i === gameState.end.x && Math.abs(j - gameState.end.y) === 1) ||
                        (j === gameState.end.y && Math.abs(i - gameState.end.x) === 1)
                    )) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        // –ù–∞—á–∞–ª–æ –≤–æ–ª–Ω—ã
        function startWave() {
            if (gameState.wave >= config.waveCount || gameState.waveActive || gameState.breakTimer > 0) {
                return;
            }
            
            gameState.wave++;
            gameState.waveActive = true;
            gameState.waveTimer = config.waveDuration;
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–∏—Ö–æ–∂–∞–Ω –¥–ª—è —ç—Ç–æ–π –≤–æ–ª–Ω—ã
            const parishionerCount = 5 + gameState.wave * 3;
            for (let i = 0; i < parishionerCount; i++) {
                const parishioner = new Parishioner();
                parishioner.delay = i * (config.waveDuration / parishionerCount) * 0.8;
                gameState.parishioners.push(parishioner);
            }
            
            showNotification(`–ù–∞—á–∞–ª–∞—Å—å –≤–æ–ª–Ω–∞ ${gameState.wave}!`);
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ–ª–Ω—ã
        function endWave() {
            gameState.waveActive = false;
            gameState.breakTimer = config.breakDuration;
            
            // –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å –≤–µ—Ä—ã
            const waveBonus = Math.floor(gameState.savedSouls * (config.faithBonusPercent / 100));
            gameState.faith += waveBonus;
            
            showNotification(`–í–æ–ª–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ë–æ–Ω—É—Å: +${waveBonus} –≤–µ—Ä—ã`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
            if (gameState.wave >= config.waveCount) {
                showNotification("–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤—Å–µ –≤–æ–ª–Ω—ã!");
                showGameOver();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã
        function showGameOver() {
            document.getElementById('final-saved').textContent = gameState.savedSouls;
            document.getElementById('final-faith').textContent = gameState.faith;
            
            if (gameState.gameOver) {
                document.getElementById('game-result').textContent = "–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞";
            } else {
                document.getElementById('game-result').textContent = "–ü–æ–±–µ–¥–∞!";
            }
            
            document.getElementById('game-over').style.display = 'flex';
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        let lastTime = 0;
        function gameLoop(timestamp) {
            const deltaTime = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            
            // –û—á–∏—â–∞–µ–º –∫–∞–Ω–≤–∞—Å
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= config.gridSize; i++) {
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                ctx.beginPath();
                ctx.moveTo(i * config.cellSize, 0);
                ctx.lineTo(i * config.cellSize, canvas.height);
                ctx.stroke();
                
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                ctx.beginPath();
                ctx.moveTo(0, i * config.cellSize);
                ctx.lineTo(canvas.width, i * config.cellSize);
                ctx.stroke();
            }
            
            // –†–∏—Å—É–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Ç–æ—á–∫—É
            ctx.fillStyle = 'rgba(46, 204, 113, 0.5)';
            ctx.fillRect(
                gameState.start.x * config.cellSize,
                gameState.start.y * config.cellSize,
                config.cellSize,
                config.cellSize
            );
            
            // –†–∏—Å—É–µ–º –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É (–∞–¥)
            ctx.fillStyle = 'rgba(231, 76, 60, 0.5)';
            ctx.fillRect(
                gameState.end.x * config.cellSize,
                gameState.end.y * config.cellSize,
                config.cellSize,
                config.cellSize
            );
            
            ctx.font = `${config.cellSize * 0.5}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#fff';
            ctx.fillText('üòà', 
                gameState.end.x * config.cellSize + config.cellSize / 2,
                gameState.end.y * config.cellSize + config.cellSize / 2
            );
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏ —Ä–∏—Å—É–µ–º —Ü–µ—Ä–∫–≤–∏
            for (const church of gameState.churches) {
                church.update(deltaTime);
                church.draw(ctx);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏ —Ä–∏—Å—É–µ–º –ø—Ä–∏—Ö–æ–∂–∞–Ω
            for (let i = gameState.parishioners.length - 1; i >= 0; i--) {
                const parishioner = gameState.parishioners[i];
                parishioner.update(deltaTime);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏–≤–ª–µ–∫–ª–∞ –ª–∏ —Ü–µ—Ä–∫–æ–≤—å –ø—Ä–∏—Ö–æ–∂–∞–Ω–∏–Ω–∞
                for (const church of gameState.churches) {
                    if (church.tryAttract(parishioner)) {
                        parishioner.saved = true;
                        gameState.savedSouls++;
                        gameState.faith += 5 * church.level;
                        gameState.parishioners.splice(i, 1);
                        break;
                    }
                }
                
                if (!parishioner.saved) {
                    parishioner.draw(ctx);
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä—ã –≤–æ–ª–Ω
            if (gameState.waveActive) {
                gameState.waveTimer -= deltaTime;
                if (gameState.waveTimer <= 0) {
                    endWave();
                }
            } else if (gameState.breakTimer > 0) {
                gameState.breakTimer -= deltaTime;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateUI();
            
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
            if (!gameState.gameOver) {
                requestAnimationFrame(gameLoop);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            setupCanvas();
            gameState.path = findPath();
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('start-btn').addEventListener('click', () => {
                document.getElementById('start-screen').style.display = 'none';
                gameState.gameStarted = true;
                requestAnimationFrame(gameLoop);
            });
            
            document.getElementById('restart-btn').addEventListener('click', () => {
                document.getElementById('game-over').style.display = 'none';
                resetGame();
            });
            
            document.getElementById('upgrade-btn').addEventListener('click', () => {
                const selected = getSelectedChurch();
                if (!selected) {
                    showNotification("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–µ—Ä–∫–æ–≤—å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è");
                    return;
                }
                
                const upgradeCost = 75;
                if (gameState.faith >= upgradeCost) {
                    gameState.faith -= upgradeCost;
                    selected.level++;
                    showNotification(`–¶–µ—Ä–∫–æ–≤—å —É–ª—É—á—à–µ–Ω–∞ –¥–æ —É—Ä–æ–≤–Ω—è ${selected.level}`);
                } else {
                    showNotification("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–µ—Ä—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è");
                }
            });
            
            document.getElementById('start-wave-btn').addEventListener('click', startWave);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–µ—Ä–∫–≤–∏
            document.querySelectorAll('.church-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.church-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    
                    const type = option.dataset.type;
                    const cost = parseInt(option.dataset.cost);
                    
                    if (gameState.faith < cost) {
                        showNotification(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–µ—Ä—ã. –ù—É–∂–Ω–æ: ${cost}`);
                        option.classList.remove('selected');
                    }
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞–Ω–≤–∞—Å—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ—Ä–∫–≤–∏
            canvas.addEventListener('click', (e) => {
                if (!gameState.gameStarted || gameState.waveActive) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left) / config.cellSize);
                const y = Math.floor((e.clientY - rect.top) / config.cellSize);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è –∏ –Ω–µ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ/—Ñ–∏–Ω–∏—à–µ
                if (x >= 0 && x < config.gridSize && y >= 0 && y < config.gridSize &&
                    !(x === gameState.start.x && y === gameState.start.y) &&
                    !(x === gameState.end.x && y === gameState.end.y)) {
                    
                    const selected = getSelectedChurch();
                    if (selected) {
                        if (gameState.faith >= selected.cost) {
                            if (canBuildChurch(x, y)) {
                                gameState.faith -= selected.cost;
                                gameState.churches.push(new Church(x, y, selected.type));
                                showNotification("–¶–µ—Ä–∫–æ–≤—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞!");
                            } else {
                                showNotification("–ó–¥–µ—Å—å –Ω–µ–ª—å–∑—è –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Ü–µ—Ä–∫–æ–≤—å!");
                            }
                        } else {
                            showNotification("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–µ—Ä—ã –¥–ª—è –ø–æ—Å—Ç—Ä–æ–π–∫–∏");
                        }
                    } else {
                        showNotification("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ü–µ—Ä–∫–≤–∏");
                    }
                }
            });
            
            // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', setupCanvas);
        }

        // –°–±—Ä–æ—Å –∏–≥—Ä—ã
        function resetGame() {
            gameState = {
                faith: 100,
                wave: 0,
                savedSouls: 0,
                gameStarted: true,
                gameOver: false,
                waveActive: false,
                waveTimer: 0,
                breakTimer: 0,
                selectedChurch: null,
                churches: [],
                parishioners: [],
                path: [],
                start: { x: 0, y: 0 },
                end: { x: 5, y: 5 }
            };
            
            document.querySelectorAll('.church-option').forEach(o => o.classList.remove('selected'));
            gameState.path = findPath();
            requestAnimationFrame(gameLoop);
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
