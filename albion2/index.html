<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Albion Craft Master</title>
    <!-- Библиотеки -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <!-- PNotify для уведомлений -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/pnotify/3.2.1/pnotify.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pnotify/3.2.1/pnotify.js"></script>
    <!-- SortableJS для Drag-and-Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <style>
        /* Основные стили с учетом всех требований */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #1a1a2e;
            --light: #ecf0f1;
            --gray: #95a5a6;
            --border-radius: 10px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            padding: 0;
        }

        /* Шапка */
        .header {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(45deg, #f39c12, #e74c3c);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .logo-text h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            background: linear-gradient(45deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Основной контейнер с вкладками */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 15px;
            max-height: calc(100vh - 140px);
        }

        .tabs-header {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none;
        }

        .tabs-header::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: var(--border-radius);
            color: var(--light);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: var(--secondary);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Контейнер вкладок */
        .tabs-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        /* Сетка контента */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            flex: 1;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Карточки */
        .card {
            background: rgba(20, 20, 35, 0.95);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
            max-height: 100%;
        }

        .card-header {
            padding: 20px;
            border-bottom: 2px solid var(--secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .card-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--secondary);
            font-size: 18px;
            flex: 1;
        }

        /* Прокручиваемое содержимое карточек */
        .card-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0;
        }

        /* Формы */
        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--gray);
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: var(--light);
            font-size: 14px;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Кнопки */
        .btn {
            padding: 12px 24px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d68910);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Библиотеки - списки элементов */
        .library-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .library-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .library-tab {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .library-tab.active {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .items-list {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            padding-right: 10px;
            min-height: 0;
        }

        @media (max-width: 768px) {
            .items-list {
                grid-template-columns: 1fr;
            }
        }

        .item-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--border-radius);
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            cursor: pointer;
        }

        .item-card:hover {
            border-color: var(--secondary);
            transform: translateY(-3px);
        }

        .item-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .item-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-meta {
            font-size: 12px;
            color: var(--gray);
        }

        .item-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .item-actions .btn {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }

        /* Drag-and-Drop область */
        .drop-zone {
            min-height: 200px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 15px;
            transition: var(--transition);
        }

        .drop-zone.drag-over {
            border-color: var(--success);
            background: rgba(46, 204, 113, 0.1);
        }

        .drop-zone.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-size: 14px;
        }

        .component-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--warning);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .component-quantity {
            background: var(--secondary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Подвал */
        .footer {
            background: rgba(0, 0, 0, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .footer-info {
            font-size: 12px;
            color: var(--gray);
        }

        .footer-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--light);
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(20, 20, 35, 0.98);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Коэффициент */
        .coefficient-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .coef-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--warning);
            min-width: 80px;
            text-align: center;
        }

        /* Качества */
        .quality-badges {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .quality-badge {
            padding: 10px 5px;
            border-radius: 8px;
            border: 2px solid transparent;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .quality-badge.active {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .quality-1 { background: #7f8c8d; }
        .quality-2 { background: #2ecc71; }
        .quality-3 { background: #3498db; }
        .quality-4 { background: #9b59b6; }
        .quality-5 { background: #f39c12; }

        /* Поиск */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        /* Адаптация для мобильных */
        @media (max-width: 768px) {
            .header, .footer {
                padding: 12px 15px;
            }
            
            .main-container {
                padding: 12px;
                max-height: calc(100vh - 120px);
            }
            
            .card-body {
                padding: 15px;
            }
            
            .tabs-header {
                margin-bottom: 15px;
            }
            
            .tab-btn {
                padding: 10px 15px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .content-grid {
                gap: 15px;
            }
            
            .card {
                border-radius: 8px;
            }
            
            .card-header {
                padding: 15px;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <!-- Шапка -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-hammer"></i>
            </div>
            <div class="logo-text">
                <h1>Albion Craft Master</h1>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary btn-sm" id="exportBtn">
                <i class="fas fa-download"></i> Экспорт
            </button>
            <button class="btn btn-warning btn-sm" id="importBtn">
                <i class="fas fa-upload"></i> Импорт
            </button>
        </div>
    </header>

    <!-- Основной контейнер с вкладками -->
    <main class="main-container">
        <!-- Кнопки переключения вкладок -->
        <div class="tabs-header">
            <button class="tab-btn active" data-tab="create">
                <i class="fas fa-plus-circle"></i> Создание
            </button>
            <button class="tab-btn" data-tab="library">
                <i class="fas fa-book"></i> Библиотеки
            </button>
            <button class="tab-btn" data-tab="craft">
                <i class="fas fa-hammer"></i> Конструктор крафта
            </button>
            <button class="tab-btn" data-tab="calculator">
                <i class="fas fa-calculator"></i> Калькулятор
            </button>
        </div>

        <!-- Контейнер для содержимого вкладок -->
        <div class="tabs-container">
            <!-- Вкладка создания -->
            <div class="tab-content active" id="create-tab">
                <div class="content-grid">
                    <!-- Левая часть: Форма создания -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-plus-circle"></i>
                            <h2 class="card-title">Создание элемента</h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="elementType">Тип элемента</label>
                                <select id="elementType" class="form-control">
                                    <option value="resource">Ресурс</option>
                                    <option value="composite">Составной ресурс</option>
                                    <option value="item">Предмет</option>
                                </select>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="elementName">Название</label>
                                    <input type="text" id="elementName" placeholder="Введите название">
                                </div>
                                <div class="form-group">
                                    <label for="elementTier">Тир</label>
                                    <select id="elementTier">
                                        <option value="1">T1</option>
                                        <option value="2">T2</option>
                                        <option value="3">T3</option>
                                        <option value="4">T4</option>
                                        <option value="5">T5</option>
                                        <option value="6">T6</option>
                                        <option value="7">T7</option>
                                        <option value="8">T8</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="elementEnchant">Чар</label>
                                    <select id="elementEnchant">
                                        <option value="0">Ч0</option>
                                        <option value="1">Ч1</option>
                                        <option value="2">Ч2</option>
                                        <option value="3">Ч3</option>
                                        <option value="4">Ч4</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="elementQuality">Качество</label>
                                    <select id="elementQuality">
                                        <option value="1">Обычное</option>
                                        <option value="2">Хорошее</option>
                                        <option value="3">Выдающееся</option>
                                        <option value="4">Отличное</option>
                                        <option value="5">Шедевр</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Дополнительные поля для предметов -->
                            <div id="itemSpecific" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="itemCategory">Категория</label>
                                        <select id="itemCategory">
                                            <option value="armor">Броня</option>
                                            <option value="helmet">Шлем</option>
                                            <option value="boots">Сапоги</option>
                                            <option value="weapon">Оружие</option>
                                            <option value="offhand">Левая рука</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="itemSubtype">Тип</label>
                                        <select id="itemSubtype">
                                            <option value="heavy">Тяжелое</option>
                                            <option value="light">Легкое</option>
                                            <option value="magic">Магическое</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Базовая цена -->
                            <div class="form-group">
                                <label for="basePrice">Базовая цена (серебро)</label>
                                <input type="number" id="basePrice" min="0" step="100" value="0">
                            </div>

                            <!-- Для составных ресурсов и предметов -->
                            <div id="componentsSection" style="display: none;">
                                <div class="form-group">
                                    <label>Компоненты крафта</label>
                                    <div class="drop-zone empty" id="componentsDropZone">
                                        Перетащите сюда ресурсы из библиотеки
                                    </div>
                                    <div id="componentsList"></div>
                                </div>
                            </div>

                            <!-- Изображение -->
                            <div class="form-group">
                                <label>Изображение</label>
                                <div class="drop-zone empty" id="imageDropZone">
                                    Перетащите сюда изображение или нажмите для выбора
                                </div>
                                <div id="imagePreview"></div>
                            </div>

                            <!-- Кнопки действий -->
                            <div class="form-row" style="margin-top: auto;">
                                <button class="btn btn-success" id="saveElement">
                                    <i class="fas fa-save"></i> Сохранить
                                </button>
                                <button class="btn btn-warning" id="clearForm">
                                    <i class="fas fa-broom"></i> Очистить
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Правая часть: Быстрый доступ к библиотекам -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-boxes"></i>
                            <h2 class="card-title">Быстрый доступ</h2>
                        </div>
                        <div class="card-body">
                            <div class="library-tabs">
                                <button class="library-tab active" data-library="resources">Ресурсы</button>
                                <button class="library-tab" data-library="composites">Составные</button>
                                <button class="library-tab" data-library="items">Предметы</button>
                            </div>
                            <div class="items-list" id="quickAccessList">
                                <!-- Быстрый доступ к элементам -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка библиотек -->
            <div class="tab-content" id="library-tab">
                <div class="content-grid">
                    <!-- Библиотека ресурсов -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-leaf"></i>
                            <h2 class="card-title">Библиотека ресурсов</h2>
                            <span class="badge" id="resourceCount">0</span>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="searchResources" placeholder="Поиск ресурсов...">
                            </div>
                            <div class="items-list" id="resourcesLibrary">
                                <!-- Ресурсы загружаются здесь -->
                            </div>
                        </div>
                    </div>

                    <!-- Библиотека составных ресурсов -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-puzzle-piece"></i>
                            <h2 class="card-title">Библиотека составных ресурсов</h2>
                            <span class="badge" id="compositeCount">0</span>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="searchComposites" placeholder="Поиск составных ресурсов...">
                            </div>
                            <div class="items-list" id="compositesLibrary">
                                <!-- Составные ресурсы загружаются здесь -->
                            </div>
                        </div>
                    </div>

                    <!-- Библиотека предметов -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-shield-alt"></i>
                            <h2 class="card-title">Библиотека предметов</h2>
                            <span class="badge" id="itemCount">0</span>
                        </div>
                        <div class="card-body">
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" id="searchItems" placeholder="Поиск предметов...">
                            </div>
                            <div class="items-list" id="itemsLibrary">
                                <!-- Предметы загружаются здесь -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка конструктора крафта -->
            <div class="tab-content" id="craft-tab">
                <div class="content-grid">
                    <!-- Левая часть: Выбор компонентов -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-box-open"></i>
                            <h2 class="card-title">Компоненты для крафта</h2>
                        </div>
                        <div class="card-body">
                            <div class="library-tabs">
                                <button class="library-tab active" data-craft-library="resources">Ресурсы</button>
                                <button class="library-tab" data-craft-library="composites">Составные</button>
                            </div>
                            <div class="items-list" id="craftComponentsList">
                                <!-- Компоненты для перетаскивания -->
                            </div>
                        </div>
                    </div>

                    <!-- Правая часть: Область сборки -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-hammer"></i>
                            <h2 class="card-title">Область сборки крафта</h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="craftName">Название собираемого предмета</label>
                                <input type="text" id="craftName" placeholder="Введите название">
                            </div>

                            <div class="coefficient-control">
                                <div style="flex: 1;">
                                    <label for="craftCoefficient">Коэффициент наценки</label>
                                    <input type="range" id="craftCoefficient" min="0.01" max="100" step="0.01" value="1.3">
                                </div>
                                <div class="coef-value" id="craftCoefValue">1.30x</div>
                            </div>

                            <div class="quality-badges">
                                <div class="quality-badge quality-1 active" data-coef="1.0">Обычное (1.0x)</div>
                                <div class="quality-badge quality-2" data-coef="1.2">Хорошее (1.2x)</div>
                                <div class="quality-badge quality-3" data-coef="1.3">Выдающееся (1.3x)</div>
                                <div class="quality-badge quality-4" data-coef="1.5">Отличное (1.5x)</div>
                                <div class="quality-badge quality-5" data-coef="2.0">Шедевр (2.0x)</div>
                            </div>

                            <div class="form-group">
                                <label>Состав крафта</label>
                                <div class="drop-zone empty" id="craftDropZone">
                                    Перетащите сюда компоненты для сборки
                                </div>
                                <div id="craftComponents"></div>
                            </div>

                            <div class="total-cost" id="craftTotal" style="margin-top: auto;">
                                <h3><i class="fas fa-calculator"></i> Итоговая стоимость</h3>
                                <div class="cost-breakdown" id="craftCostValue">0 серебра</div>
                                <div class="market-price" id="craftMarketValue">Рыночная цена: 0 серебра</div>
                                <div class="profit-indicator" id="craftProfit">Прибыль: 0 серебра (0%)</div>
                            </div>

                            <div class="form-row" style="margin-top: 20px;">
                                <button class="btn btn-success" id="saveCraft">
                                    <i class="fas fa-save"></i> Сохранить как предмет
                                </button>
                                <button class="btn btn-warning" id="clearCraft">
                                    <i class="fas fa-broom"></i> Очистить сборку
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка калькулятора -->
            <div class="tab-content" id="calculator-tab">
                <div class="content-grid">
                    <!-- Калькулятор стоимости -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-calculator"></i>
                            <h2 class="card-title">Расширенный калькулятор</h2>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Выберите предмет для расчета</label>
                                <div class="items-list" id="calculatorItems">
                                    <!-- Предметы для расчета -->
                                </div>
                            </div>

                            <div class="coefficient-control">
                                <div style="flex: 1;">
                                    <label for="calcCoefficient">Коэффициент наценки</label>
                                    <input type="range" id="calcCoefficient" min="0.01" max="100" step="0.01" value="1.3">
                                </div>
                                <div class="coef-value" id="calcCoefValue">1.30x</div>
                            </div>

                            <div class="quality-badges">
                                <div class="quality-badge quality-1 active" data-calc-coef="1.0">Обычное (1.0x)</div>
                                <div class="quality-badge quality-2" data-calc-coef="1.2">Хорошее (1.2x)</div>
                                <div class="quality-badge quality-3" data-calc-coef="1.3">Выдающееся (1.3x)</div>
                                <div class="quality-badge quality-4" data-calc-coef="1.5">Отличное (1.5x)</div>
                                <div class="quality-badge quality-5" data-calc-coef="2.0">Шедевр (2.0x)</div>
                            </div>

                            <div class="total-cost" style="margin-top: 20px;">
                                <h3><i class="fas fa-chart-line"></i> Результаты расчета</h3>
                                <div class="cost-breakdown" id="calcTotalCost">0 серебра</div>
                                <div class="market-price" id="calcMarketPrice">Рыночная цена: 0 серебра</div>
                                <div id="calcBreakdown"></div>
                            </div>
                        </div>
                    </div>

                    <!-- История расчетов -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-history"></i>
                            <h2 class="card-title">История расчетов</h2>
                        </div>
                        <div class="card-body">
                            <div id="calculationHistory">
                                <!-- История будет здесь -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Подвал -->
    <footer class="footer">
        <div class="footer-info">
            <p>Albion Craft Master v4.0 | Полная система управления крафтом</p>
            <p>Drag-and-Drop | Три библиотеки | Рекурсивные расчеты</p>
        </div>
        <div class="footer-stats">
            <span id="totalElements">0 элементов</span> |
            <span id="totalValue">0 серебра</span> |
            <span id="lastUpdate">Только что</span>
        </div>
    </footer>

    <!-- Модальное окно для деталей -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <div class="card-header">
                <i class="fas fa-info-circle"></i>
                <h2 class="card-title" id="modalTitle">Детали элемента</h2>
                <button class="btn btn-danger btn-sm" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="modalContent">
                    <!-- Детали загружаются здесь -->
                </div>
            </div>
        </div>
    </div>

    <!-- Основной JavaScript код -->
    <script>
        // Инициализация PNotify для уведомлений
        PNotify.prototype.options.styling = 'bootstrap4';
        PNotify.prototype.options.delay = 3000;

        class AlbionCraftMaster {
            constructor() {
                this.data = this.loadData();
                this.currentTab = 'create';
                this.currentLibrary = 'resources';
                this.draggedItem = null;
                this.selectedItem = null;
                this.craftComponents = [];
                this.calculationHistory = [];
                
                this.init();
                this.renderAll();
                this.updateStats();
            }
            
            init() {
                this.initEventListeners();
                this.initDragAndDrop();
                this.setupTabs();
            }
            
            loadData() {
                const saved = localStorage.getItem('albionCraftMasterData');
                if (saved) {
                    return JSON.parse(saved);
                }
                
                return {
                    resources: [],
                    composites: [],
                    items: [],
                    settings: {
                        coefficient: 1.3,
                        lastUpdate: new Date().toISOString()
                    }
                };
            }
            
            saveData() {
                this.data.settings.lastUpdate = new Date().toISOString();
                localStorage.setItem('albionCraftMasterData', JSON.stringify(this.data));
                this.updateStats();
            }
            
            initEventListeners() {
                // Переключение вкладок
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.target.dataset.tab;
                        this.switchTab(tab);
                    });
                });
                
                // Переключение библиотек в быстром доступе
                document.querySelectorAll('.library-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const library = e.target.dataset.library;
                        this.switchQuickAccess(library);
                    });
                });
                
                // Тип элемента
                document.getElementById('elementType').addEventListener('change', (e) => {
                    this.toggleElementFields(e.target.value);
                });
                
                // Сохранение элемента
                document.getElementById('saveElement').addEventListener('click', () => {
                    this.saveNewElement();
                });
                
                // Очистка формы
                document.getElementById('clearForm').addEventListener('click', () => {
                    this.clearElementForm();
                });
                
                // Коэффициенты
                document.getElementById('craftCoefficient').addEventListener('input', (e) => {
                    document.getElementById('craftCoefValue').textContent = 
                        parseFloat(e.target.value).toFixed(2) + 'x';
                    this.updateCraftCalculation();
                });
                
                document.getElementById('calcCoefficient').addEventListener('input', (e) => {
                    document.getElementById('calcCoefValue').textContent = 
                        parseFloat(e.target.value).toFixed(2) + 'x';
                    this.updateCalculator();
                });
                
                // Качества
                document.querySelectorAll('.quality-badge').forEach(badge => {
                    badge.addEventListener('click', (e) => {
                        const coef = parseFloat(e.target.dataset.coef || e.target.dataset.calcCoef);
                        if (e.target.closest('#calculator-tab')) {
                            document.getElementById('calcCoefficient').value = coef;
                            document.getElementById('calcCoefValue').textContent = coef.toFixed(1) + 'x';
                            this.updateCalculator();
                        } else {
                            document.getElementById('craftCoefficient').value = coef;
                            document.getElementById('craftCoefValue').textContent = coef.toFixed(1) + 'x';
                            this.updateCraftCalculation();
                        }
                        
                        // Активируем выбранный бейдж
                        e.target.parentElement.querySelectorAll('.quality-badge').forEach(b => {
                            b.classList.remove('active');
                        });
                        e.target.classList.add('active');
                    });
                });
                
                // Поиск
                ['searchResources', 'searchComposites', 'searchItems'].forEach(id => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        this.filterLibrary(id.replace('search', '').toLowerCase(), e.target.value);
                    });
                });
                
                // Экспорт/импорт
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('importBtn').addEventListener('click', () => this.importData());
                
                // Сохранение сборки
                document.getElementById('saveCraft').addEventListener('click', () => this.saveCraftAsItem());
                document.getElementById('clearCraft').addEventListener('click', () => this.clearCraft());
                
                // Закрытие модального окна
                document.getElementById('closeModal').addEventListener('click', () => {
                    document.getElementById('detailsModal').classList.remove('active');
                });
                
                // Загрузка изображений
                document.getElementById('imageDropZone').addEventListener('click', () => {
                    this.triggerImageUpload();
                });
                
                // Drag and drop для изображений
                const imageDropZone = document.getElementById('imageDropZone');
                imageDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    imageDropZone.classList.add('drag-over');
                });
                
                imageDropZone.addEventListener('dragleave', () => {
                    imageDropZone.classList.remove('drag-over');
                });
                
                imageDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    imageDropZone.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleImageUpload(files[0]);
                    }
                });
                
                // Вставка из буфера обмена
                document.addEventListener('paste', (e) => {
                    const items = e.clipboardData.items;
                    for (let item of items) {
                        if (item.type.indexOf('image') !== -1) {
                            const blob = item.getAsFile();
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                this.previewImage(event.target.result);
                            };
                            reader.readAsDataURL(blob);
                            break;
                        }
                    }
                });
            }
            
            initDragAndDrop() {
                // Инициализация Sortable для библиотек
                const libraries = ['resourcesLibrary', 'compositesLibrary', 'itemsLibrary', 'craftComponentsList'];
                libraries.forEach(libId => {
                    const el = document.getElementById(libId);
                    if (el) {
                        Sortable.create(el, {
                            group: {
                                name: 'crafting',
                                pull: 'clone',
                                put: false
                            },
                            animation: 150,
                            sort: false,
                            onStart: (evt) => {
                                this.draggedItem = this.findItemById(evt.item.dataset.id);
                            }
                        });
                    }
                });
                
                // Область сброса для компонентов
                const dropZones = ['componentsDropZone', 'craftDropZone'];
                dropZones.forEach(zoneId => {
                    const zone = document.getElementById(zoneId);
                    if (zone) {
                        Sortable.create(zone, {
                            group: 'crafting',
                            animation: 150,
                            onAdd: (evt) => {
                                if (this.draggedItem) {
                                    this.addComponentToZone(zoneId, this.draggedItem);
                                }
                            }
                        });
                    }
                });
            }
            
            setupTabs() {
                // Активация первой вкладки
                this.switchTab('create');
                this.switchQuickAccess('resources');
            }
            
            switchTab(tabName) {
                this.currentTab = tabName;
                
                // Обновление активной кнопки
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // Показать соответствующее содержимое
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                // Обновление содержимого в зависимости от вкладки
                switch(tabName) {
                    case 'library':
                        this.renderLibraries();
                        break;
                    case 'craft':
                        this.renderCraftComponents();
                        break;
                    case 'calculator':
                        this.renderCalculator();
                        break;
                }
            }
            
            switchQuickAccess(library) {
                this.currentLibrary = library;
                
                // Обновление активной вкладки
                document.querySelectorAll('.library-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-library="${library}"]`).classList.add('active');
                
                // Обновление списка
                this.renderQuickAccess();
            }
            
            toggleElementFields(type) {
                const itemSpecific = document.getElementById('itemSpecific');
                const componentsSection = document.getElementById('componentsSection');
                
                if (type === 'resource') {
                    itemSpecific.style.display = 'none';
                    componentsSection.style.display = 'none';
                } else if (type === 'composite') {
                    itemSpecific.style.display = 'none';
                    componentsSection.style.display = 'block';
                } else if (type === 'item') {
                    itemSpecific.style.display = 'block';
                    componentsSection.style.display = 'block';
                }
            }
            
            findItemById(id) {
                id = parseInt(id);
                
                // Поиск во всех библиотеках
                for (const category of ['resources', 'composites', 'items']) {
                    const item = this.data[category].find(item => item.id === id);
                    if (item) {
                        return {...item, category};
                    }
                }
                
                return null;
            }
            
            addComponentToZone(zoneId, item) {
                const zone = document.getElementById(zoneId);
                const componentsList = zoneId === 'componentsDropZone' ? 
                    document.getElementById('componentsList') : 
                    document.getElementById('craftComponents');
                
                // Проверяем, есть ли уже такой компонент
                const existing = componentsList.querySelector(`[data-id="${item.id}"]`);
                if (existing) {
                    // Увеличиваем количество
                    const quantityEl = existing.querySelector('.component-quantity');
                    const currentQty = parseInt(quantityEl.textContent);
                    quantityEl.textContent = currentQty + 1;
                    
                    // Обновляем данные
                    if (zoneId === 'craftDropZone') {
                        const comp = this.craftComponents.find(c => c.id === item.id);
                        if (comp) comp.quantity++;
                        this.updateCraftCalculation();
                    }
                } else {
                    // Создаем новый элемент компонента
                    const compElement = document.createElement('div');
                    compElement.className = 'component-item';
                    compElement.dataset.id = item.id;
                    compElement.innerHTML = `
                        <div class="component-quantity">1</div>
                        <div class="item-icon">
                            ${item.icon ? `<img src="${item.icon}">` : `<i class="fas fa-${item.category === 'resources' ? 'leaf' : 'puzzle-piece'}"></i>`}
                        </div>
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-meta">${this.formatNumber(this.calculateItemCost(item))} серебра</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-danger remove-component">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    // Обработчик удаления
                    compElement.querySelector('.remove-component').addEventListener('click', () => {
                        this.removeComponent(zoneId, item.id);
                    });
                    
                    componentsList.appendChild(compElement);
                    
                    // Добавляем в данные
                    if (zoneId === 'craftDropZone') {
                        this.craftComponents.push({
                            ...item,
                            quantity: 1
                        });
                        this.updateCraftCalculation();
                    }
                }
                
                // Убираем текст "пусто"
                zone.classList.remove('empty');
                
                // Сбрасываем перетаскиваемый элемент
                this.draggedItem = null;
            }
            
            removeComponent(zoneId, itemId) {
                const componentsList = zoneId === 'componentsDropZone' ? 
                    document.getElementById('componentsList') : 
                    document.getElementById('craftComponents');
                
                const element = componentsList.querySelector(`[data-id="${itemId}"]`);
                if (element) {
                    element.remove();
                    
                    if (zoneId === 'craftDropZone') {
                        this.craftComponents = this.craftComponents.filter(c => c.id !== itemId);
                        this.updateCraftCalculation();
                    }
                }
                
                // Если компонентов не осталось, показываем текст "пусто"
                if (componentsList.children.length === 0) {
                    const zone = document.getElementById(zoneId);
                    zone.classList.add('empty');
                }
            }
            
            previewImage(imageData) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = '';
                
                const img = document.createElement('img');
                img.src = imageData;
                img.style.maxWidth = '150px';
                img.style.maxHeight = '150px';
                img.style.borderRadius = '8px';
                
                preview.appendChild(img);
                
                // Сохраняем в текущем элементе
                if (this.selectedItem) {
                    this.selectedItem.icon = imageData;
                }
                
                new PNotify({
                    title: 'Успех',
                    text: 'Изображение загружено',
                    type: 'success'
                });
            }
            
            handleImageUpload(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.previewImage(e.target.result);
                };
                reader.readAsDataURL(file);
            }
            
            triggerImageUpload() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    if (e.target.files[0]) {
                        this.handleImageUpload(e.target.files[0]);
                    }
                };
                input.click();
            }
            
            saveNewElement() {
                const type = document.getElementById('elementType').value;
                const name = document.getElementById('elementName').value.trim();
                const tier = parseInt(document.getElementById('elementTier').value);
                const enchant = parseInt(document.getElementById('elementEnchant').value);
                const quality = parseInt(document.getElementById('elementQuality').value);
                const basePrice = parseFloat(document.getElementById('basePrice').value) || 0;
                
                if (!name) {
                    new PNotify({
                        title: 'Ошибка',
                        text: 'Введите название элемента',
                        type: 'error'
                    });
                    return;
                }
                
                const newElement = {
                    id: Date.now(),
                    name,
                    type,
                    tier,
                    enchant,
                    quality,
                    basePrice,
                    icon: document.getElementById('imagePreview').querySelector('img')?.src || null,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Добавляем специфичные поля
                if (type === 'item') {
                    newElement.category = document.getElementById('itemCategory').value;
                    newElement.subtype = document.getElementById('itemSubtype').value;
                }
                
                // Добавляем компоненты для составных ресурсов и предметов
                if (type === 'composite' || type === 'item') {
                    const components = [];
                    document.querySelectorAll('#componentsList .component-item').forEach(item => {
                        const itemId = parseInt(item.dataset.id);
                        const quantity = parseInt(item.querySelector('.component-quantity').textContent);
                        const itemData = this.findItemById(itemId);
                        
                        if (itemData) {
                            components.push({
                                id: itemId,
                                name: itemData.name,
                                quantity: quantity,
                                cost: this.calculateItemCost(itemData)
                            });
                        }
                    });
                    newElement.components = components;
                }
                
                // Сохраняем в соответствующую библиотеку
                if (type === 'resource') {
                    this.data.resources.push(newElement);
                } else if (type === 'composite') {
                    this.data.composites.push(newElement);
                } else if (type === 'item') {
                    this.data.items.push(newElement);
                }
                
                this.saveData();
                this.clearElementForm();
                this.renderAll();
                
                new PNotify({
                    title: 'Успех',
                    text: `Элемент "${name}" сохранен`,
                    type: 'success'
                });
            }
            
            saveCraftAsItem() {
                const name = document.getElementById('craftName').value.trim();
                const coefficient = parseFloat(document.getElementById('craftCoefficient').value);
                
                if (!name) {
                    new PNotify({
                        title: 'Ошибка',
                        text: 'Введите название предмета',
                        type: 'error'
                    });
                    return;
                }
                
                if (this.craftComponents.length === 0) {
                    new PNotify({
                        title: 'Ошибка',
                        text: 'Добавьте компоненты для крафта',
                        type: 'error'
                    });
                    return;
                }
                
                const totalCost = this.craftComponents.reduce((sum, comp) => {
                    return sum + (this.calculateItemCost(comp) * comp.quantity);
                }, 0);
                
                const newItem = {
                    id: Date.now(),
                    name,
                    type: 'item',
                    tier: Math.max(...this.craftComponents.map(c => c.tier)),
                    enchant: 0,
                    quality: 1,
                    basePrice: totalCost,
                    coefficient,
                    components: this.craftComponents.map(comp => ({
                        id: comp.id,
                        name: comp.name,
                        quantity: comp.quantity,
                        cost: this.calculateItemCost(comp)
                    })),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                this.data.items.push(newItem);
                this.saveData();
                this.clearCraft();
                this.renderAll();
                
                new PNotify({
                    title: 'Успех',
                    text: `Предмет "${name}" сохранен в библиотеку`,
                    type: 'success'
                });
            }
            
            calculateItemCost(item) {
                if (item.components && item.components.length > 0) {
                    // Рекурсивно считаем стоимость составных элементов
                    return item.components.reduce((sum, comp) => {
                        const compItem = this.findItemById(comp.id);
                        if (compItem) {
                            return sum + (this.calculateItemCost(compItem) * comp.quantity);
                        }
                        return sum;
                    }, 0);
                }
                return item.basePrice || 0;
            }
            
            updateCraftCalculation() {
                if (this.craftComponents.length === 0) {
                    document.getElementById('craftCostValue').textContent = '0 серебра';
                    document.getElementById('craftMarketValue').textContent = 'Рыночная цена: 0 серебра';
                    document.getElementById('craftProfit').textContent = 'Прибыль: 0 серебра (0%)';
                    return;
                }
                
                const coefficient = parseFloat(document.getElementById('craftCoefficient').value);
                const totalCost = this.craftComponents.reduce((sum, comp) => {
                    return sum + (this.calculateItemCost(comp) * comp.quantity);
                }, 0);
                
                const marketPrice = totalCost * coefficient;
                const profit = marketPrice - totalCost;
                const profitPercent = totalCost > 0 ? (profit / totalCost * 100) : 0;
                
                document.getElementById('craftCostValue').textContent = 
                    this.formatNumber(totalCost) + ' серебра';
                document.getElementById('craftMarketValue').textContent = 
                    `Рыночная цена: ${this.formatNumber(marketPrice)} серебра (${coefficient.toFixed(2)}x)`;
                
                const profitEl = document.getElementById('craftProfit');
                profitEl.textContent = `Прибыль: ${this.formatNumber(profit)} серебра (${profitPercent.toFixed(1)}%)`;
                profitEl.style.color = profit >= 0 ? '#2ecc71' : '#e74c3c';
            }
            
            updateCalculator() {
                // Обновление калькулятора
                const selectedItem = this.selectedItem;
                if (!selectedItem) return;
                
                const coefficient = parseFloat(document.getElementById('calcCoefficient').value);
                const totalCost = this.calculateItemCost(selectedItem);
                const marketPrice = totalCost * coefficient;
                
                document.getElementById('calcTotalCost').textContent = 
                    this.formatNumber(totalCost) + ' серебра';
                document.getElementById('calcMarketPrice').textContent = 
                    `Рыночная цена: ${this.formatNumber(marketPrice)} серебра`;
                
                // Показываем детализацию
                const breakdown = document.getElementById('calcBreakdown');
                breakdown.innerHTML = this.getCostBreakdown(selectedItem);
            }
            
            getCostBreakdown(item, level = 0) {
                let html = `<div style="margin-left: ${level * 20}px; margin-top: 10px;">`;
                
                if (item.components && item.components.length > 0) {
                    html += `<div style="color: #95a5a6; font-size: 14px; margin-bottom: 5px;">Состав:</div>`;
                    item.components.forEach(comp => {
                        const compItem = this.findItemById(comp.id);
                        if (compItem) {
                            const compCost = this.calculateItemCost(compItem) * comp.quantity;
                            html += `
                                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <span>${'&nbsp;'.repeat(level * 2)}${comp.name} ×${comp.quantity}</span>
                                    <span style="color: #f39c12;">${this.formatNumber(compCost)}</span>
                                </div>
                            `;
                            html += this.getCostBreakdown(compItem, level + 1);
                        }
                    });
                }
                
                html += `</div>`;
                return html;
            }
            
            clearElementForm() {
                document.getElementById('elementName').value = '';
                document.getElementById('basePrice').value = '0';
                document.getElementById('elementTier').value = '1';
                document.getElementById('elementEnchant').value = '0';
                document.getElementById('elementQuality').value = '1';
                document.getElementById('itemCategory').value = 'armor';
                document.getElementById('itemSubtype').value = 'heavy';
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('componentsList').innerHTML = '';
                document.getElementById('componentsDropZone').classList.add('empty');
                this.selectedItem = null;
            }
            
            clearCraft() {
                document.getElementById('craftName').value = '';
                document.getElementById('craftCoefficient').value = '1.3';
                document.getElementById('craftCoefValue').textContent = '1.30x';
                document.getElementById('craftComponents').innerHTML = '';
                document.getElementById('craftDropZone').classList.add('empty');
                this.craftComponents = [];
                this.updateCraftCalculation();
            }
            
            renderAll() {
                this.renderQuickAccess();
                this.renderLibraries();
                this.renderCraftComponents();
                this.renderCalculator();
            }
            
            renderQuickAccess() {
                const list = document.getElementById('quickAccessList');
                const items = this.data[this.currentLibrary];
                
                if (!items || items.length === 0) {
                    list.innerHTML = '<div class="empty-state">Нет элементов</div>';
                    return;
                }
                
                list.innerHTML = '';
                items.slice(0, 6).forEach(item => {
                    list.appendChild(this.createItemCard(item, this.currentLibrary));
                });
            }
            
            renderLibraries() {
                ['resources', 'composites', 'items'].forEach(library => {
                    this.renderLibrary(library);
                });
            }
            
            renderLibrary(library) {
                const container = document.getElementById(`${library}Library`);
                if (!container) return;
                
                const items = this.data[library];
                
                // Обновляем счетчик
                document.getElementById(`${library}Count`).textContent = items.length;
                
                if (!items || items.length === 0) {
                    container.innerHTML = '<div class="empty-state">Библиотека пуста</div>';
                    return;
                }
                
                container.innerHTML = '';
                items.forEach(item => {
                    container.appendChild(this.createItemCard(item, library));
                });
            }
            
            renderCraftComponents() {
                const list = document.getElementById('craftComponentsList');
                const resources = [...this.data.resources, ...this.data.composites];
                
                if (!resources || resources.length === 0) {
                    list.innerHTML = '<div class="empty-state">Нет доступных компонентов</div>';
                    return;
                }
                
                list.innerHTML = '';
                resources.forEach(item => {
                    const card = this.createItemCard(item, item.type === 'resource' ? 'resources' : 'composites');
                    card.draggable = true;
                    list.appendChild(card);
                });
            }
            
            renderCalculator() {
                const container = document.getElementById('calculatorItems');
                const items = this.data.items;
                
                if (!items || items.length === 0) {
                    container.innerHTML = '<div class="empty-state">Нет сохраненных предметов</div>';
                    return;
                }
                
                container.innerHTML = '';
                items.forEach(item => {
                    const card = this.createItemCard(item, 'items');
                    card.addEventListener('click', () => {
                        this.selectedItem = item;
                        this.updateCalculator();
                    });
                    container.appendChild(card);
                });
            }
            
            createItemCard(item, category) {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.dataset.id = item.id;
                
                const cost = this.calculateItemCost(item);
                const typeIcon = category === 'resources' ? 'leaf' : 
                               category === 'composites' ? 'puzzle-piece' : 'shield-alt';
                
                card.innerHTML = `
                    <div class="item-card-header">
                        <div class="item-icon">
                            ${item.icon ? `<img src="${item.icon}">` : `<i class="fas fa-${typeIcon}"></i>`}
                        </div>
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-meta">
                                T${item.tier} | ${this.formatNumber(cost)} серебра
                                ${item.components ? `(${item.components.length} комп.)` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-warning edit-btn">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-primary use-btn">
                            <i class="fas fa-hammer"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Обработчики кнопок
                card.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.editItem(item, category);
                });
                
                card.querySelector('.use-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.useItemInCraft(item);
                });
                
                card.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deleteItem(item, category);
                });
                
                // Клик по карточке показывает детали
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        this.showItemDetails(item, category);
                    }
                });
                
                return card;
            }
            
            filterLibrary(library, searchTerm) {
                const container = document.getElementById(`${library}Library`);
                const items = this.data[library];
                
                if (!items) return;
                
                const filtered = items.filter(item => 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                container.innerHTML = '';
                if (filtered.length === 0) {
                    container.innerHTML = '<div class="empty-state">Ничего не найдено</div>';
                    return;
                }
                
                filtered.forEach(item => {
                    container.appendChild(this.createItemCard(item, library));
                });
            }
            
            editItem(item, category) {
                // Заполняем форму редактирования
                document.getElementById('elementType').value = item.type;
                document.getElementById('elementName').value = item.name;
                document.getElementById('elementTier').value = item.tier;
                document.getElementById('elementEnchant').value = item.enchant;
                document.getElementById('elementQuality').value = item.quality;
                document.getElementById('basePrice').value = item.basePrice;
                
                if (item.type === 'item') {
                    document.getElementById('itemCategory').value = item.category || 'armor';
                    document.getElementById('itemSubtype').value = item.subtype || 'heavy';
                }
                
                if (item.icon) {
                    this.previewImage(item.icon);
                }
                
                this.toggleElementFields(item.type);
                this.selectedItem = item;
                
                // Показываем вкладку создания
                this.switchTab('create');
                
                new PNotify({
                    title: 'Редактирование',
                    text: `Редактирование "${item.name}"`,
                    type: 'info'
                });
            }
            
            useItemInCraft(item) {
                // Добавляем в конструктор крафта
                this.switchTab('craft');
                this.addComponentToZone('craftDropZone', item);
            }
            
            deleteItem(item, category) {
                if (!confirm(`Удалить "${item.name}"?`)) return;
                
                this.data[category] = this.data[category].filter(i => i.id !== item.id);
                this.saveData();
                this.renderAll();
                
                new PNotify({
                    title: 'Удалено',
                    text: `Элемент "${item.name}" удален`,
                    type: 'success'
                });
            }
            
            showItemDetails(item, category) {
                const modal = document.getElementById('detailsModal');
                const title = document.getElementById('modalTitle');
                const content = document.getElementById('modalContent');
                
                title.textContent = item.name;
                
                const cost = this.calculateItemCost(item);
                const typeNames = {
                    'resource': 'Ресурс',
                    'composite': 'Составной ресурс',
                    'item': 'Предмет'
                };
                
                let details = `
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex-shrink: 0;">
                            ${item.icon ? `<img src="${item.icon}" style="width: 100px; height: 100px; border-radius: 10px;">` : 
                              `<div style="width: 100px; height: 100px; background: #34495e; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-${category === 'resources' ? 'leaf' : category === 'composites' ? 'puzzle-piece' : 'shield-alt'}" style="font-size: 40px; color: #95a5a6;"></i>
                              </div>`}
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 10px; color: #f39c12;">${item.name}</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div>
                                    <strong>Тип:</strong> ${typeNames[item.type]}
                                </div>
                                <div>
                                    <strong>Тир:</strong> T${item.tier}
                                </div>
                                <div>
                                    <strong>Чар:</strong> Ч${item.enchant}
                                </div>
                                <div>
                                    <strong>Качество:</strong> ${['Обычное', 'Хорошее', 'Выдающееся', 'Отличное', 'Шедевр'][item.quality - 1]}
                                </div>
                                <div>
                                    <strong>Стоимость:</strong> ${this.formatNumber(cost)} серебра
                                </div>
                                <div>
                                    <strong>Базовая цена:</strong> ${this.formatNumber(item.basePrice)} серебра
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                if (item.components && item.components.length > 0) {
                    details += `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <h4 style="margin-bottom: 15px; color: #3498db;">
                                <i class="fas fa-puzzle-piece"></i> Компоненты крафта
                            </h4>
                            <div style="display: grid; gap: 10px;">
                    `;
                    
                    item.components.forEach(comp => {
                        const compItem = this.findItemById(comp.id);
                        if (compItem) {
                            const compCost = this.calculateItemCost(compItem);
                            details += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-weight: bold;">${comp.name}</span>
                                        <span style="color: #95a5a6; font-size: 14px;">×${comp.quantity}</span>
                                    </div>
                                    <div style="color: #f39c12; font-weight: bold;">
                                        ${this.formatNumber(compCost * comp.quantity)} серебра
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    details += `</div></div>`;
                }
                
                content.innerHTML = details;
                modal.classList.add('active');
            }
            
            exportData() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', `albion-craft-data-${new Date().toISOString().split('T')[0]}.json`);
                link.click();
                
                new PNotify({
                    title: 'Экспорт',
                    text: 'Данные успешно экспортированы',
                    type: 'success'
                });
            }
            
            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.resources && data.composites && data.items) {
                                this.data = data;
                                this.saveData();
                                this.renderAll();
                                new PNotify({
                                    title: 'Импорт',
                                    text: 'Данные успешно импортированы',
                                    type: 'success'
                                });
                            } else {
                                throw new Error('Неверный формат файла');
                            }
                        } catch (error) {
                            new PNotify({
                                title: 'Ошибка',
                                text: 'Ошибка при импорте данных: ' + error.message,
                                type: 'error'
                            });
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
            
            updateStats() {
                const totalElements = this.data.resources.length + this.data.composites.length + this.data.items.length;
                
                let totalValue = 0;
                [...this.data.resources, ...this.data.composites, ...this.data.items].forEach(item => {
                    totalValue += this.calculateItemCost(item);
                });
                
                document.getElementById('totalElements').textContent = `${totalElements} элементов`;
                document.getElementById('totalValue').textContent = `${this.formatNumber(totalValue)} серебра`;
                document.getElementById('lastUpdate').textContent = this.formatTime(this.data.settings.lastUpdate);
            }
            
            formatNumber(num) {
                return new Intl.NumberFormat('ru-RU').format(Math.round(num));
            }
            
            formatTime(isoString) {
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Только что';
                if (diffMins < 60) return `${diffMins} мин назад`;
                if (diffHours < 24) return `${diffHours} ч назад`;
                if (diffDays < 7) return `${diffDays} дн назад`;
                
                return date.toLocaleDateString('ru-RU');
            }
        }

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', () => {
            window.craftMaster = new AlbionCraftMaster();
            
            // Показать приветственное сообщение
            setTimeout(() => {
                new PNotify({
                    title: 'Добро пожаловать!',
                    text: 'Используйте Ctrl+V для вставки скриншотов. Перетаскивайте элементы между библиотеками.',
                    type: 'info',
                    delay: 5000
                });
            }, 1000);
        });
    </script>
</body>
</html>
