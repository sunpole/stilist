<!-- modules/import-json.html -->
<style>
  .import-json {
    font-family: Arial, sans-serif;
    padding: 1rem;
    border-radius: 8px;
    background: #f9f9f9;
    max-width: 800px;
    margin: 0 auto;
  }
  
  .import-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  
  .import-methods {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .import-btn {
    background: #4a6fa5;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 13px;
    flex: 1;
    max-width: 15%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .import-btn:hover {
    background: #3a5a8f;
  }
  
  .file-info {
    padding: 0.5rem;
    background: #eef;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    font-size: 13px;
  }
  
  textarea {
    width: 100%;
    min-height: 150px;
    margin: 0.5rem 0;
    font-family: monospace;
    display: none;
    border: 1px solid #ddd;
    padding: 8px;
    border-radius: 4px;
  }
  
  .text-import-controls {
    display: none;
    margin-bottom: 0.5rem;
    text-align: right;
  }
  
  .status-bar {
    height: 4px;
    background: #e0e0e0;
    border-radius: 2px;
    margin-top: 0.5rem;
    overflow: hidden;
  }
  
  .status-progress {
    height: 100%;
    background: #4CAF50;
    width: 0%;
    transition: width 0.3s;
  }
  
  .file-explorer {
    display: none;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
  }
  
  .file-item {
    padding: 0.3rem;
    cursor: pointer;
    border-radius: 3px;
  }
  
  .file-item:hover {
    background: #f0f0f0;
  }
</style>

<div class="import-json">
  <div class="import-header">
    <h3 style="margin: 0">–ò–º–ø–æ—Ä—Ç JSON</h3>
    <div id="status-text" style="font-size: 13px; color: #666;">–ì–æ—Ç–æ–≤–æ</div>
  </div>
  
  <div class="file-info" id="file-info">
    –§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  </div>
  
  <div class="import-methods">
    <button class="import-btn" id="file-btn" title="–ò–º–ø–æ—Ä—Ç —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞">üìÅ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
    <button class="import-btn" id="project-btn" title="–ü–æ–∏—Å–∫ –≤ –ø—Ä–æ–µ–∫—Ç–µ">üîç –ü—Ä–æ–µ–∫—Ç</button>
    <button class="import-btn" id="url-btn" title="–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ URL">üåê –°—Å—ã–ª–∫–∞</button>
    <button class="import-btn" id="text-btn" title="–í–≤–æ–¥ –≤—Ä—É—á–Ω—É—é">‚úèÔ∏è –¢–µ–∫—Å—Ç</button>
  </div>
  
  <div class="file-explorer" id="file-explorer">
    <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Ñ–∞–π–ª—ã -->
  </div>
  
  <textarea id="json-textarea" placeholder='–í—Å—Ç–∞–≤—å—Ç–µ JSON –∑–¥–µ—Å—å...'></textarea>
  
  <div class="text-import-controls" id="text-import-controls">
    <button class="import-btn" style="max-width: 100px; padding: 4px 8px;" id="load-text-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>
  
  <div class="status-bar">
    <div class="status-progress" id="status-progress"></div>
  </div>
</div>

<script>
  let currentJson = null;
  const statusProgress = document.getElementById('status-progress');
  const statusText = document.getElementById('status-text');
  const fileInfo = document.getElementById('file-info');
  const textarea = document.getElementById('json-textarea');
  const fileExplorer = document.getElementById('file-explorer');
  const textImportControls = document.getElementById('text-import-controls');

  // 1. –ò–º–ø–æ—Ä—Ç –∏–∑ —Ñ–∞–π–ª–∞
  document.getElementById('file-btn').addEventListener('click', () => {
    hideAllControls();
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = e => {
      const startTime = performance.now();
      const file = e.target.files[0];
      if (!file) return;
      
      updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞...', 30);
      
      const reader = new FileReader();
      reader.onload = e => {
        try {
          currentJson = JSON.parse(e.target.result);
          updateFileInfo(`–§–∞–π–ª: ${file.name} (${(file.size/1024).toFixed(1)} KB) | –°–ø–æ—Å–æ–±: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ`);
          
          const loadTime = (performance.now() - startTime).toFixed(1);
          updateStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞ ${loadTime} –º—Å`, 100);
          saveToLocalStorage(currentJson);
        } catch (err) {
          updateStatus('–û—à–∏–±–∫–∞: –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON', 0);
        }
      };
      
      reader.readAsText(file);
    };
    
    input.click();
  });

  // 2. –ü–æ–∏—Å–∫ JSON –≤ –ø—Ä–æ–µ–∫—Ç–µ
  document.getElementById('project-btn').addEventListener('click', async () => {
    hideAllControls();
    fileExplorer.style.display = 'block';
    updateStatus('–°–∫–∞–Ω–∏—Ä—É—é –∫–∞—Ç–∞–ª–æ–≥...', 20);
    
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö JSON-—Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ
      const files = await scanProjectForJson();
      displayFilesInExplorer(files);
      updateStatus(`–ù–∞–π–¥–µ–Ω–æ ${files.length} JSON-—Ñ–∞–π–ª–æ–≤`, 100);
    } catch (err) {
      updateStatus('–û—à–∏–±–∫–∞: ' + err.message, 0);
      fileExplorer.innerHTML = `<div style="color: red;">${err.message}</div>`;
    }
  });

  // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ URL
  document.getElementById('url-btn').addEventListener('click', async () => {
    hideAllControls();
    const url = prompt("–í–≤–µ–¥–∏—Ç–µ URL JSON-—Ñ–∞–π–ª–∞:", "data.json");
    if (!url) return;
    
    updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞...', 30);
    const startTime = performance.now();
    
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ HTTP: " + response.status);
      
      currentJson = await response.json();
      updateFileInfo(`URL: ${url} | –°–ø–æ—Å–æ–±: –°—Å—ã–ª–∫–∞`);
      saveToLocalStorage(currentJson);
      
      const loadTime = (performance.now() - startTime).toFixed(1);
      updateStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞ ${loadTime} –º—Å`, 100);
    } catch (err) {
      updateStatus('–û—à–∏–±–∫–∞: ' + err.message, 0);
    }
  });

  // 4. –í–≤–æ–¥ –≤—Ä—É—á–Ω—É—é
  document.getElementById('text-btn').addEventListener('click', () => {
    hideAllControls();
    textarea.style.display = 'block';
    textImportControls.style.display = 'block';
    updateStatus("–í–≤–µ–¥–∏—Ç–µ JSON –≤ –ø–æ–ª–µ –Ω–∏–∂–µ", 0);
  });

  // –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç–∞
  document.getElementById('load-text-btn').addEventListener('click', () => {
    try {
      if (!textarea.value.trim()) throw new Error("–í–≤–µ–¥–∏—Ç–µ JSON");
      currentJson = JSON.parse(textarea.value);
      updateFileInfo(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤—Ä—É—á–Ω—É—é | –°–ø–æ—Å–æ–±: –¢–µ–∫—Å—Ç`);
      updateStatus("–í–∞–ª–∏–¥–Ω—ã–π JSON", 100);
      saveToLocalStorage(currentJson);
    } catch (err) {
      updateStatus('–û—à–∏–±–∫–∞: ' + err.message, 0);
    }
  });

  // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø—Ä–æ–µ–∫—Ç–∞
  async function scanProjectForJson() {
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ —Ç–µ–∫—É—â–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ
      const response = await fetch('./?list-files');
      
      if (!response.ok) {
        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏—Å—Ç–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤, –¥–µ–ª–∞–µ–º fallback
        return await findJsonFilesFallback();
      }
      
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const links = Array.from(doc.querySelectorAll('a[href$=".json"]'));
      
      return links.map(link => {
        return {
          name: link.textContent,
          path: link.getAttribute('href')
        };
      });
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
      return await findJsonFilesFallback();
    }
  }
  
  // Fallback –º–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞ JSON —Ñ–∞–π–ª–æ–≤
  async function findJsonFilesFallback() {
    const knownPaths = [
      'data.json',
      'config.json',
      'db.json',
      'settings.json'
    ];
    
    const foundFiles = [];
    
    for (const path of knownPaths) {
      try {
        const response = await fetch(path);
        if (response.ok) {
          foundFiles.push({ name: path, path: path });
        }
      } catch (e) {}
    }
    
    if (foundFiles.length === 0) {
      throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON —Ñ–∞–π–ª—ã. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é.");
    }
    
    return foundFiles;
  }
  
  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–µ
  function displayFilesInExplorer(files) {
    fileExplorer.innerHTML = '';
    
    if (files.length === 0) {
      fileExplorer.innerHTML = '<div>JSON —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
      return;
    }
    
    files.forEach(file => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item';
      fileItem.textContent = file.name;
      fileItem.onclick = async () => {
        updateStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ ${file.name}...`, 30);
        try {
          const response = await fetch(file.path);
          if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
          
          currentJson = await response.json();
          updateFileInfo(`–§–∞–π–ª: ${file.name} | –°–ø–æ—Å–æ–±: –ü—Ä–æ–µ–∫—Ç`);
          updateStatus(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω`, 100);
          saveToLocalStorage(currentJson);
        } catch (err) {
          updateStatus('–û—à–∏–±–∫–∞: ' + err.message, 0);
        }
      };
      fileExplorer.appendChild(fileItem);
    });
  }
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
  function saveToLocalStorage(data) {
    try {
      localStorage.setItem('currentJson', JSON.stringify(data));
      localStorage.setItem('lastLoaded', new Date().toLocaleString());
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
    }
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
  function updateStatus(message, percent) {
    statusText.textContent = message;
    statusProgress.style.width = percent + '%';
    statusProgress.style.backgroundColor = percent === 100 ? '#4CAF50' : 
                                        percent > 0 ? '#2196F3' : '#ff9800';
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
  function updateFileInfo(info) {
    fileInfo.textContent = info;
    fileInfo.style.animation = 'none';
    void fileInfo.offsetWidth;
    fileInfo.style.animation = 'highlight 0.5s';
  }
  
  // –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  function hideAllControls() {
    fileExplorer.style.display = 'none';
    textarea.style.display = 'none';
    textImportControls.style.display = 'none';
  }

  // –ê–Ω–∏–º–∞—Ü–∏—è highlight
  const style = document.createElement('style');
  style.textContent = `
    @keyframes highlight {
      from { background: #aaffaa; }
      to { background: #eef; }
    }
  `;
  document.head.appendChild(style);
</script>
