<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ (4 –∏–≥—Ä–æ–∫–∞)</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background: #f0f0f0; }
    #lobby, #game { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; margin: 5px; }
    #playersList { margin: 20px 0; }
    .player { padding: 10px; background: #e9e9e9; margin: 5px; border-radius: 5px; }
    #question { font-size: 20px; margin: 20px 0; }
    .answer { padding: 10px; margin: 5px; background: #2196F3; color: white; cursor: pointer; border-radius: 5px; }
  </style>
</head>
<body>
  <div id="lobby">
    <h1>üéÆ P2P –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ (–¥–æ 4 –∏–≥—Ä–æ–∫–æ–≤)</h1>
    <button id="createBtn">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
    <div id="activeGames"></div>
  </div>

  <div id="game" style="display: none;">
    <h2>–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</h2>
    <div id="playersList"></div>
    <div id="question"></div>
    <div id="answers"></div>
    <div id="score"></div>
  </div>

  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞
    const peer = new Peer();
    const players = {};
    let isHost = false;
    let gameConnections = [];
    let currentQuestion = 0;
    const questions = [
      { question: "–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?", answers: ["–ü–∞—Ä–∏–∂", "–õ–æ–Ω–¥–æ–Ω", "–ë–µ—Ä–ª–∏–Ω", "–ú–∞–¥—Ä–∏–¥"], correct: 0 },
      { question: "2 + 2?", answers: ["3", "4", "5", "6"], correct: 1 }
    ];

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const lobby = document.getElementById("lobby");
    const gameDiv = document.getElementById("game");
    const playersList = document.getElementById("playersList");
    const activeGames = document.getElementById("activeGames");
    const questionDiv = document.getElementById("question");
    const answersDiv = document.getElementById("answers");
    const scoreDiv = document.getElementById("score");

    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã (–•–æ—Å—Ç)
    document.getElementById("createBtn").addEventListener("click", () => {
      isHost = true;
      lobby.style.display = "none";
      gameDiv.style.display = "block";
      players[peer.id] = { id: peer.id, name: "–ò–≥—Ä–æ–∫ 1", score: 0 };
      updatePlayersList();

      // –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
      peer.on("connection", (conn) => {
        if (Object.keys(players).length >= 4) {
          conn.send({ type: "error", message: "–õ–æ–±–±–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ" });
          return;
        }

        gameConnections.push(conn);
        conn.on("data", (data) => handlePlayerData(conn, data));
        conn.on("open", () => {
          const playerId = conn.peer;
          players[playerId] = { id: playerId, name: `–ò–≥—Ä–æ–∫ ${Object.keys(players).length + 1}`, score: 0 };
          broadcast({ type: "players", players });
          if (isHost && Object.keys(players).length === 2) startGame(); // –°—Ç–∞—Ä—Ç –ø—Ä–∏ 2+ –∏–≥—Ä–æ–∫–∞—Ö
        });
      });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    function handlePlayerData(conn, data) {
      if (data.type === "answer" && isHost) {
        const isCorrect = (data.answer === questions[currentQuestion].correct);
        if (isCorrect) players[conn.peer].score += 10;
        broadcast({ type: "score", players });
      }
    }

    // –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º
    function broadcast(message) {
      gameConnections.forEach(conn => conn.send(message));
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
    function updatePlayersList() {
      playersList.innerHTML = Object.values(players).map(player => 
        `<div class="player">${player.name} (${player.score} pts)</div>`
      ).join("");
    }

    // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
    function startGame() {
      loadQuestion(0);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
    function loadQuestion(index) {
      currentQuestion = index;
      const q = questions[index];
      questionDiv.textContent = q.question;
      answersDiv.innerHTML = q.answers.map((answer, i) => 
        `<div class="answer" data-index="${i}">${answer}</div>`
      ).join("");

      document.querySelectorAll(".answer").forEach(el => {
        el.addEventListener("click", () => {
          if (!isHost) {
            gameConnections[0].send({ type: "answer", answer: parseInt(el.dataset.index) });
          }
        });
      });
    }

    // –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ª–æ–±–±–∏ (–¥–ª—è –¥–µ–º–æ)
    peer.on("open", (id) => {
      // –•–æ—Å—Ç –ø—É–±–ª–∏–∫—É–µ—Ç –∏–≥—Ä—É –≤ "–ª–æ–±–±–∏" (–¥–ª—è –¥–µ–º–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –∫–Ω–æ–ø–∫–∞)
      if (isHost) {
        activeGames.innerHTML = `<div class="game">
          <p>–ò–≥—Ä–∞ –æ—Ç ${id}</p>
          <button onclick="connectToGame('${id}')">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>`;
      }
    });

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏)
    window.connectToGame = (hostId) => {
      const conn = peer.connect(hostId);
      lobby.style.display = "none";
      gameDiv.style.display = "block";

      conn.on("data", (data) => {
        if (data.type === "players") {
          Object.assign(players, data.players);
          updatePlayersList();
        } else if (data.type === "question") {
          loadQuestion(data.index);
        } else if (data.type === "score") {
          Object.assign(players, data.players);
          updatePlayersList();
        }
      });

      gameConnections.push(conn);
    };
  </script>
</body>
</html>
